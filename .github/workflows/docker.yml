name: Image Sync with Architecture Validation

on:
  workflow_dispatch:

jobs:
  image-sync:
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DEST_REPO: ${{ secrets.DOCKERHUB_USERNAME }}

    steps:
      - name: Setup build environment
        # è®¾ç½® buildx ç¯å¢ƒï¼Œæ”¯æŒå¤šå¹³å°æ„å»º
        uses: docker/setup-buildx-action@v3

      - name: Install system dependencies
        # æ›´æ–° apt æºå¹¶å®‰è£… skopeoï¼ˆç”¨äºè·å–é•œåƒä¿¡æ¯ï¼‰
        run: |
          sudo apt-get update && sudo apt-get install -y skopeo

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USER }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Execute image synchronization
        # æ‰§è¡Œé•œåƒåŒæ­¥åŠæ¶æ„éªŒè¯è„šæœ¬
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          # å®šä¹‰åŒæ­¥é…ç½®ï¼Œkey ä¸ºæºé•œåƒï¼Œvalue ä¸ºç›®æ ‡é•œåƒåç§°
          declare -A SYNC_MAP=(
            ['nginx']='nginx-m'
            ['redis:7.0']='redis:7'
            ['chipsman/uptime-kuma']='uptime-kuma-back'
          )

          # å®šä¹‰æ—¥å¿—æ‰“å°æ—¶ä½¿ç”¨çš„é¢œè‰²
          readonly COLOR_RESET="\033[0m"
          readonly COLOR_SRC="\033[38;5;111m"
          readonly COLOR_DST="\033[38;5;213m"
          readonly COLOR_HL="\033[38;5;223m"
          readonly COLOR_OK="\033[38;5;121m"
          readonly COLOR_WARN="\033[38;5;223m"
          readonly COLOR_ERR="\033[38;5;203m"
          readonly COLOR_BOX="\033[38;5;59m"

          # å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—æ‰“å°å‡½æ•°ï¼Œæ ¹æ®æ—¥å¿—çº§åˆ«è¾“å‡ºä¸åŒé¢œè‰²ä¿¡æ¯
          log() {
            local level=$1 message=$2
            local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            case $level in
              "INFO") echo -e "[$timestamp] \033[34mâ„¹${COLOR_RESET} ${message}" ;;
              "WARN") echo -e "[$timestamp] \033[33mâš ${COLOR_RESET} ${message}" >&2 ;;
              "ERROR") echo -e "[$timestamp] \033[31mâœ–${COLOR_RESET} ${message}" >&2 ;;
            esac
          }

          # æ ¼å¼åŒ–å¹¶æ‰“å°æºé•œåƒä¸ç›®æ ‡é•œåƒçš„æ¶æ„ä¿¡æ¯è¡¨æ ¼
          format_arch_table() {
            local src=$1 dst=$2 src_arch=$3 dst_arch=$4
            term_width=$(tput cols 2>/dev/null || echo 120)
            [[ $term_width -lt 90 ]] && term_width=90
            col_width=$(((term_width-4)/2))

            # å†…éƒ¨å‡½æ•°ï¼šå°†ä»¥é€—å·åˆ†éš”çš„æ¶æ„ä¿¡æ¯æ‹†åˆ†æˆå¤šè¡Œ
            split_columns() {
              echo "$1" | sed 's/,/\n/g' | fold -sw $((col_width-6)) | sed 's/^/  /' | paste -sd'\n' -
            }

            mapfile src_lines < <(split_columns "$src_arch")
            mapfile dst_lines < <(split_columns "$dst_arch")
            max_lines=$(( ${#src_lines[@]} > ${#dst_lines[@]} ? ${#src_lines[@]} : ${#dst_lines[@]} ))

            # æ‰“å°è¡¨æ ¼å¤´éƒ¨
            echo -e "\n${COLOR_BOX}â”Œ$(printf 'â”€%.0s' $(seq 1 $col_width))â”¬$(printf 'â”€%.0s' $(seq 1 $col_width))â”${COLOR_RESET}"
            printf "${COLOR_BOX}â”‚%-${col_width}s${COLOR_BOX}â”‚%-${col_width}sâ”‚\n" \
                   "  ${COLOR_SRC}Source: ${src}${COLOR_RESET}" \
                   "  ${COLOR_DST}Target: ${dst}${COLOR_RESET}"
            echo -e "${COLOR_BOX}â”œ$(printf 'â”€%.0s' $(seq 1 $col_width))â”¼$(printf 'â”€%.0s' $(seq 1 $col_width))â”¤${COLOR_RESET}"

            # æ‰“å°è¡¨æ ¼ä½“ï¼Œé€è¡Œæ˜¾ç¤ºæ¶æ„ä¿¡æ¯
            for ((i=0; i < max_lines; i++)); do
              src_line="${src_lines[i]:-}"
              dst_line="${dst_lines[i]:-}"
              printf "${COLOR_BOX}â”‚${COLOR_RESET}%-$((col_width))s${COLOR_BOX}â”‚${COLOR_RESET}%-$((col_width))s${COLOR_BOX}â”‚\n" \
                     "  ${COLOR_SRC}${src_line}${COLOR_RESET}" \
                     "  ${COLOR_DST}${dst_line}${COLOR_RESET}"
            done

            echo -e "${COLOR_BOX}â””$(printf 'â”€%.0s' $(seq 1 $col_width))â”´$(printf 'â”€%.0s' $(seq 1 $col_width))â”˜${COLOR_RESET}\n"
          }

          # è·å–æŒ‡å®šé•œåƒçš„æ¶æ„ä¿¡æ¯ï¼Œä½¿ç”¨ docker buildx imagetools inspect å‘½ä»¤
          get_architecture() {
            local image=$1
            docker buildx imagetools inspect "$image" --format '
            {{- range $manifest := .Manifest.Manifests -}}
              {{- $platform := $manifest.Platform -}}
              {{- printf "%s/%s" $platform.os $platform.architecture }}
              {{- if $platform.variant }}@{{ $platform.variant }}{{end -}}
              {{- if not (eq $manifest.Index 0) }}, {{end -}}
            {{- end -}}' 2>/dev/null || echo "unknown"
          }

          # æ£€æŸ¥é•œåƒçš„ digest å€¼ï¼Œç”¨äºå¯¹æ¯”é•œåƒå†…å®¹
          check_digest() {
            skopeo inspect "docker://$1" --format '{{.Digest}}' 2>/dev/null || echo "none"
          }

          # æ ¹æ®é•œåƒç±»å‹ï¼ˆå¤šæ¶æ„æˆ–å•æ¶æ„ï¼‰æ‰§è¡Œä¸åŒçš„åŒæ­¥æ–¹å¼
          sync_image() {
            local src=$1 dst=$2
            if docker buildx imagetools inspect "$src" &>/dev/null; then
              log "INFO" "${COLOR_OK}Syncing multi-arch image...${COLOR_RESET}"
              # å¯¹äºå¤šæ¶æ„é•œåƒï¼Œåˆ©ç”¨ buildx åˆ›å»ºå¤šå¹³å°é•œåƒ
              docker buildx imagetools create -t "$dst" "$src"
            else
              log "INFO" "${COLOR_OK}Pushing single-arch image...${COLOR_RESET}"
              # é’ˆå¯¹å•æ¶æ„é•œåƒï¼Œå…ˆæ‹‰å–ï¼Œå†æ‰“æ ‡ç­¾ï¼Œæœ€åæ¨é€
              docker pull -q "$src" && docker tag "$src" "$dst" && docker push -q "$dst"
            fi
          }

          # éå†æ¯ä¸ªåŒæ­¥é…ç½®é¡¹ï¼Œæ‰§è¡ŒåŒæ­¥æ“ä½œ
          for source_ref in "${!SYNC_MAP[@]}"; do
            echo "::group::ğŸ”„ Processing ${source_ref}"
            # æ„é€ æºé•œåƒå’Œç›®æ ‡é•œåƒçš„å®Œæ•´åœ°å€
            src_image="docker.io/${source_ref}"
            dst_image="docker.io/${DEST_REPO}/${SYNC_MAP[$source_ref]}"

            log "INFO" "Starting sync: ${COLOR_SRC}${src_image}${COLOR_RESET} â†’ ${COLOR_DST}${dst_image}${COLOR_RESET}"
            
            # è·å–å¹¶æ˜¾ç¤ºæºé•œåƒä¸ç›®æ ‡é•œåƒçš„æ¶æ„ä¿¡æ¯
            src_arch=$(get_architecture "$src_image")
            dst_arch=$(get_architecture "$dst_image" || echo "<new-image>")
            format_arch_table "$src_image" "$dst_image" "${src_arch}" "${dst_arch}"

            # è·å–é•œåƒçš„ digest å€¼ï¼Œç”¨äºç‰ˆæœ¬åŒ¹é…åˆ¤æ–­
            src_digest=$(check_digest "$src_image")
            dst_digest=$(check_digest "$dst_image")
            if [[ "$src_digest" == "$dst_digest" ]]; then
              log "INFO" "${COLOR_OK}Digests match:${COLOR_RESET} ${src_digest:0:12}...${src_digest: -6}"
              log "INFO" "${COLOR_OK}Target is up-to-date, skipping sync${COLOR_RESET}"
            else
              log "INFO" "${COLOR_WARN}Digests differ:${COLOR_RESET}"
              log "INFO" "Source: ${src_digest:0:12}...${src_digest: -6}"
              log "INFO" "Target: ${dst_digest:0:12}...${dst_digest: -6}"
              # æ‰§è¡Œå®é™…é•œåƒåŒæ­¥æ“ä½œ
              sync_image "$src_image" "$dst_image"
            fi
            
            echo "::endgroup::"
            echo -e "\n"
          done
