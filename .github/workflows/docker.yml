name: Image Arch Check and Sync Enhanced

on:
  workflow_dispatch:

jobs:
  check-and-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        id: buildx
        with:
          driver: docker-container
          driver-opts: |
            image=moby/buildkit:master
            network=host
          buildkitd-config-inline: |
            [registry."docker.io"]
              mirrors = ["dockerpull.cn"]
            [worker.oci]
              max-parallelism = 6

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Process images
        run: |
          set -eo pipefail
          DEST_REPO="${{ secrets.DOCKERHUB_USERNAME }}"
          SYNC_ENTRIES="nginx=nginx-m,redis:7.0=redis:7,chipsman/uptime-kuma=uptime-kuma-back,chipsman/one-hub=one-hub"
          echo "å®Œæ•´åŒæ­¥é…ç½®ï¼š"
          echo "SYNC_ENTRIES: ${SYNC_ENTRIES}"
          echo "DEST_REPO: ${DEST_REPO}"
          # ============== é…ç½®è§£æ ==============
          declare -A SYNC_MAP
          IFS=',' read -ra entries <<< "$SYNC_ENTRIES"
          for entry in "${entries[@]}"; do
            IFS='=' read -r key value <<< "$entry"
            [[ -z "$key" || -z "$value" ]] && { echo "::error::æ— æ•ˆæ¡ç›®: $entry"; exit 1; }
            SYNC_MAP["$key"]="$value"
          done
          IMAGES=("${!SYNC_MAP[@]}")

          # ============== ä¸»å¤„ç†å¾ªç¯ ==============
          for source_image in "${IMAGES[@]}"; do
            echo "::group::ğŸ” å¤„ç† $source_image"
            
            # ä¿®æ”¹è·¯å¾„æ„é€ éƒ¨åˆ†å¦‚ä¸‹ï¼š
            # ======= è·¯å¾„æ„é€  =======
            if [[ "$source_image" == *":"* ]]; then
            source_name="${source_image%:*}"
            source_tag="${source_image#*:}"
            else
            source_name="$source_image"
            source_tag="latest"
            fi
            # ä¿®å¤library/å‰ç¼€é€»è¾‘ï¼ˆä»…é€‚ç”¨äºå®˜æ–¹é•œåƒï¼‰
            if [[ "$source_name" == *"/"* ]]; then
            full_source="dockerpull.cn/${source_name}:${source_tag}"
            else
            full_source="dockerpull.cn/library/${source_name}:${source_tag}"
            fi

            # ======= ç›®æ ‡å¤„ç† =======
            target_ref="${SYNC_MAP[$source_image]}"
            [[ -z "$target_ref" ]] && { echo "::error::ç›®æ ‡æœªå®šä¹‰"; exit 1; }
            
            if [[ "$target_ref" == *":"* ]]; then
              target_name="${target_ref%:*}"
              target_tag="${target_ref#*:}"
            else
              target_name="$target_ref"
              target_tag="$source_tag"  # ç»§æ‰¿æºæ ‡ç­¾
            fi
            full_target="dockerpull.cn/${DEST_REPO}/${target_name}:${target_tag}"

            # ====== æºé•œåƒéªŒè¯ ======
            echo "ğŸ” éªŒè¯: ${full_source} â†’ ${full_target}"
            if ! skopeo inspect "docker://${full_source}" >/dev/null 2>&1; then
              echo "::error::æºé•œåƒä¸å¯è®¿é—®"; exit 1
            fi

            # ====== ç‰ˆæœ¬å¯¹æ¯” ======
            need_sync=true
            target_exists=false
            if skopeo inspect "docker://${full_target}" &>/dev/null; then
              target_exists=true
              source_digest=$(skopeo inspect --format '{{.Digest}}' "docker://${full_source}")
              target_digest=$(skopeo inspect --format '{{.Digest}}' "docker://${full_target}")
              
              if [[ "$source_digest" == "$target_digest" ]]; then
                echo "ğŸŸ¢ å½“å‰å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
                need_sync=false
              else
                echo "ğŸŸ¡ å‘ç°æ›´æ–°: ${source_digest:0:12}... â†’ ${target_digest:0:12}..."
              fi
            else
              echo "ğŸŸ¡ ç›®æ ‡é•œåƒä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»º"
            fi

            # ====== è·³è¿‡æ£€æŸ¥ ======
            if [[ "$need_sync" == "false" ]]; then
              echo "â­ï¸ è·³è¿‡åŒæ­¥"
              echo "::endgroup::"
              continue
            fi

            # ====== æ¶æ„æ£€æµ‹ ======
            echo "ğŸ”„ æ£€æµ‹æ¶æ„ä¿¡æ¯..."
            raw_manifest=$(skopeo inspect --raw "docker://${full_source}")
            is_multiarch=false

            # å¤šæ¶æ„åˆ¤å®š
            if echo "$raw_manifest" | jq -e '
              (.manifests != null) and
              (.manifests | length > 0) and
              (.mediaType | test("manifest.list|vnd.docker.distribution.manifest.list"))
            ' >/dev/null; then
              is_multiarch=true
              src_arch=$(echo "$raw_manifest" | jq -r '
                [.manifests[] | 
                 .platform as $p |
                 select($p.os and $p.architecture and $p.os != "unknown") |
                 "\($p.os)/\($p.architecture)\($p.variant? // "" | if . != "" then "/"+. else "" end)"
                ] | unique | join(", ")
              ')
              echo "âš™ï¸ å¤šæ¶æ„æ”¯æŒ: [${src_arch}]"
            else
              # å•æ¶æ„å¤„ç†
              inspect_info=$(skopeo inspect "docker://${full_source}")
              os=$(jq -r '.Os // "unknown"' <<< "$inspect_info")
              arch=$(jq -r '.Architecture // "unknown"' <<< "$inspect_info")
              variant=$(jq -r '.Variant? // ""' <<< "$inspect_info")
              if [[ "$os" != "unknown" && "$arch" != "unknown" ]]; then
                src_arch="${os}/${arch}${variant:+/$variant}"
                echo "âš™ï¸ å•æ¶æ„: ${src_arch}"
              else
                echo "::warning::æ— æ•ˆæ¶æ„ â†’ OS: ${os}, æ¶æ„: ${arch}"
                src_arch="<æ— æ•ˆå¹³å°>"
              fi
            fi

            # ====== æ¶æ„å˜æ›´æŠ¥å‘Š ======
            if [[ "$target_exists" == "true" ]]; then
              echo "ğŸ“Š æ¶æ„å˜åŒ–æŠ¥å‘Š:"
              echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
              echo "â”‚          æºæ¶æ„               â”‚          ç›®æ ‡æ¶æ„            â”‚"
              
              # è·å–ç›®æ ‡æ¶æ„
              target_manifest=$(skopeo inspect --raw "docker://${full_target}" 2>/dev/null || true)
              if [[ -n "$target_manifest" ]]; then
                tgt_arch=$(echo "$target_manifest" | jq -r '
                  if .manifests then
                    [.manifests[].platform | 
                     "\(.os)/\(.architecture)\(.variant? // "" | if . != "" then "/"+. else "" end)"
                    ] | unique | join(", ")
                  else
                    "\(.os)/\(.architecture)\(.variant? // "")"
                  end
                ' 2>/dev/null || echo "<è§£æå¤±è´¥>")
              else
                tgt_arch="<æ— æ³•è·å–>"
              fi
              
              # å½©è‰²è¾“å‡ºå¯¹é½
              printf "â”‚\033[32m%-30s\033[0mâ”‚\033[31m%-30s\033[0mâ”‚\n" " ${src_arch}" " ${tgt_arch}"
              echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
            fi

            # ====== æ‰§è¡ŒåŒæ­¥ ======
            if [[ "$is_multiarch" == "true" ]]; then
            echo "ğŸš¢ åŒæ­¥å¤šæ¶æ„é•œåƒ..."
            docker buildx imagetools create -t "$full_target" "$full_source" || {
                echo "::error::åŒæ­¥å¤±è´¥"; exit 1
            }
            else
            echo "âš¡ ä½¿ç”¨SkopeoåŒæ­¥å•æ¶æ„é•œåƒ..."
            skopeo copy --all \
                --src-creds="${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_TOKEN }}" \
                --dest-creds="${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_TOKEN }}" \
                "docker://${full_source}" "docker://${full_target}" || {
                echo "::error::åŒæ­¥å¤±è´¥"; exit 1
                }
            fi

            echo "âœ… åŒæ­¥å®Œæˆ"
            echo "::endgroup::"
          done
