name: Image Sync with Architecture Validation

on:
  workflow_dispatch:

jobs:
  image-sync:
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DEST_REPO: ${{ secrets.DOCKERHUB_USERNAME }}

    steps:
      - name: Setup build environment
        uses: docker/setup-buildx-action@v3

      - name: Install system dependencies
        run: |
          sudo apt-get update && sudo apt-get install -y skopeo

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USER }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: Execute image synchronization
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          # åŒæ­¥é…ç½®
          declare -A SYNC_MAP=(
            ['nginx']='nginx-m'
            ['redis:7.0']='redis:7'
            ['chipsman/uptime-kuma']='uptime-kuma-back'
          )

          # æ—¥å¿—é¢œè‰²å®šä¹‰
          readonly COLOR_RESET="\033[0m"
          readonly COLOR_SRC="\033[38;5;111m"
          readonly COLOR_DST="\033[38;5;213m"
          readonly COLOR_HL="\033[38;5;223m"
          readonly COLOR_OK="\033[38;5;121m"
          readonly COLOR_WARN="\033[38;5;223m"
          readonly COLOR_ERR="\033[38;5;203m"

          # å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—å‡½æ•°
          log() {
            local level=$1
            local message=$2
            local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            local color
            case $level in
              "INFO") color="$COLOR_OK" ;;
              "WARN") color="$COLOR_WARN" ;;
              "ERROR") color="$COLOR_ERR" ;;
            esac
            echo -e "${COLOR_HL}[${timestamp}] ${color}${level}:${COLOR_RESET} ${message}"
          }

          format_arch_report() {
            local src=$1
            local dst=$2
            local src_arch=$3
            local dst_arch=$4
            
            echo -e "\n\033[38;5;117mâ– â– æ¶æ„å¯¹æ¯” ${COLOR_RESET}"
            printf "%-65s %65s\n" \
              "${COLOR_SRC}âœ Source: ${src}${COLOR_RESET}" \
              "${COLOR_DST}âœ Target: ${dst}${COLOR_RESET}"
            echo -e "${COLOR_HL}â”$(printf 'â”%.0s' {1..38})â”³$(printf 'â”%.0s' {1..38})â”“"
            printf "â”ƒ%-38s â”ƒ %-38sâ”ƒ\n" \
              "  ${COLOR_SRC}${src_arch}${COLOR_RESET}" \
              "  ${COLOR_DST}${dst_arch}${COLOR_RESET}"
            echo -e "â”—$(printf 'â”%.0s' {1..38})â”»$(printf 'â”%.0s' {1..38})â”›${COLOR_RESET}"
          }

          get_architecture() {
            local image=$1
            local result=""
            
            if raw_manifest=$(skopeo inspect --raw "docker://${image}" 2>/dev/null); then
              if jq -e '.manifests != null' <<< "$raw_manifest" &>/dev/null; then
                result=$(jq -r '.manifests[].platform | "\(.os)/\(.architecture)"' <<< "$raw_manifest" | sort -u | tr '\n' ',')
                result="${result%,}"
              else
                local os=$(jq -r '.Architecture' <<< "$(skopeo inspect "docker://${image}")")
                local arch=$(jq -r '.Os' <<< "$(skopeo inspect "docker://${image}")")
                result="${arch}/${os}"
              fi
            fi
            [[ -z "$result" ]] && result="unknown"
            echo "$result"
          }

          sync_image() {
            local src=$1
            local dst=$2

            if docker buildx imagetools inspect "$src" | grep -q "Manifest list"; then
              log "INFO" "ğŸ” ä½¿ç”¨å¤šæ¶æ„åŒæ­¥æ¨¡å¼"
              docker buildx imagetools create -t "$dst" "$src"
            else
              log "INFO" "â¬‡ï¸ æ‹‰å–å•æ¶æ„é•œåƒ"
              docker pull --quiet "$src"
              docker tag "$src" "$dst"
              docker push --quiet "$dst"
            fi
          }

          for source_ref in "${!SYNC_MAP[@]}"; do
            echo "::group::ğŸ”„ Processing ${source_ref}"
            
            src_image="docker.io/${source_ref}"
            dst_image="docker.io/${DEST_REPO}/${SYNC_MAP[$source_ref]}"
            
            log "INFO" "ğŸ›« å¼€å§‹åŒæ­¥æµç¨‹"
            log "INFO" "æºé•œåƒ: ${COLOR_SRC}${src_image}${COLOR_RESET}"
            log "INFO" "ç›®æ ‡é•œåƒ: ${COLOR_DST}${dst_image}${COLOR_RESET}"

            # æ¶æ„åˆ†æ
            log "INFO" "ğŸ” æ‰§è¡Œæ¶æ„æ£€æŸ¥..."
            src_arch=$(get_architecture "$src_image")
            dst_arch=$(get_architecture "$dst_image" 2>/dev/null || echo "<æ–°é•œåƒ>")
            
            format_arch_report "$src_image" "$dst_image" "$src_arch" "$dst_arch"

            # æ‘˜è¦æ£€æŸ¥
            src_digest=$(skopeo inspect --format '{{.Digest}}' "docker://${src_image}")
            dst_digest=$(skopeo inspect --format '{{.Digest}}' "docker://${dst_image}" 2>/dev/null || echo "empty")

            log "INFO" "ğŸ”– æ‘˜è¦æ¯”å¯¹ï¼š"
            echo -e "${COLOR_SRC}  ${src_digest:0:12}...${src_digest: -4}${COLOR_RESET}"
            echo -e "${COLOR_DST}  ${dst_digest:0:12}...${dst_digest: -4}${COLOR_RESET}"

            if [[ "$src_digest" == "$dst_digest" ]]; then
              log "INFO" "âœ… æ— éœ€åŒæ­¥ï¼šç›®æ ‡é•œåƒå·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
            else
              log "INFO" "ğŸ”„ å‘ç°æ›´æ–°ï¼šå¼€å§‹åŒæ­¥é•œåƒ"
              sync_image "$src_image" "$dst_image"
              log "INFO" "ğŸ‰ åŒæ­¥æ“ä½œæˆåŠŸå®Œæˆ"
            fi

            echo -e "${COLOR_HL}â”${COLOR_RESET}"
            echo "::endgroup::"
          done
