name: Image Arch Check and Sync Enhanced

on:
  workflow_dispatch:

jobs:
  check-and-sync:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Process images
        run: |
          set -eo pipefail
          DEST_REPO="${{ secrets.DOCKERHUB_USERNAME }}"
          SYNC_ENTRIES="nginx=nginx-m,redis:7.0=redis:7,chipsman/uptime-kuma=uptime-kuma-back,chipsman/one-hub=one-hub"

          # é…ç½®è§£æ
          declare -A SYNC_MAP
          IFS=',' read -ra entries <<< "$SYNC_ENTRIES"
          for entry in "${entries[@]}"; do
            IFS='=' read -r key value <<< "$entry"
            [[ -z "$key" || -z "$value" ]] && { echo "::error::Invalid entry: $entry"; exit 1; }
            SYNC_MAP["$key"]="$value"
          done
          IMAGES=("${!SYNC_MAP[@]}")

          for source_image in "${IMAGES[@]}"; do
            echo "::group::ğŸ” Processing $source_image"
            
            # æºè·¯å¾„æ„é€ 
            if [[ "$source_image" == *":"* ]]; then
              source_name="${source_image%:*}"
              source_tag="${source_image#*:}"
            else
              source_name="$source_image"
              source_tag="latest"
            fi
            full_source="docker.io/$([[ "$source_name" != *"/"* ]] && echo "library/")${source_name}:$source_tag"

            # ç›®æ ‡è·¯å¾„æ„é€ 
            target_ref="${SYNC_MAP[$source_image]}"
            [[ -z "$target_ref" ]] && { echo "::error::Missing target mapping"; exit 1; }
            
            if [[ "$target_ref" == *":"* ]]; then
              target_name="${target_ref%:*}"
              target_tag="${target_ref#*:}"
            else
              target_name="$target_ref"
              target_tag="$source_tag"  # ç»§æ‰¿æºæ ‡ç­¾
            fi
            full_target="docker.io/${DEST_REPO}/${target_name}:${target_tag}"
            
            # æ•°æ®æ ¡éªŒ
            echo "[éªŒè¯] æº: $full_source"
            echo "     ç›®æ ‡: $full_target"
            if ! skopeo inspect "docker://${full_source}" >/dev/null 2>&1; then
              echo "::error::æºé•œåƒä¸å¯è®¿é—®"; exit 1
            fi

            # ç‰ˆæœ¬æ¯”å¯¹
            need_sync=true
            if skopeo inspect "docker://${full_target}" &>/dev/null; then
              source_digest=$(skopeo inspect --format '{{.Digest}}' "docker://${full_source}")
              target_digest=$(skopeo inspect --format '{{.Digest}}' "docker://${full_target}")
              if [[ "$source_digest" == "$target_digest" ]]; then
                echo "ğŸŸ¢ å½“å‰ç‰ˆæœ¬å·²æ˜¯æœ€æ–° (Digest: ${source_digest})"
                need_sync=false
              else
                echo "ğŸŸ¡ æ£€æµ‹åˆ°æ›´æ–°: ${source_digest:0:12}.. â†’ ${target_digest:0:12}.."
              fi
            else
              echo "ğŸŸ¡ ç›®æ ‡é•œåƒä¸å­˜åœ¨ï¼Œéœ€è¦æ–°å»º"
            fi

            if [[ "$need_sync" == "false" ]]; then
              echo "âœ… è·³è¿‡åŒæ­¥"
              echo "::endgroup::"
              continue
            fi

            # æ¶æ„å¯¹æ¯”æŠ¥å‘Š
            echo "ğŸ” æ¶æ„å·®å¼‚åˆ†æï¼š"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            source_arch=$(skopeo inspect --raw "docker://${full_source}" | jq -r '
              if .manifests then
                [.manifests[].platform | "\(.os)/\(.architecture)\(.variant?//""|if .!="" then "/"+. else "" end)"] | join(", ")
              else
                "\(.Os)/\(.Architecture)\(.Variant?//""|if .!="" then "/"+. else "" end)"
              end' 2>/dev/null || echo "<æ— æ³•è·å–>")
            
            target_arch=$(skopeo inspect "docker://${full_target}" --raw 2>/dev/null | jq -r '
              if .manifests then
                [.manifests[].platform | "\(.os)/\(.architecture)\(.variant?//""|if .!="" then "/"+. else "" end)"] | join(", ")
              else
                "\(.Os)/\(.Architecture)\(.Variant?//""|if .!="" then "/"+. else "" end)"
              end' 2>/dev/null || echo "<æ— å†å²ç‰ˆæœ¬>")
            
            printf "%-28s | %-28s\n" "æºæ¶æ„" "å½“å‰æ¶æ„"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            printf "\033[32m%-28s\033[0m | \033[31m%-28s\033[0m\n" "$source_arch" "$target_arch"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”·â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

            # æ¶æ„æ£€æµ‹
            echo "ğŸ”„ æ£€æµ‹æºé•œåƒæ¶æ„..."
            raw_manifest=$(skopeo inspect --raw "docker://${full_source}" | tee /tmp/manifest.txt)
            is_multiarch=false

            if echo "$raw_manifest" | jq -e '
              .manifests and 
              (.manifests | length > 0) and 
              (.mediaType | test("manifest.list|vnd.docker.distribution.manifest.list"))
            ' >/dev/null; then
              is_multiarch=true
              arch_list=$(echo "$raw_manifest" | jq -r '
                [.manifests[].platform | 
                 select(.os and .architecture and .os != "unknown") |
                 "\(.os)/\(.architecture)\(.variant?//""|if .!="" then "/"+. else "" end)"
                ] | unique | join(", ")')
              echo "âš™ï¸ å¤šæ¶æ„æ”¯æŒ: ${arch_list}"
            else
              inspect_data=$(skopeo inspect "docker://${full_source}")
              os=$(echo "$inspect_data" | jq -r '.Os')
              arch=$(echo "$inspect_data" | jq -r '.Architecture')
              variant=$(echo "$inspect_data" | jq -r '.Variant? // ""')
              [[ "$os" != "unknown" && "$arch" != "unknown" ]] && \
                echo "âš™ï¸ å•æ¶æ„: ${os}/${arch}${variant:+/$variant}" || \
                echo "::warning::æ— æ•ˆæ¶æ„ä¿¡æ¯ os:$os/arch:$arch"
            fi

            # åŒæ­¥æ‰§è¡Œ
            if [[ "$is_multiarch" == "true" ]]; then
              echo "ğŸš€ å¼€å§‹å¤šæ¶æ„åŒæ­¥..."
              docker buildx imagetools create -t "$full_target" "$full_source" || {
                echo "::error::é•œåƒåŒæ­¥å¤±è´¥"; exit 1
              }
            else
              echo "âš¡ æ‰§è¡Œå•æ¶æ„åŒæ­¥..."
              docker pull --quiet "$full_source"
              docker tag "$full_source" "$full_target"
              docker push --quiet "$full_target" || {
                echo "::error::é•œåƒæ¨é€å¤±è´¥"; exit 1
              }
            fi
            
            echo "âœ… åŒæ­¥å®Œæˆ â†’ $(date +"%Y-%m-%d %T")"
            echo "::endgroup::"
          done
