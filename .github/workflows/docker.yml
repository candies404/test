name: Docker é•œåƒåŒæ­¥

on:
  workflow_dispatch:
    inputs:
      sync_mappings:
        description: 'é•œåƒåŒæ­¥æ˜ å°„ï¼ˆæ ¼å¼ï¼šæºé•œåƒ=ç›®æ ‡é•œåƒï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: false

jobs:
  image-sync:
    name: é•œåƒåŒæ­¥
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DEST_REPO: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKER_SYNC_MAPPINGS: ${{ vars.DOCKER_SYNC_MAPPINGS }}
      BUILDKIT_PROGRESS: plain

    steps:
      - name: éªŒè¯é•œåƒåŒæ­¥æ ¼å¼
        id: validate-mappings
        run: |
          # ä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨è¾“å…¥
          if [ -n "${{ github.event.inputs.sync_mappings }}" ]; then
            echo "ä½¿ç”¨æ‰‹åŠ¨è¾“å…¥çš„åŒæ­¥æ˜ å°„"
            PROCESSED_MAPPINGS="${{ github.event.inputs.sync_mappings }}"
          else
            echo "ä½¿ç”¨ç¯å¢ƒå˜é‡ä¸­çš„åŒæ­¥æ˜ å°„"
            PROCESSED_MAPPINGS="$DOCKER_SYNC_MAPPINGS"
          fi

          # æ¸…ç†ç‰¹æ®Šå­—ç¬¦å¹¶æ ¡éªŒæ ¼å¼
          CLEAN_MAPPINGS=$(echo "$PROCESSED_MAPPINGS" | tr -d '\n' | tr -s ' ' | sed -e 's/ //g' -e 's/,+/,/g')
          if [ -z "$CLEAN_MAPPINGS" ]; then
            echo "::error::æœªé…ç½®åŒæ­¥æ˜ å°„"
            exit 1
          fi

          if ! echo "$CLEAN_MAPPINGS" | grep -qE '^([a-zA-Z0-9\._/-]+=[a-zA-Z0-9\._/-]+)(,[a-zA-Z0-9\._/-]+=[a-zA-Z0-9\._/-]+)*$'; then
            echo "::error::æ— æ•ˆçš„æ˜ å°„æ ¼å¼"
            exit 1
          fi

          echo "SYNC_MAPPINGS=${CLEAN_MAPPINGS}" >> $GITHUB_ENV

      - name: è®¾ç½®å¤šæ¶æ„æ„å»ºç¯å¢ƒ
        uses: docker/setup-buildx-action@v3
        with:
          install: true
          driver-opts: network=host

      - name: å®‰è£… skopeo
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y skopeo
          echo "skopeo $(skopeo --version | awk '{print $3}') å·²å®‰è£…"

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USER }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: æ‰§è¡Œé•œåƒåŒæ­¥
        id: sync
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          # é¢œè‰²å®šä¹‰
          readonly COLOR_RESET="\033[0m"
          readonly COLOR_SRC="\033[1;34m"
          readonly COLOR_DST="\033[1;36m"
          readonly COLOR_OK="\033[1;32m"
          readonly COLOR_ERROR="\033[1;31m"

          # åˆå§‹åŒ–ç»“æœç»Ÿè®¡
          declare -i success_count=0 skipped_count=0 failed_count=0
          declare -a success_list=() skipped_list=() failed_list=()

          # åŠ è½½åŒæ­¥æ˜ å°„
          declare -A SYNC_MAP=()
          IFS=',' read -ra PAIRS <<< "$SYNC_MAPPINGS"
          for pair in "${PAIRS[@]}"; do
            IFS='=' read -r src dst <<< "$pair"
            SYNC_MAP["$src"]="$dst"
          done

          # é•œåƒè§„èŒƒåŒ–å‡½æ•°
          normalize_image() {
            local raw_ref=$1 context=$2
            local registry namespace image_tag

            # åˆ†å‰²æ ‡ç­¾éƒ¨åˆ†
            if [[ "$raw_ref" == *":"* ]]; then
              image_tag="${raw_ref##*:}"
              raw_ref="${raw_ref%:*}"
            else
              image_tag="latest"
            fi

            # å¤„ç†æ³¨å†Œè¡¨è·¯å¾„
            if [[ "$raw_ref" == *"/"* ]]; then
              IFS='/' read -ra parts <<< "$raw_ref"
              registry="docker.io"
              namespace="${parts[*]:0:${#parts[@]}-1}"
              image="${parts[-1]}"
            else
              registry="docker.io"
              namespace=$([ "$context" == "source" ] && echo "library" || echo "$DEST_REPO")
              image="$raw_ref"
            fi

            # æ‹¼æ¥å®Œæ•´é•œåƒåœ°å€
            printf "%s/%s/%s:%s" "$registry" "$namespace" "$image" "$image_tag"
          }

          # é•œåƒåŒæ­¥å‡½æ•°
          sync_image() {
            local src=$1 dst=$2
            echo -e "ğŸ”„ åŒæ­¥ ${COLOR_SRC}$src${COLOR_RESET} â†’ ${COLOR_DST}$dst${COLOR_RESET}"

            # æ£€æŸ¥æ˜¯å¦ä¸ºå¤šæ¶æ„é•œåƒ
            if skopeo inspect --raw --creds "$DOCKERHUB_USER:$DOCKERHUB_TOKEN" "docker://$src" | \
               jq -e '.manifests != null' >/dev/null 2>&1; then
              echo "â„¹ï¸ æ£€æµ‹åˆ°å¤šæ¶æ„é•œåƒ"
              docker buildx imagetools create -t "$dst" "$src"
            else
              echo "â„¹ï¸ å•æ¶æ„é•œåƒå¤„ç†"
              docker pull --quiet "$src"
              docker tag "$src" "$dst"
              docker push --quiet "$dst"
            fi
          }

          # ä¸»å¤„ç†å¾ªç¯
          for source_ref in "${!SYNC_MAP[@]}"; do
            echo "::group::å¤„ç†é•œåƒå¯¹: $source_ref"
            dest_ref="${SYNC_MAP[$source_ref]}"

            # æ ‡å‡†åŒ–é•œåƒåœ°å€
            src_image=$(normalize_image "$source_ref" "source")
            dst_image=$(normalize_image "$dest_ref" "target")
            echo -e "  æºåœ°å€: ${COLOR_SRC}$src_image${COLOR_RESET}"
            echo -e "  ç›®æ ‡åœ°å€: ${COLOR_DST}$dst_image${COLOR_RESET}"

            # è·å–é•œåƒæ‘˜è¦
            src_digest=$(skopeo inspect --creds "$DOCKERHUB_USER:$DOCKERHUB_TOKEN" \
              --format '{{.Digest}}' "docker://$src_image" 2>/dev/null || true)

            if [ -z "$src_digest" ]; then
              echo "âŒ æºé•œåƒä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®"
              ((failed_count++))
              failed_list+=("$src_image")
              echo "::endgroup::"
              continue
            fi

            # æ£€æŸ¥ç›®æ ‡é•œåƒçŠ¶æ€
            if dst_info=$(skopeo inspect --creds "$DOCKERHUB_USER:$DOCKERHUB_TOKEN" \
              "docker://$dst_image" 2>/dev/null); then
              dst_digest=$(jq -r '.Digest' <<< "$dst_info")
              if [ "$src_digest" == "$dst_digest" ]; then
                echo "â­ï¸ ç›®æ ‡é•œåƒå·²åŒæ­¥ï¼Œè·³è¿‡"
                ((skipped_count++))
                skipped_list+=("$src_image")
                echo "::endgroup::"
                continue
              fi
            fi

            # æ‰§è¡ŒåŒæ­¥æ“ä½œ
            if sync_image "$src_image" "$dst_image"; then
              echo "âœ… åŒæ­¥æˆåŠŸ"
              ((success_count++))
              success_list+=("$src_image")
            else
              echo "âŒ åŒæ­¥å¤±è´¥"
              ((failed_count++))
              failed_list+=("$src_image")
            fi

            echo "::endgroup::"
          done

          # ç”Ÿæˆç»“æœæŠ¥å‘Š
          echo "NOTIFICATION_CONTENT<<EOF" >> $GITHUB_ENV
          echo "## åŒæ­¥ç»“æœç»Ÿè®¡" >> $GITHUB_ENV
          echo "âœ… æˆåŠŸ: $success_count" >> $GITHUB_ENV
          echo "â­ï¸ è·³è¿‡: $skipped_count" >> $GITHUB_ENV
          echo "âŒ å¤±è´¥: $failed_count" >> $GITHUB_ENV

          [ $success_count -gt 0 ] && echo "HAS_SUCCESS=true" >> $GITHUB_ENV
          [ $failed_count -gt 0 ] && echo "HAS_FAILURE=true" >> $GITHUB_ENV

          # æ„å»ºè¯¦ç»†æŠ¥å‘Š
          build_details() {
            local title=$1
            local color=$2
            shift 2
            for item in "$@"; do
              echo -e "${color}â€¢${COLOR_RESET} ${item}"
            done
          }

          echo -e "\n### æˆåŠŸåˆ—è¡¨" >> $GITHUB_ENV
          build_details "Success" "$COLOR_OK" "${success_list[@]}" >> $GITHUB_ENV
          echo -e "\n### è·³è¿‡åˆ—è¡¨" >> $GITHUB_ENV
          build_details "Skipped" "$COLOR_OK" "${skipped_list[@]}" >> $GITHUB_ENV
          echo -e "\n### å¤±è´¥åˆ—è¡¨" >> $GITHUB_ENV
          build_details "Failed" "$COLOR_ERROR" "${failed_list[@]}" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: å‘é€é€šçŸ¥
        uses: candies404/Multi-Channel-Notifier@latest
        if: ${{ env.HAS_SUCCESS == 'true' || env.HAS_FAILURE == 'true' }}
        with:
          title: "é•œåƒåŒæ­¥æŠ¥å‘Š"
          content: |
            ${{ env.NOTIFICATION_CONTENT }}
          hitokoto: false
          wpush_key: ${{ secrets.WPUSH_KEY }}
