name: Image Arch Check and Sync

on:
  workflow_dispatch:

jobs:
  check-and-sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Docker login
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
          # 设置环境变量供后续步骤使用
          echo "DEST_REPO=$DOCKERHUB_USERNAME" >> $GITHUB_ENV

      - name: Process images
        run: |
          declare -A SYNC_MAP=(
            ["nginx"]="nginx-m"
            ["redis:7.0"]="redis:7"
            ["chipsman/uptime-kuma"]="uptime-kuma-back"
            ["chipsman/one-hub"]="one-hub"
          )

          IMAGES=("nginx" "redis:7.0" "chipsman/uptime-kuma" "chipsman/one-hub")

          for source_image in "${IMAGES[@]}"; do
            echo "====== 处理镜像: $source_image ======"
            
            # 获取目标镜像名称（自动添加用户名前缀）
            target_path="${SYNC_MAP[$source_image]}"
            if [[ "$source_image" == *":"* ]]; then
              source_tag="${source_image#*:}"
              target_image="$DEST_REPO/${target_path%%:*}:${target_path#*:}"  # 处理带tag的情况
            else
              target_image="$DEST_REPO/${target_path}:latest"  # 无tag时使用latest
            fi

            # 构造完整源镜像路径
            if [[ "$source_image" != *"/"* ]]; then
              full_source_image="docker.io/library/$source_image"
            else
              full_source_image="docker.io/$source_image"
            fi

            # 检查是否是多架构镜像
            raw_data=$(skopeo inspect --raw "docker://$full_source_image")
            is_multiarch=$(echo "$raw_data" | jq -e '.manifests != null')

            # 执行同步
            if [ "$is_multiarch" = "true" ]; then
              echo "发现多架构镜像，使用buildx同步..."
              docker buildx imagetools create -t "$target_image" "$full_source_image"
            else
              echo "单架构镜像，直接复制..."
              docker pull "$full_source_image"
              docker tag "$full_source_image" "$target_image"
              docker push "$target_image"
            fi

            echo "成功同步镜像: $full_source_image => $target_image"
            echo "======================================="
          done
