name: Multi-arch Image Sync

on:
  workflow_dispatch:
    inputs:
      sync_mappings:
        description: 'é•œåƒåŒæ­¥è§„åˆ™ï¼ˆæ ¼å¼ï¼šæºé•œåƒ=ç›®æ ‡é•œåƒï¼Œå¤šä¸ªç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”ï¼‰'
        required: false

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  sync-images:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Validate and process SYNC_MAPPINGS
        id: process-sync-mappings
        env:
          SYNC_MAPPINGS_INPUT: ${{ inputs.sync_mappings || vars.SYNC_MAPPINGS }}
        run: |
          # å¢å¼ºçš„è¾“å…¥é¢„å¤„ç†
          processed_input=$(echo "$SYNC_MAPPINGS_INPUT" | 
            tr '\n' ',' | 
            sed -E 's/[[:space:]]*,[[:space:]]*/,/g; s/^,//; s/,$//' |
            envsubst
          )
          
          declare -A valid_rules
          declare -A grouped_rules
          declare -a source_images
          
          IFS=',' read -ra RULES <<< "$processed_input"
          for raw_rule in "${RULES[@]}"; do
            # å¼ºåŒ–è§„åˆ™æ¸…ç†
            rule=$(echo "$raw_rule" | xargs | sed -E 's//\//{2,}/\//g; s/(:[^=]+)=/\1 =/')
            
            if [[ "$rule" =~ ^([^=]+)[[:space:]]*=[[:space:]]*(.+)$ ]]; then
              src=$(echo "${BASH_REMATCH[1]}" | sed 's/^docker.io\///')
              dst="${BASH_REMATCH[2]}"
              
              # æ ‡å‡†åŒ–æºé•œåƒæ ¼å¼
              if [[ ! "$src" =~ / ]]; then
                src="docker.io/library/$src"
              fi
              [[ ! "$src" =~ : ]] && src="$src:latest"

              # å¤„ç†é€šé…ç¬¦(*)å’Œç‰¹æ®Šå­—ç¬¦
              safe_key=$(echo "$src=>$dst" | tr '*@#!' 'xxxx')
              if [[ -n "${valid_rules[$safe_key]}" ]]; then
                echo "::notice::è·³è¿‡é‡å¤è§„åˆ™: $src â†’ $dst"
                continue
              fi
              valid_rules[$safe_key]=1

              # å¤„ç†ç›®æ ‡é•œåƒè·¯å¾„
              if [[ "$dst" =~ \${DOCKERHUB_USERNAME} ]]; then
                dst=$(echo "$dst" | sed "s/\${DOCKERHUB_USERNAME}/$DOCKERHUB_USERNAME/")
              fi

              grouped_rules["$dst"]+="\"$src\" "  # JSONå®‰å…¨å¼•ç”¨
              source_images+=("$src")
              echo "âœ… æœ‰æ•ˆè§„åˆ™: $src â†’ $dst"
            else
              echo "::warning::æ— æ•ˆæ ¼å¼: $raw_rule"
            fi
          done

          # ç”Ÿæˆæ ‡å‡†åŒ–è¾“å‡º
          echo "unique_sources=$(printf '%s\n' "${source_images[@]}" | jq -Rn '[inputs | select(. != "")] | unique')" >> $GITHUB_OUTPUT
          echo "total_rules=${#valid_rules[@]}" >> $GITHUB_OUTPUT
          
          # ä¿®å¤åˆ†ç»„JSONæ„é€ ï¼ˆå…³é”®ä¿®æ”¹ç‚¹ï¼‰
          grouped_json=$(jq -n '{}')
          for dst in "${!grouped_rules[@]}"; do
            src_list=${grouped_rules[$dst]}
            formatted_srcs=$(echo "[${src_list% }]" | jq -c 'unique')
            grouped_json=$(jq --arg dst "$dst" --argjson srcs "$formatted_srcs" '. + { ($dst): $srcs }' <<< "$grouped_json")
          done
          echo "grouped_rules=$grouped_json" >> $GITHUB_OUTPUT

      - name: Architecture Validation
        run: |
          sources=${{ fromJson(steps.process-sync-mappings.outputs.unique_sources) }}
          for image in "${sources[@]}"; do
            echo "ğŸ” æ£€æŸ¥æ¶æ„: $image"
            skopeo inspect --raw "docker://$image" | jq -c '[.manifests[].platform | {os,arch,variant}]' || true
            echo "-------------------"
          done

      - name: Execute Image Sync
        id: image-sync
        run: |
          grouped_rules='${{ steps.process-sync-mappings.outputs.grouped_rules }}'
          echo "$grouped_rules" | jq -r 'keys[] as $dst | "\($dst) \(.[$dst] | join(" "))"' | while read -r dst srcs; do
            echo "ğŸš€ åŒæ—¶æ¨é€å¤šæºé•œåƒ: $srcs â†’ $dst"
            docker buildx imagetools create -t "$dst" $srcs || echo "::error::åŒæ­¥å¤±è´¥: $srcs â†’ $dst"
          done
      - name: Generate Report
        run: |
          # åˆå§‹åŒ–æŠ¥å‘Šæ¨¡æ¿
          report_header="# [$(date '+%Y-%m-%d %H:%M:%S')] é•œåƒåŒæ­¥æŠ¥å‘Š"
          success_table="\n## âœ… æˆåŠŸåŒæ­¥ (${ { steps.image-sync.outputs.total_success } })"
          failed_table="\n## âŒ å¤±è´¥åŒæ­¥ (${ { steps.image-sync.outputs.total_failed } })"
          
          # æ„å»ºè¯¦ç»†ç»“æœ
          echo "${{ steps.image-sync.outputs.grouped_rules }}" | jq -r 'to_entries[] | "\(.key)=\(.value | join(" "))"' | while IFS="=" read -r dst srcs; do
            success_table+="\n- ${srcs} â†’ ${dst}"
          done
          
          if [ ${{ steps.image-sync.outputs.total_failed }} -gt 0 ]; then
            failed_rules_json='${{ steps.image-sync.outputs.failed_rules }}'
            fail_count=$(echo "$failed_rules_json" | jq length)
            for ((i=0; i<$fail_count; i++)); do
              rule=$(echo "$failed_rules_json" | jq -r ".[$i]")
              failed_table+="\n- ${rule}"
            done
          fi
          
          # ç”Ÿæˆå®Œæ•´æŠ¥å‘Š
          full_report="${report_header}\n${success_table}\n${failed_table}"
          echo -e "$full_report"
          
          # å†™å…¥GitHubæ³¨é‡Š(å¯é€‰)
          if [ -n "$GITHUB_STEP_SUMMARY" ]; then
            echo -e "$full_report" >> $GITHUB_STEP_SUMMARY
          fi
          
          # å¤±è´¥æ—¶ä¸»åŠ¨è§¦å‘éé›¶é€€å‡º
          if [ ${{ steps.image-sync.outputs.total_failed }} -gt 0 ]; then
            echo "::error::å­˜åœ¨ ${ { steps.image-sync.outputs.total_failed } } æ¡åŒæ­¥å¤±è´¥"
            exit 1
          fi

