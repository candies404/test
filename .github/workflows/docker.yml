name: Docker é•œåƒåŒæ­¥ä¼˜åŒ–ç‰ˆ

on:
  workflow_dispatch:
    inputs:
      sync_mappings:
        description: 'é•œåƒåŒæ­¥æ˜ å°„ï¼ˆæ ¼å¼ï¼šæºé•œåƒ=ç›®æ ‡é•œåƒï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: false

jobs:
  image-sync:
    name: é•œåƒåŒæ­¥
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DEST_REPO: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKER_SYNC_MAPPINGS: ${{ vars.DOCKER_SYNC_MAPPINGS }}
      BUILDKIT_PROGRESS: plain

    steps:
      - name: éªŒè¯é•œåƒåŒæ­¥æ ¼å¼
        id: validate-mappings
        run: |
          # å‚æ•°ä¼˜å…ˆçº§å¤„ç†
          PROCESSED_MAPPINGS="${INPUT_SYNC_MAPPINGS:-${DOCKER_SYNC_MAPPINGS}}"
          
          # å¢å¼ºç©ºå€¼æ£€æŸ¥
          if [[ -z "${PROCESSED_MAPPINGS}" ]]; then
            echo "::error::Missing sync mappings"
            exit 1
          fi

          # è¾“å…¥æ¸…æ´—å¼ºåŒ–å¤„ç†
          CLEAN_MAPPINGS=$(echo "${PROCESSED_MAPPINGS}" | \
            tr -d '\n' | tr -s ' ' | \
            sed -E 's/[[:space:]]+//g; s/,+/,/g; s/^,//; s/,$//')

          # ä¼˜åŒ–æ­£åˆ™è¡¨è¾¾å¼éªŒè¯
          if ! grep -qE '^([a-zA-Z0-9][a-zA-Z0-9_.\-/]*=[a-zA-Z0-9][a-zA-Z0-9_.\-/]*)(,[a-zA-Z0-9][a-zA-Z0-9_.\-/]*=[a-zA-Z0-9][a-zA-Z0-9_.\-/]*)*$' <<< "${CLEAN_MAPPINGS}"; then
            echo "::error::Invalid mapping format"
            exit 1
          fi

          echo "SYNC_MAPPINGS=${CLEAN_MAPPINGS}" >> "${GITHUB_ENV}"

      - name: è®¾ç½®å¤šæ¶æ„æ„å»ºç¯å¢ƒ
        uses: docker/setup-buildx-action@v3
        with:
          install: true
          driver-opts: |
            network=host
            image=moby/buildkit:master-rootless
        env:
          DOCKER_CLI_EXPERIMENTAL: enabled

      - name: å®‰è£… skopeo
        run: |
          # å¢åŠ å®‰è£…æ ¡éªŒ
          if ! sudo apt-get update -qq && sudo apt-get install -y skopeo; then
            echo "::error::Skopeo installation failed"
            exit 1
          fi
          skopeo --version | awk '{printf "âœ… skopeo v%s installed", $3}'

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${DOCKERHUB_USER}
          password: ${DOCKERHUB_TOKEN}
        env:
          DOCKER_REGISTRY: index.docker.io

      - name: æ‰§è¡Œé•œåƒåŒæ­¥
        id: sync
        run: |
          #!/usr/bin/env bash
          set -eo pipefail
          shopt -s inherit_errexit

          # å¢å¼ºç‰ˆæ—¥å¿—ç³»ç»Ÿ
          declare -A LOG_COLORS=(
            [INFO]="\033[1;32m"
            [WARN]="\033[1;33m" 
            [ERROR]="\033[1;31m"
          )
          log() {
            local level="${1}"
            local message="${2}"
            local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            echo -e "${LOG_COLORS[$level]}[${timestamp}] ${level}: ${message}\033[0m" >&2
          }

          # åŒæ­¥çŠ¶æ€è¿½è¸ªå™¨
          declare -A SYNC_RESULTS=(
            [TOTAL]=0
            [SUCCESS]=0
            [SKIPPED]=0
            [FAILED]=0
          )

          # é•œåƒå¤„ç†ä¸Šä¸‹æ–‡
          process_mapping() {
            local source_ref="${1}"
            local dst_ref="${2}"
            
            log INFO "ğŸš¦ å¼€å§‹å¤„ç†æ˜ å°„å¯¹ï¼š${source_ref} â†’ ${dst_ref}"
            
            # å¢å¼ºé•œåƒæ­£è§„åŒ–å¤„ç†
            normalize_image() {
              local ref="${1}"
              local default_tag="${2}"
              local context="${3}"
              
              if [[ ! "${ref}" =~ .*/.* ]]; then
                [[ "${context}" == "source" ]] && ref="library/${ref}"
                [[ "${context}" == "target" ]] && ref="${DEST_REPO}/${ref}"
              fi
              
              if [[ ! "${ref}" =~ : ]]; then
                ref+=":${default_tag:-latest}"
              fi
              
              echo "docker.io/${ref}"
            }

            local src_image dst_image
            src_image=$(normalize_image "${source_ref}" "latest" "source")
            dst_image=$(normalize_image "${dst_ref}" "$(cut -d: -f2 <<< "${src_image}")" "target")

            # æ¶æ„æ¯”å¯¹ä¼˜åŒ–
            compare_architectures() {
              local src="${1}" dst="${2}"
              
              # ä½¿ç”¨å¹¶è¡Œå¤„ç†æå‡æ€§èƒ½
              local src_info dst_info
              src_info=$(skopeo inspect --raw --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" "docker://${src}" 2>&1)
              dst_info=$(skopeo inspect --raw --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" "docker://${dst}" 2>&1)
              
              # å¤šæ¶æ„å¤„ç†é€»è¾‘ä¼˜åŒ–
              jq_arch_filter='[.manifests[].platform | 
                select(.os != "unknown" and .architecture != "unknown") |
                "\(.os)/\(.architecture)\(if .variant != "" then "/"+.variant else "" end)"] | unique'
                
              src_archs=$(jq -r "${jq_arch_filter}" <<< "${src_info}" | tr -d '\n')
              dst_archs=$(jq -r "${jq_arch_filter}" <<< "${dst_info}" | tr -d '\n')

              [[ "${src_archs}" == "${dst_archs}" ]] && return 0 || return 1
            }

            # é•œåƒåŒæ­¥æµç¨‹æ§åˆ¶
            if compare_architectures "${src_image}" "${dst_image}"; then
              log INFO "â­ï¸ æ¶æ„ä¸€è‡´ï¼Œè·³è¿‡åŒæ­¥"
              SYNC_RESULTS[SKIPPED]=$((SYNC_RESULTS[SKIPPED]+1))
              return
            fi

            # å¢åŠ é‡è¯•æœºåˆ¶
            for attempt in {1..3}; do
              if docker buildx imagetools create -t "${dst_image}" "${src_image}"; then
                SYNC_RESULTS[SUCCESS]=$((SYNC_RESULTS[SUCCESS]+1))
                log INFO "âœ… åŒæ­¥æˆåŠŸ (å°è¯•æ¬¡æ•°: ${attempt})"
                return 0
              else
                log WARN "âš ï¸ åŒæ­¥å¤±è´¥ (å°è¯•æ¬¡æ•°: ${attempt})"
                sleep $((attempt * 5))
              fi
            done
            
            SYNC_RESULTS[FAILED]=$((SYNC_RESULTS[FAILED]+1))
            log ERROR "âŒ åŒæ­¥å¤±è´¥"
            return 1
          }

          # ä¸»å¤„ç†å¾ªç¯
          IFS=',' read -ra MAPPING_PAIRS <<< "${SYNC_MAPPINGS}"
          SYNC_RESULTS[TOTAL]=${#MAPPING_PAIRS[@]}
          
          for pair in "${MAPPING_PAIRS[@]}"; do
            IFS='=' read -r src dst <<< "${pair}"
            process_mapping "${src}" "${dst}" || true
          done

          # ç”Ÿæˆæ•°æ®æŠ¥å‘Š
          report=$(cat <<EOF
          ğŸ“Š åŒæ­¥æŠ¥å‘Šï¼š
          æ€»æ•°ï¼š${SYNC_RESULTS[TOTAL]}
          âœ… æˆåŠŸï¼š${SYNC_RESULTS[SUCCESS]}
          â© è·³è¿‡ï¼š${SYNC_RESULTS[SKIPPED]}
          âŒ å¤±è´¥ï¼š${SYNC_RESULTS[FAILED]}
          EOF
          )
          
          echo "NOTIFICATION_CONTENT<<EOF" >> "${GITHUB_ENV}"
          echo "${report}" >> "${GITHUB_ENV}"
          echo "EOF" >> "${GITHUB_ENV}"

      - name: å‘é€å¢å¼ºé€šçŸ¥
        uses: candies404/Multi-Channel-Notifier@latest
        if: always()
        with:
          title: "é•œåƒåŒæ­¥æŠ¥å‘Š"
          content: |
            ${{ env.NOTIFICATION_CONTENT }}
          hitokoto: false
          wpush_key: ${{ secrets.WPUSH_KEY }}
