name: Multi-arch Image Sync

on:
  workflow_dispatch:
    inputs:
      sync_mappings:
        description: 'é•œåƒåŒæ­¥è§„åˆ™ï¼ˆæ ¼å¼ï¼šæºé•œåƒ=ç›®æ ‡é•œåƒï¼Œå¤šä¸ªç”¨é€—å·æˆ–æ¢è¡Œåˆ†éš”ï¼‰'
        required: false

env:
  DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  sync-images:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo

      - name: Validate and process SYNC_MAPPINGS
        id: process-sync-mappings
        env:
          SYNC_MAPPINGS_INPUT: ${{ inputs.sync_mappings || vars.SYNC_MAPPINGS }}
        run: |
          # è¾“å…¥é¢„å¤„ç†æµç¨‹
          echo "åŸå§‹è¾“å…¥: $SYNC_MAPPINGS_INPUT"
          processed_input=$(echo "$SYNC_MAPPINGS_INPUT" | 
            tr '\n' ',' |      # æ¢è¡Œè½¬é€—å·
            tr -s ', ' |       # å‹ç¼©é‡å¤åˆ†éš”ç¬¦
            sed -E 's/^[, ]+//; s/[, ]+$//' |  # ç§»é™¤é¦–å°¾æ— æ•ˆå­—ç¬¦
            envsubst           # æ›¿æ¢ç¯å¢ƒå˜é‡
          )
          
          # è§„åˆ™è§£æå’ŒéªŒè¯
          declare -A valid_rules
          declare -A grouped_rules
          declare -a source_images
          
          IFS=',' read -ra RULES <<< "$processed_input"
          for rule in "${RULES[@]}"; do
            rule=$(echo "${rule}" | xargs | sed 's/\/\//\//g; s/\/$//')  # æ ‡å‡†åŒ–è·¯å¾„
            
            if [[ "$rule" =~ ^([^=]+)=([^=]+)$ ]]; then
              src="${BASH_REMATCH[1]}"
              dst="${BASH_REMATCH[2]}"
              
              # è‡ªåŠ¨è¡¥å…¨å®˜æ–¹é•œåƒå‰ç¼€
              if [[ ! "$src" =~ / ]] && [[ "$src" != *.*:* ]]; then
                src="docker.io/library/$src"
              fi
              
              # å»é‡æ£€æŸ¥
              if [[ -n "${valid_rules["$src=$dst"]}" ]]; then
                echo "::notice::å¿½ç•¥é‡å¤è§„åˆ™: $src => $dst"
                continue
              fi
              
              valid_rules["$src=$dst"]=1
              grouped_rules["$dst"]+=" $src"
              source_images+=("$src")
              
              echo " âœ… æœ‰æ•ˆè§„åˆ™: $src â†’ $dst"
            else
              echo "::warning::æ— æ•ˆè§„åˆ™æ ¼å¼: $rule"
            fi
          done
          
          # è¾“å‡ºå¤„ç†ç»“æœ
          echo "å¤„ç†å®Œæˆ ${#valid_rules[@]} æ¡æœ‰æ•ˆè§„åˆ™"
          echo "unique_sources=$(printf '%s\n' "${source_images[@]}" | jq -R -s 'split("\n") | map(select(. != "")) | unique')" >> $GITHUB_OUTPUT
          echo "total_rules=${#valid_rules[@]}" >> $GITHUB_OUTPUT
          
          # æ„å»ºåˆ†ç»„JSON
          grouped_json=$(jq -n '{}')
          for dst in "${!grouped_rules[@]}"; do
            sources=(${grouped_rules[$dst]})
            grouped_json=$(jq --arg dst "$dst" --argjson sources "${sources[*]}" '. + { ($dst): $sources }' <<< "$grouped_json")
          done
          echo "grouped_rules=$grouped_json" >> $GITHUB_OUTPUT

      - name: Architecture Validation
        run: |
          sources=${{ steps.process-sync-mappings.outputs.unique_sources }}
          echo "ğŸ“¦ éœ€è¦æ£€æŸ¥çš„é•œåƒåˆ—è¡¨:"
          echo "$sources" | jq -r '.[]'
          
          echo "$sources" | jq -r '.[]' | while read -r image; do
            echo "ğŸ” æ£€æŸ¥é•œåƒæ¶æ„: $image"
            manifest=$(skopeo inspect --raw "docker://$image" 2>&1 || true)
            
            if ! jq -e . <<< "$manifest" &>/dev/null; then
              echo "âŒ è·å–æ¸…å•å¤±è´¥: $manifest"
              continue
            fi
            
            if jq -e '.manifests' <<< "$manifest" &>/dev/null; then
              archs=$(jq -r '[.manifests[].platform | "\(.os)/\(.architecture)\(.variant?//"")"] | unique | join(", ")' <<< "$manifest")
              echo "ğŸ”„ å¤šæ¶æ„é•œåƒæ”¯æŒ: $archs"
            else
              os=$(jq -r '.Os // "unknown"' <<< "$manifest")
              arch=$(jq -r '.Architecture // "unknown"' <<< "$manifest")
              echo "âš¡ å•æ¶æ„é•œåƒ: ${os}/${arch}"
            fi
          done

      - name: Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Execute Image Sync
        id: image-sync
        run: |
          grouped_rules='${{ steps.process-sync-mappings.outputs.grouped_rules }}'
          total_success=0
          total_failed=0
          failed_rules=()
          
          echo "$grouped_rules" | jq -r 'to_entries[] | "\(.key)=\(.value[])"' | while IFS="=" read -r dst src; do
            echo "ğŸš€ åŒæ­¥æ“ä½œ: $src â†’ $dst"
            if docker buildx imagetools create -t "$dst" "$src"; then
              ((total_success++))
              echo "âœ… åŒæ­¥æˆåŠŸ: $src â†’ $dst"
            else
              ((total_failed++))
              error_msg="$src â†’ $dst"
              failed_rules+=("$error_msg")
              echo "::error::åŒæ­¥å¤±è´¥: $error_msg"
            fi
            echo "------------------------------"
          done
          
          # å†™å…¥è¾“å‡ºå˜é‡
          echo "total_success=$total_success" >> $GITHUB_OUTPUT
          echo "total_failed=$total_failed" >> $GITHUB_OUTPUT
          echo "failed_rules=$(printf '%s\n' "${failed_rules[@]}" | jq -R -s 'map(select(. != ""))')" >> $GITHUB_OUTPUT

      - name: Generate Report
        run: |
          echo "ğŸ“ˆ ===== åŒæ­¥æŠ¥å‘Š ====="
          echo "æ€»å¤„ç†è§„åˆ™: ${{ steps.process-sync-mappings.outputs.total_rules }}"
          echo "æˆåŠŸæ•°é‡: ${{ steps.image-sync.outputs.total_success }}"
          echo "å¤±è´¥æ•°é‡: ${{ steps.image-sync.outputs.total_failed }}"
          
          if [[ ${{ steps.image-sync.outputs.total_failed }} -gt 0 ]]; then
            echo "âŒ å¤±è´¥è¯¦æƒ…:"
            echo "${{ steps.image-sync.outputs.failed_rules }}" | jq -r '.[]'
            exit 1
          else
            echo "ğŸ‰ æ‰€æœ‰é•œåƒåŒæ­¥æˆåŠŸï¼"
          fi
