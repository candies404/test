name: Image Sync with Architecture Validation

on:
  workflow_dispatch:

jobs:
  image-sync:
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DEST_REPO: ${{ secrets.DOCKERHUB_USERNAME }}

    steps:
      - name: Setup build environment
        uses: docker/setup-buildx-action@v3
        with:
          install: true
          driver-opts: network=host

      - name: Install system dependencies
        run: |
          echo "ğŸ› ï¸ Installing required tools..."
          sudo apt-get update && sudo apt-get install -y skopeo jq
          echo "âœ… Dependencies installed"

      - name: Configure Docker authentication
        run: |
          mkdir -p $HOME/.docker
          auth_token=$(echo -n "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" | base64 -w 0)
          cat > $HOME/.docker/config.json <<EOF
          {
            "auths": {
              "https://index.docker.io/v1/": {
                "auth": "${auth_token}"
              }
            }
          }
          EOF
          echo "ğŸ” Docker authentication configured"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USER }}
          password: ${{ env.DOCKERHUB_TOKEN }}
        env:
          DOCKER_REGISTRY: index.docker.io

      - name: Execute image synchronization
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          # åŒæ­¥é…ç½®
          declare -A SYNC_MAP=(
            ['nginx']='nginx-m'
            ['redis:7.0']='redis:7' 
            ['chipsman/uptime-kuma']='uptime-kuma-back'
          )

          # æ—¥å¿—é¢œè‰²å®šä¹‰
          readonly COLOR_RESET="\033[0m"
          readonly COLOR_SRC="\033[1;34m"
          readonly COLOR_DST="\033[1;35m"
          readonly COLOR_OK="\033[1;32m"
          readonly COLOR_WARN="\033[1;33m"
          readonly COLOR_ERR="\033[1;31m"

          # å¸¦æ—¶é—´æˆ³çš„æ—¥å¿—å‡½æ•°
          log() {
            local level=$1
            local message=$2
            local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            case $level in
              "INFO")  echo -e "${COLOR_OK}[${timestamp}] INFO: ${message}${COLOR_RESET}" ;;
              "WARN")  echo -e "${COLOR_WARN}[${timestamp}] WARN: ${message}${COLOR_RESET}" >&2 ;;
              "ERROR") echo -e "${COLOR_ERR}[${timestamp}] ERROR: ${message}${COLOR_RESET}" >&2 ;;
            esac
          }

          # é•œåƒè·¯å¾„è§„èŒƒåŒ–
          normalize_image() {
            local image_ref=$1
            local default_tag=$2
            local context=$3

            # åˆ†ç¦»åç§°å’Œæ ‡ç­¾
            if [[ "$image_ref" == *":"* ]]; then
              local image_name="${image_ref%:*}"
              local image_tag="${image_ref#*:}"
            else
              local image_name="$image_ref"
              local image_tag="$default_tag"
            fi

            # å¤„ç†ä¸åŒåœºæ™¯
            case $context in
              "source")
                # æºé•œåƒä¿ç•™library/å‰ç¼€
                if [[ "$image_name" == *"/"* ]]; then
                  printf "docker.io/%s:%s" "$image_name" "$image_tag"
                else
                  printf "docker.io/library/%s:%s" "$image_name" "$image_tag"
                fi
                ;;
              "target")
                # ç›®æ ‡é•œåƒä½¿ç”¨ç”¨æˆ·ä»“åº“
                printf "docker.io/%s/%s:%s" "$DEST_REPO" "$image_name" "$image_tag"
                ;;
              *)
                log "ERROR" "æ— æ•ˆçš„ä¸Šä¸‹æ–‡å‚æ•°: $context"
                exit 1
                ;;
            esac
          }

          # æ¶æ„ä¿¡æ¯è·å–
          get_architecture() {
            local image=$1
            log "INFO" "è·å–æ¶æ„ä¿¡æ¯ï¼š${COLOR_SRC}${image}${COLOR_RESET}"
            
            local manifest
            if ! manifest=$(skopeo inspect --raw --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" "docker://${image}" 2>&1); then
                log "ERROR" "æ— æ³•è·å–é•œåƒæ¸…å•ï¼š${manifest}"
                return 1
            fi

            if jq -e '.manifests != null' <<< "$manifest" &>/dev/null; then
                local arch_list=$(jq -r '
                [.manifests[].platform | 
                    select(.os != "unknown" and .architecture != "unknown") |
                    "\(.os)/\(.architecture)\(if .variant then "/"+.variant else "" end)"
                ] | unique | join(", ")' <<< "$manifest")
                
                [[ -z "$arch_list" ]] && { log "ERROR" "æ²¡æœ‰æ‰¾åˆ°æœ‰æ•ˆçš„æ¶æ„ä¿¡æ¯"; return 1; }
                
                log "INFO" "æ£€æµ‹åˆ°å¤šæ¶æ„é•œåƒï¼š${arch_list}"
                echo "$arch_list"
            else
              local os=$(jq -r '.Os // "unknown"' <<< "$manifest")
              local arch=$(jq -r '.Architecture // "unknown"' <<< "$manifest")
              local variant=$(jq -r '.Variant? // ""' <<< "$manifest")
              local result="${os}/${arch}${variant:+"/$variant"}"
              [[ "$result" == "unknown/unknown" ]] && result="unknown"
              log "INFO" "å•æ¶æ„é•œåƒï¼š${result}"
              echo "$result"
            fi
          }

          # é•œåƒåŒæ­¥æ‰§è¡Œ
          sync_image() {
            local src=$1
            local dst=$2

            log "INFO" "å¯åŠ¨åŒæ­¥ï¼š${COLOR_SRC}${src}${COLOR_RESET} â†’ ${COLOR_DST}${dst}${COLOR_RESET}"
            
            if skopeo inspect --raw --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" "docker://${src}" | jq -e '.manifests != null' &>/dev/null; then
              log "INFO" "ä½¿ç”¨å¤šæ¶æ„åŒæ­¥æ¨¡å¼"
              docker buildx imagetools create -t "$dst" "$src" || { log "ERROR" "å¤šæ¶æ„åŒæ­¥å¤±è´¥"; return 1; }
            else
              docker pull --quiet "$src" || { log "ERROR" "é•œåƒæ‹‰å–å¤±è´¥"; return 1; }
              docker tag "$src" "$dst" || { log "ERROR" "é•œåƒæ ‡ç­¾è®¾ç½®å¤±è´¥"; return 1; }
              docker push --quiet "$dst" || { log "ERROR" "é•œåƒæ¨é€å¤±è´¥"; return 1; }
            fi
            log "INFO" "åŒæ­¥å®Œæˆ"
          }

          # ä¸»æ‰§è¡Œæµç¨‹
          for source_ref in "${!SYNC_MAP[@]}"; do
            echo "::group::ğŸ”„ Processing ${source_ref}"

            # è§„èŒƒåŒ–é•œåƒåœ°å€
            src_image=$(normalize_image "$source_ref" "latest" "source")
            dst_ref="${SYNC_MAP[$source_ref]}"
            dst_image=$(normalize_image "$dst_ref" "$(cut -d: -f2 <<< "$src_image")" "target")

            log "INFO" "æºé•œåƒåœ°å€: ${COLOR_SRC}${src_image}${COLOR_RESET}"
            log "INFO" "ç›®æ ‡é•œåƒåœ°å€: ${COLOR_DST}${dst_image}${COLOR_RESET}"

            # éªŒè¯æºé•œåƒ
            log "INFO" "éªŒè¯æºé•œåƒå¯è®¿é—®æ€§"
            if ! skopeo inspect --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" "docker://${src_image}" >/dev/null; then
              log "ERROR" "æºé•œåƒä¸å¯è®¿é—®ï¼š${src_image}"
              exit 1
            fi

            # è·å–ç›®æ ‡é•œåƒçŠ¶æ€ï¼ˆæ–°å¢å…³é”®ç‚¹ï¼‰
            if target_info=$(skopeo inspect --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" "docker://${dst_image}" 2>/dev/null); then
              dst_exists=true
            else
              dst_exists=false
              log "WARN" "ç›®æ ‡é•œåƒä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°é•œåƒ"
            fi

            # æ¶æ„åˆ†æï¼ˆæµç¨‹å‰ç½®å…³é”®ä¿®æ”¹ï¼‰
            log "INFO" "æ‰§è¡Œæ¶æ„åˆ†æ"
            src_arch=$(get_architecture "$src_image")
            if $dst_exists; then
              dst_arch=$(get_architecture "$dst_image")
            else
              dst_arch="N/A"
            fi

            # æ˜¾ç¤ºæ¶æ„å¯¹æ¯”ï¼ˆæ–°å¢é‡ç‚¹ï¼‰
            echo -e "\n${COLOR_OK}æ¶æ„å¯¹æ¯”æŠ¥å‘Šï¼š${COLOR_RESET}"
            printf "%-40s â†’ %-40s\n" "æºæ¶æ„" "ç›®æ ‡æ¶æ„"
            printf "%-40s â”‚ %-40s\n" "$src_arch" "$dst_arch"
            echo

            # æ£€æŸ¥åŒæ­¥å¿…è¦æ€§ï¼ˆé€»è¾‘ä¼˜åŒ–ï¼‰
            log "INFO" "è®¡ç®—é•œåƒæ‘˜è¦"
            src_digest=$(skopeo inspect --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" --format '{{.Digest}}' "docker://${src_image}")
            
            if $dst_exists && [[ "$(jq -r '.Digest' <<< "$target_info")" == "$src_digest" ]]; then
              log "INFO" "ç›®æ ‡é•œåƒå·²æ˜¯æœ€æ–°ç‰ˆæœ¬ï¼Œè·³è¿‡åŒæ­¥"
              echo "::endgroup::"
              continue
            fi

            $dst_exists && log "INFO" "å‘ç°å·®å¼‚ï¼šæºæ‘˜è¦ ${src_digest:0:12}... vs ç›®æ ‡æ‘˜è¦ ${dst_digest:0:12}..."

            if sync_image "$src_image" "$dst_image"; then
              log "INFO" "âœ… åŒæ­¥æˆåŠŸå®Œæˆ"
            else
              log "ERROR" "âŒ åŒæ­¥è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯"
              exit 1
            fi

            echo "::endgroup::"
          done
