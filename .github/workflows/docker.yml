name: Image Sync with Architecture Validation

on:
  workflow_dispatch:
    inputs:
      sync_mappings:
        description: 'é•œåƒåŒæ­¥æ˜ å°„ï¼ˆæ ¼å¼ï¼šæºé•œåƒ=ç›®æ ‡é•œåƒï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: false

jobs:
  image-sync:
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DEST_REPO: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKER_SYNC_MAPPINGS: ${{ vars.DOCKER_SYNC_MAPPINGS }}
      BUILDKIT_PROGRESS: plain

    steps:
      # è¾“å…¥éªŒè¯æ­¥éª¤
      - name: Validate sync mappings
        id: validate-mappings
        run: |
          echo "ğŸ” å¼€å§‹éªŒè¯åŒæ­¥æ˜ å°„..."
          
          # ä¼˜å…ˆè·å–æ‰‹åŠ¨è¾“å…¥ï¼Œæ²¡æœ‰åˆ™ä½¿ç”¨é¢„å®šä¹‰å˜é‡
          PROCESSED_MAPPINGS="${{ github.event.inputs.sync_mappings || env.DOCKER_SYNC_MAPPINGS }}"
          
          # æ¸…ç†è¾“å…¥ä¸­çš„ç©ºç™½å’Œé‡å¤åˆ†éš”ç¬¦
          CLEAN_MAPPINGS=$(tr -d '\n' <<< "$PROCESSED_MAPPINGS" | sed -e 's/\s*//g' -e 's/,+/,/g')
          
          # ç©ºå€¼æ£€æŸ¥
          if [[ -z "$CLEAN_MAPPINGS" ]]; then
            echo "::error::âŒ åŒæ­¥æ˜ å°„ä¸èƒ½ä¸ºç©ºï¼Œè¯·æ£€æŸ¥è¾“å…¥ï¼"
            exit 1
          fi
          
          # æ ¼å¼æœ‰æ•ˆæ€§éªŒè¯ (æ­£åˆ™è¡¨è¾¾å¼åŒ¹é… src=dst æ¨¡å¼)
          if ! grep -qE '^([^=]+=[^=]+)(,[^=]+=[^=]+)*$' <<< "$CLEAN_MAPPINGS"; then
            echo "::error::âŒ æ— æ•ˆçš„æ˜ å°„æ ¼å¼ï¼Œæ­£ç¡®ç¤ºä¾‹ï¼šsrc1=dst1,src2=dst2"
            exit 1
          fi
          
          echo "SYNC_MAPPINGS=${CLEAN_MAPPINGS}" >> $GITHUB_ENV
          echo "âœ… åŒæ­¥æ˜ å°„éªŒè¯é€šè¿‡ï¼š${CLEAN_MAPPINGS}"

      # å‡†å¤‡æ„å»ºç¯å¢ƒ
      - name: Setup build environment
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host  # å¯ç”¨ç½‘ç»œå…±äº«æ¨¡å¼
        env:
          DOCKER_CLI_EXPERIMENTAL: enabled  # å¯ç”¨å®éªŒç‰¹æ€§

      # å®‰è£…å¿…è¦å·¥å…·
      - name: Install skopeo
        run: |
          echo "ğŸ› ï¸ æ­£åœ¨å®‰è£… skopeo..."
          sudo apt-get update -qq && sudo apt-get install -y skopeo
          echo "âœ… skopeo $(skopeo --version | awk '{print $3}') å®‰è£…å®Œæˆ"

      # Docker Hub è®¤è¯
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USER }}
          password: ${{ env.DOCKERHUB_TOKEN }}
        env:
          DOCKER_REGISTRY: index.docker.io

      # æ ¸å¿ƒåŒæ­¥æ­¥éª¤
      - name: Execute image synchronization
        id: sync
        env:
          COLOR_RESET: \033[0m   # é¢œè‰²ä»£ç 
          COLOR_SRC: \033[1;34m  # æºé•œåƒé¢œè‰²
          COLOR_DST: \033[1;35m  # ç›®æ ‡é•œåƒé¢œè‰²
        run: |
          # åˆå§‹åŒ–åŒæ­¥ç»“æœå­˜å‚¨
          declare -A SYNC_MAP=()
          successes=()
          skipped=()
          failures=()

          echo "======= åŒæ­¥é…ç½® ======="
          echo "æ€»æ˜ å°„æ•°é‡ï¼š${#PAIRS[@]}"
          
          # è§£æåŒæ­¥æ˜ å°„
          IFS=',' read -ra PAIRS <<< "$SYNC_MAPPINGS"
          for pair in "${PAIRS[@]}"; do
            IFS='=' read -r src dst <<< "$pair"
            SYNC_MAP["$src"]="$dst"
            echo "ğŸ”— æ˜ å°„å¯¹ï¼š${src} â†’ ${dst}"
          done

          # é•œåƒå¼•ç”¨è§„èŒƒåŒ–å‡½æ•° (æ”¯æŒè‡ªåŠ¨è¡¥å…¨ docker.io å‰ç¼€)
          normalize_ref() {
            local ref=$1 context=$2
            
            # è‡ªåŠ¨è¡¥å…¨tag
            if [[ "$ref" != *":"* ]]; then
              echo "âš™ï¸  è‡ªåŠ¨è¡¥å…¨ ${ref} çš„æ ‡ç­¾ä¸º :latest"
              ref+=":latest"
            fi
            
            # å¤„ç†ä»“åº“å‰ç¼€
            if [[ "$ref" != *"docker.io"* ]]; then
              if [[ "$context" == "source" && "$ref" == *"/"* ]]; then
                ref="docker.io/$ref"
              else
                ref="docker.io/$DEST_REPO/${ref%:*}"
              fi
            fi
            
            # ä¿®å¤é‡å¤å‰ç¼€
            echo "${ref/docker.io\/docker.io/docker.io}"
          }

          # æ¶æ„æ£€æµ‹å‡½æ•°
          get_arch() {
            local image=$1
            echo "ğŸ”¬ æ­£åœ¨æ£€æµ‹ $image çš„æ¶æ„..."
            
            # è·å–é•œåƒæ¸…å•ä¿¡æ¯
            if ! raw_manifest=$(skopeo inspect --raw --creds "$DOCKERHUB_USER:$DOCKERHUB_TOKEN" "docker://$image" 2>&1); then
              echo "âŒ æ— æ³•è·å–é•œåƒæ¸…å•ï¼š$raw_manifest"
              return 1
            fi
            
            # åˆ¤æ–­æ˜¯å¦ä¸ºå¤šæ¶æ„é•œåƒ
            if jq -e '.manifests' <<< "$raw_manifest" >/dev/null; then
              echo "ğŸ“¦ æ£€æµ‹åˆ°å¤šæ¶æ„é•œåƒ"
              jq -r '[.manifests[].platform | "\(.os)/\(.architecture)\(.variant? | select(. != null) | "/"+.)"] | unique[]' <<< "$raw_manifest" | paste -sd,
              return $?
            else
              # å¤„ç†å•æ¶æ„é•œåƒ
              inspect=$(skopeo inspect --creds "$DOCKERHUB_USER:$DOCKERHUB_TOKEN" "docker://$image")
              os=$(jq -r '.Os // "unknown"' <<< "$inspect")
              arch=$(jq -r '.Architecture // "unknown"' <<< "$inspect")
              variant=$(jq -r '.Variant? // empty' <<< "$inspect")
              
              [[ -n "$variant" ]] && full_arch="$os/$arch/$variant" || full_arch="$os/$arch"
              echo "ğŸ§¬ å•æ¶æ„ä¿¡æ¯ï¼š$full_arch"
              [[ "$os/$arch" != "unknown/unknown" ]] && echo "$full_arch" || echo "unknown"
            fi
          }

          # ä¸»åŒæ­¥å¾ªç¯
          while read -r src_ref; do
            dst_ref="${SYNC_MAP[$src_ref]}"
            
            # æ ‡å‡†åŒ–é•œåƒåœ°å€
            src_image=$(normalize_ref "$src_ref" source)
            dst_image=$(normalize_ref "$dst_ref" target)
            
            echo -e "\n========== åŒæ­¥ä»»åŠ¡ =========="
            echo -e "æºï¼š${COLOR_SRC}$src_image${COLOR_RESET}"
            echo -e "ç›®æ ‡ï¼š${COLOR_DST}$dst_image${COLOR_RESET}"

            # æ¶æ„æ£€æµ‹
            if ! src_arch=$(get_arch "$src_image"); then
              echo "âŒ æºé•œåƒæ¶æ„æ£€æµ‹å¤±è´¥"
              failures+=("$src_image")
              continue
            fi
            echo "ğŸ›ï¸  æºæ¶æ„ï¼š$src_arch"

            # æ‘˜è¦æ£€æŸ¥
            echo "ğŸ” æ£€æŸ¥é•œåƒå·®å¼‚æ€§..."
            src_digest=$(skopeo inspect --creds "$DOCKERHUB_USER:$DOCKERHUB_TOKEN" --format '{{.Digest}}' "docker://$src_image")
            if dst_digest=$(skopeo inspect --creds "$DOCKERHUB_USER:$DOCKERHUB_TOKEN" --format '{{.Digest}}' "docker://$dst_image" 2>/dev/null); then
              echo "ğŸ“Š æ‘˜è¦æ¯”å¯¹ï¼š"
              echo "  SRC: $src_digest"
              echo "  DST: $dst_digest"
              if [[ "$src_digest" == "$dst_digest" ]]; then
                echo "âœ… é•œåƒå†…å®¹ä¸€è‡´ï¼Œè·³è¿‡åŒæ­¥"
                skipped+=("$src_image")
                continue
              fi
            else
              echo "ğŸ†• ç›®æ ‡é•œåƒä¸å­˜åœ¨ï¼Œå¼€å§‹åŒæ­¥..."
            fi

            # æ‰§è¡ŒåŒæ­¥
            echo "ğŸš€ å¼€å§‹åŒæ­¥æ“ä½œ..."
            if skopeo copy --all \
              --src-creds "$DOCKERHUB_USER:$DOCKERHUB_TOKEN" \
              --dest-creds "$DOCKERHUB_USER:$DOCKERHUB_TOKEN" \
              "docker://$src_image" \
              "docker://$dst_image"; then
              echo -e "ğŸ‰ ${COLOR_DST}$dst_image${COLOR_RESET} åŒæ­¥æˆåŠŸï¼"
              successes+=("$src_imageâ†’$dst_image")
            else
              echo -e "ğŸ’¥ ${COLOR_SRC}$src_image${COLOR_RESET} åŒæ­¥å¤±è´¥ï¼"
              failures+=("$src_image")
            fi
          done < <(printf '%s\n' "${!SYNC_MAP[@]}")

          # ç”Ÿæˆç»“æœæŠ¥å‘Š
          echo "NOTIFICATION_CONTENT<<EOF" >> $GITHUB_ENV
          echo "ğŸ“¦ åŒæ­¥ä½œä¸šå®ŒæˆæŠ¥å‘Šï¼š" >> $GITHUB_ENV
          echo "âœ… æˆåŠŸé¡¹ç›® (${#successes[@]})ï¼š" >> $GITHUB_ENV
          printf " - %s\n" "${successes[@]}" >> $GITHUB_ENV
          [[ ${#skipped[@]} -gt 0 ]] && {
            echo "ğŸ”œ è·³è¿‡é¡¹ç›® (${#skipped[@]})ï¼š" >> $GITHUB_ENV
            printf " - %s\n" "${skipped[@]}" >> $GITHUB_ENV
          }
          [[ ${#failures[@]} -gt 0 ]] && {
            echo "âŒ å¤±è´¥é¡¹ç›® (${#failures[@]})ï¼š" >> $GITHUB_ENV
            printf " - %s\n" "${failures[@]}" >> $GITHUB_ENV
          }
          echo "EOF" >> $GITHUB_ENV
          echo "HAS_SUCCESS=$([[ ${#successes[@]} -gt 0 ]] && echo true || echo false)" >> $GITHUB_ENV

      # ç»“æœé€šçŸ¥
      - name: å‘é€é€šçŸ¥
        uses: candies404/Multi-Channel-Notifier@latest
        if: always()  # æ€»æ˜¯å‘é€é€šçŸ¥
        with:
          title: "ğŸ›°ï¸ é•œåƒåŒæ­¥æŠ¥å‘Š"
          content: |
            ${{ env.NOTIFICATION_CONTENT }}
            ğŸ“… æ‰§è¡Œæ—¶é—´ï¼š${{ github.workflow_run.created_at }}
          hitokoto: false
          wpush_key: ${{ secrets.WPUSH_KEY }}
