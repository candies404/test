name: Image Sync with Architecture Validation

on:
  workflow_dispatch:
    inputs:
      mappings:
        description: 'é•œåƒåŒæ­¥æ˜ å°„ï¼ˆæ ¼å¼ï¼šæºé•œåƒ=ç›®æ ‡é•œåƒï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: false

jobs:
  image-sync:
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DEST_REPO: ${{ secrets.DOCKERHUB_USERNAME }}
      BUILDKIT_PROGRESS: plain
      DOCKER_CLI_EXPERIMENTAL: enabled

    steps:
      # æ–°å¢é…ç½®è§£ææ­¥éª¤
      - name: Configure sync mappings
        id: config
        run: |
          # ä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨è¾“å…¥ï¼Œå¦åˆ™ä½¿ç”¨ä»“åº“å˜é‡
          if [[ -n '${{ github.event.inputs.mappings }}' ]]; then
            # å®‰å…¨å¤„ç†è¾“å…¥å‚æ•°ï¼ˆå»é™¤å¤–å›´å•å¼•å·ï¼‰
            cleaned_input=$(echo '${{ github.event.inputs.mappings }}' | sed "s/^['\"]//;s/['\"]$//")
            echo "SYNC_SOURCE=manual" >> $GITHUB_ENV
            echo "DOCKER_SYNC_MAPPINGS=${cleaned_input}" >> $GITHUB_ENV
          else
            # å®‰å…¨å¤„ç†ä»“åº“å˜é‡ï¼ˆå»é™¤å¤–å›´å•å¼•å·ï¼‰
            cleaned_var=$(echo '${{ vars.DOCKER_SYNC_MAPPINGS }}' | sed "s/^['\"]//;s/['\"]$//")
            echo "SYNC_SOURCE=repository" >> $GITHUB_ENV
            echo "DOCKER_SYNC_MAPPINGS=${cleaned_var}" >> $GITHUB_ENV
          fi

      # å‰ç½®æ ¡éªŒæ­¥éª¤
      - name: Validate mappings configuration
        run: |
          if [[ -z "$DOCKER_SYNC_MAPPINGS" || "$DOCKER_SYNC_MAPPINGS" =~ ^[[:space:],]*$ ]]; then
            echo "::error::[é…ç½®æ£€æŸ¥] æ— æ•ˆé…ç½®ï¼Œæ¥æºï¼š$SYNC_SOURCE"
            echo "è¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼æä¾›æœ‰æ•ˆé…ç½®ï¼š"
            echo "1. æ‰‹åŠ¨è§¦å‘æ—¶è¾“å…¥ mappings å‚æ•°"
            echo "2. åœ¨ä»“åº“å˜é‡ä¸­è®¾ç½® DOCKER_SYNC_MAPPINGS"
            exit 1
          fi
          echo "æœ‰æ•ˆé…ç½®å†…å®¹: [${DOCKER_SYNC_MAPPINGS}]"

      - name: Setup build environment
        uses: docker/setup-buildx-action@v3
        with:
          install: true
          driver-opts: network=host

      - name: Install system dependencies
        run: |
          echo "ğŸ› ï¸ Installing required tools..."
          sudo apt-get update && sudo apt-get install -y skopeo jq
          echo "âœ… Dependencies installed"

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USER }}
          password: ${{ env.DOCKERHUB_TOKEN }}
        env:
          DOCKER_REGISTRY: index.docker.io

      - name: Execute image synchronization
        run: |
          #!/usr/bin/env bash
          set -euo pipefail

          # é¢œè‰²å®šä¹‰
          readonly COLOR_RESET="\033[0m"
          readonly COLOR_SRC="\033[1;34m"
          readonly COLOR_DST="\033[1;35m"
          readonly COLOR_OK="\033[1;32m"
          readonly COLOR_WARN="\033[1;33m"
          readonly COLOR_ERR="\033[1;31m"

          # æ—¥å¿—å‡½æ•°
          log() {
            local level=$1
            local message=$2
            local timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            case $level in
              "INFO") echo -e "${COLOR_OK}[${timestamp}] INFO: ${message}${COLOR_RESET}" ;;
              "WARN") echo -e "${COLOR_WARN}[${timestamp}] WARN: ${message}${COLOR_RESET}" ;;
              "ERROR") echo -e "${COLOR_ERR}[${timestamp}] ERROR: ${message}${COLOR_RESET}" ;;
            esac
          }

          # å­—ç¬¦ä¸²æ¸…ç†å‡½æ•°
          trim_string() {
            local str="$*"
            str="${str#"${str%%[![:space:]]*}"}"  # ç§»é™¤å‰å¯¼ç©ºæ ¼
            str="${str%"${str##*[![:space:]]}"}"  # ç§»é™¤å°¾éƒ¨ç©ºæ ¼
            echo -n "$str"
          }

          # é…ç½®è§£æé€»è¾‘
          log "INFO" "å¼€å§‹è§£æåŒæ­¥é…ç½®ï¼ˆæ¥æºï¼š$SYNC_SOURCEï¼‰"
          declare -A SYNC_MAP

          # æ•°æ®é¢„å¤„ç†
          cleaned_input=$(
            echo "$DOCKER_SYNC_MAPPINGS" \
            | tr '\n' ','                 `# æ¢è¡Œç¬¦è½¬é€—å·` \
            | sed 's/,+/,/g'              `# åˆå¹¶è¿ç»­é€—å·` \
            | sed -e 's/^,*//' -e 's/,*$//'  # å»é™¤é¦–å°¾é€—å·
          )

          IFS=',' read -ra entries <<< "$cleaned_input"
          valid_count=0

          for entry in "${entries[@]}"; do
            entry=$(trim_string "$entry")
            if [[ -z "$entry" ]]; then continue; fi

            IFS='=' read -r key value <<< "$entry"
            key=$(trim_string "$key")
            value=$(trim_string "$value")

            # é”®å€¼å¯¹éç©ºæ ¡éªŒ
            if [[ -z "$key" || -z "$value" ]]; then
              log "WARN" "å¿½ç•¥æ— æ•ˆæ¡ç›®: '${entry}'"
              continue
            fi

            # æºé•œåƒæ ‡ç­¾æ ¡éªŒ
            if [[ "$key" =~ : ]]; then
              src_tag="${key#*:}"
              if [[ "$src_tag" =~ [/\\\'\"] ]]; then
                log "WARN" "æ¡ç›®åŒ…å«éæ³•å­—ç¬¦: '${entry}'"
                continue
              fi
            fi

            # é«˜å±å­—ç¬¦è¿‡æ»¤ï¼ˆå®ˆæŠ¤ä»£ç å®‰å…¨ï¼‰
            if [[ "$key" =~ [\'\"\\] ]] || [[ "$value" =~ [\'\"\\] ]]; then
              log "WARN" "æ£€æµ‹åˆ°å±é™©å­—ç¬¦ï¼Œè·³è¿‡æ¡ç›®: '${entry}'"
              continue
            fi

            SYNC_MAP["$key"]="$value"
            ((valid_count++))
            log "INFO" "æœ‰æ•ˆæ˜ å°„: ${COLOR_SRC}${key}${COLOR_RESET} â†’ ${COLOR_DST}${value}${COLOR_RESET}"
          done

          # æœ€ç»ˆæœ‰æ•ˆæ€§æ£€æŸ¥
          if [[ $valid_count -eq 0 ]]; then
            log "ERROR" "æ²¡æœ‰æœ‰æ•ˆåŒæ­¥æ¡ç›®"
            echo "åŸå§‹è¾“å…¥å†…å®¹ â†’ [$DOCKER_SYNC_MAPPINGS]"
            exit 1
          fi

          normalize_image() {
            local image_ref=$1 default_tag=$2 context=$3
            if [[ "$image_ref" == *":"* ]]; then
              local image_name="${image_ref%:*}" image_tag="${image_ref#*:}"
            else
              local image_name="$image_ref" image_tag="$default_tag"
            fi
            case $context in
              "source") 
                if [[ "$image_name" == *"/"* ]]; then
                  printf "docker.io/%s:%s" "$image_name" "$image_tag"
                else
                  printf "docker.io/library/%s:%s" "$image_name" "$image_tag"
                fi ;;
              "target") printf "docker.io/%s/%s:%s" "$DEST_REPO" "$image_name" "$image_tag" ;;
              *) log "ERROR" "æ— æ•ˆä¸Šä¸‹æ–‡å‚æ•°: $context"; exit 1 ;;
            esac
          }

          get_architecture() {
            local image=$1
            log "INFO" "è·å–æ¶æ„ä¿¡æ¯ï¼š${COLOR_SRC}$image${COLOR_RESET}"

            # ================== æ ¸å¿ƒä¿®æ­£ç‚¹ ===================
            # æ—§æ¡ä»¶ï¼š.manifests != null and (.mediaType | contains("manifest.list"))
            # æ–°æ¡ä»¶ï¼šä»…æ£€æŸ¥æ˜¯å¦å­˜åœ¨ manifests æ•°ç»„
            if raw_manifest=$(skopeo inspect --raw --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" "docker://$image" 2>&1) &&
              jq -e '.manifests != null' <<< "$raw_manifest" &>/dev/null; then
            # ================== ä¿®æ­£å®Œæˆ ====================

              local arch_list=$(jq -r '
                [.manifests[].platform |
                  select(.os != "unknown" and .architecture != "unknown") |
                  "\(.os)/\(.architecture)\(if .variant != "" then "/"+.variant else "" end)"
                ] | unique | join(", ")' <<< "$raw_manifest")

              [[ -z "$arch_list" ]] && { log "ERROR" "æ— æœ‰æ•ˆæ¶æ„ä¿¡æ¯"; return 1; }
              log "INFO" "æ£€æµ‹åˆ°å¤šæ¶æ„é•œåƒï¼š${arch_list// /,}"
              echo "$arch_list"
              return 0
            else
              local inspect_info=$(skopeo inspect --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" "docker://$image" 2>/dev/null)
              local os=$(jq -r '.Os // "unknown"' <<< "$inspect_info")
              local arch=$(jq -r '.Architecture // "unknown"' <<< "$inspect_info")
              local variant=$(jq -r '.Variant? // ""' <<< "$inspect_info")

              [[ "$os" == "unknown" || "$arch" == "unknown" ]] && {
                log "INFO" "å•æ¶æ„é•œåƒï¼šunknown"
                echo "unknown"; return 0
              }

              local result="${os}/${arch}"
              [[ -n "$variant" ]] && result+="/$variant"
              case "$arch" in
                "arm64") result="linux/arm64/v8" ;;
                "arm") [[ "$variant" == "v7" ]] && result="linux/arm/v7" ;;
              esac
              log "INFO" "å•æ¶æ„é•œåƒï¼š$result"
              echo "$result"
            fi
          }

          sync_image() {
            local src=$1 dst=$2
            log "INFO" "å¯åŠ¨åŒæ­¥ï¼š${COLOR_SRC}$src${COLOR_RESET} â†’ ${COLOR_DST}$dst${COLOR_RESET}"
            
            # åŒæ­¥æ¨¡å¼åˆ¤æ–­è”åŠ¨ä¿®å¤
            if skopeo inspect --raw --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" "docker://$src" |
               jq -e '.manifests != null' &>/dev/null; then
              log "INFO" "ä½¿ç”¨å¤šæ¶æ„åŒæ­¥æ¨¡å¼"
              docker buildx imagetools create -t "$dst" "$src" || {
                log "ERROR" "å¤šæ¶æ„åŒæ­¥å¤±è´¥"; return 1
              }
            else
              docker pull --quiet "$src" || { log "ERROR" "é•œåƒæ‹‰å–å¤±è´¥"; return 1; }
              docker tag "$src" "$dst" || { log "ERROR" "æ ‡ç­¾è®¾ç½®å¤±è´¥"; return 1; }
              docker push --quiet "$dst" || { log "ERROR" "æ¨é€å¤±è´¥"; return 1; }
            fi
            log "INFO" "åŒæ­¥å®Œæˆ"
          }


          # å¤„ç†åŒæ­¥å¾ªç¯
          for source_ref in "${!SYNC_MAP[@]}"; do
            echo "::group::ğŸ”„ Processing $source_ref"
            src_image=$(normalize_image "$source_ref" "latest" "source")
            dst_ref="${SYNC_MAP[$source_ref]}"
            dst_image=$(normalize_image "$dst_ref" "$(cut -d: -f2 <<< "$src_image")" "target")
            
            # æ–°å¢è¾“å‡ºè¿‡æ»¤ â†“ ç¡®ä¿æ•è·æ­£ç¡®æ¶æ„ä¿¡æ¯
            src_arch=$(get_architecture "$src_image" | tail -1)
            if target_info=$(skopeo inspect --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" "docker://$dst_image" 2>/dev/null); then
              dst_arch=$(get_architecture "$dst_image" | tail -1)
              dst_exists=true
            else
              dst_arch="N/A"
              dst_exists=false
            fi

            echo -e "\n${COLOR_OK}æ¶æ„å¯¹æ¯”æŠ¥å‘Šï¼š${COLOR_RESET}"
            # ä½¿ç”¨ column æ ¼å¼åŒ–è¾“å‡º â†“
            # paste <(echo "æºæ¶æ„" "$src_arch") <(echo "ç›®æ ‡æ¶æ„" "$dst_arch") | 
            # column -t -s $'\t' -o " â”‚ "
            # echo

            src_digest=$(skopeo inspect --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" --format '{{.Digest}}' "docker://$src_image")
            if $dst_exists && [[ "$(jq -r '.Digest' <<< "$target_info")" == "$src_digest" ]]; then
              log "INFO" "ç›®æ ‡é•œåƒå·²æ˜¯æœ€æ–°ï¼Œè·³è¿‡åŒæ­¥"
              echo "::endgroup::"
              continue
            fi
            sync_image "$src_image" "$dst_image"
            echo "::endgroup::"
          done
