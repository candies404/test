name: Docker é•œåƒåŒæ­¥

on:
  workflow_dispatch:
    inputs:
      sync_mappings:
        description: 'é•œåƒåŒæ­¥æ˜ å°„ï¼ˆæ ¼å¼ï¼šæºé•œåƒ=ç›®æ ‡é•œåƒï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰'
        required: false

jobs:
  image-sync:
    name: é•œåƒåŒæ­¥
    runs-on: ubuntu-latest
    env:
      DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      DEST_REPO: ${{ secrets.DOCKERHUB_USERNAME }}
      DOCKER_SYNC_MAPPINGS: ${{ vars.DOCKER_SYNC_MAPPINGS }}
      BUILDKIT_PROGRESS: plain

    steps:
      - name: éªŒè¯é•œåƒåŒæ­¥æ ¼å¼
        id: validate-mappings
        run: |
          # ä¼˜å…ˆä½¿ç”¨æ‰‹åŠ¨è¾“å…¥
          if [ -n "${{ github.event.inputs.sync_mappings }}" ]; then
            PROCESSED_MAPPINGS="${{ github.event.inputs.sync_mappings }}"
          else
            PROCESSED_MAPPINGS="$DOCKER_SYNC_MAPPINGS"
          fi

          # å¼ºåŒ–å¤„ç†æ ¼å¼
          CLEAN_MAPPINGS=$(echo "$PROCESSED_MAPPINGS" \
            | tr -d '\n' \
            | tr -s ' ' \
            | sed -E -e 's/[[:space:]]//g' \
                     -e 's/,{2,}/,/g' \
                     -e 's/^,//' \
                     -e 's/,$//')

          if [ -z "$CLEAN_MAPPINGS" ]; then
            echo "::error::æœªé…ç½®åŒæ­¥æ˜ å°„"
            exit 1
          fi

          IFS=',' read -r -a MAPPING_PAIRS <<< "$CLEAN_MAPPINGS"
          INVALID_COUNT=0

          for PAIR in "${MAPPING_PAIRS[@]}"; do
            if ! grep -qE '^[^=]+=[^=]+$' <<< "$PAIR"; then
              echo "::error::æ˜ å°„è¯­æ³•é”™è¯¯: '$PAIR' (æ­£ç¡®æ ¼å¼: æºé•œåƒ=ç›®æ ‡é•œåƒ)"
              ((INVALID_COUNT++))
            fi
          done

          [ $INVALID_COUNT -gt 0 ] && exit 1
          echo "SYNC_MAPPINGS=${CLEAN_MAPPINGS}" >> $GITHUB_ENV

      - name: è®¾ç½®å¤šæ¶æ„æ„å»ºç¯å¢ƒ
        uses: docker/setup-buildx-action@v3
        with:
          install: true
          driver-opts: |
            network=host
            image=moby/buildkit:master-rootless
        env:
          DOCKER_CLI_EXPERIMENTAL: enabled

      - name: å®‰è£… skopeo
        run: |
          echo "ğŸ› ï¸ æ­£åœ¨å®‰è£… skopeo..."
          sudo apt-get update -qq && sudo apt-get install -y skopeo
          echo "âœ… skopeo $(skopeo --version | awk '{print $3}') å®‰è£…å®Œæˆ"

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ env.DOCKERHUB_USER }}
          password: ${{ env.DOCKERHUB_TOKEN }}

      - name: æ‰§è¡Œé•œåƒåŒæ­¥
        id: sync
        run: |
          #!/usr/bin/env bash
          set -eo pipefail
          shopt -s inherit_errexit

          # æ—¥å¿—ç³»ç»Ÿé…ç½®
          declare -A LOG_COLORS=([INFO]="\033[1;32m" [WARN]="\033[1;33m" [ERROR]="\033[1;31m")
          log() {
            local level="${1}" message="${2}" timestamp=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
            echo -e "${LOG_COLORS[$level]}[${timestamp}] ${level}: ${message}\033[0m" >&2
          }

          # åŒæ­¥çŠ¶æ€è¿½è¸ª
          declare -A SYNC_STATS=([TOTAL]=0 [SUCCESS]=0 [SKIPPED]=0 [FAILED]=0)
          SYNC_DETAILS=()

          # æ¶æ„æ£€æµ‹é€»è¾‘
          get_architecture() {
            local image="${1}"
            local raw_info=$(skopeo inspect --raw --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" "docker://${image}" 2>/dev/null || echo "{}")
            
            echo "$raw_info" | jq -r '
              if .manifests? then
                [.manifests[].platform |
                  select((.os != "unknown") and (.architecture != "unknown")) |
                  "\(.os)/\(.architecture)" + 
                  (if .variant? and (.variant != "") and (.variant != null) then "/\(.variant)" else "" end)
                ] | 
                unique | 
                join(",")
              else
                ( [.Os, .Architecture, .Variant // ""] |
                  map(select(. != "unknown" and . != null and . != "")) |
                  if length >= 2 then
                    (.[0] + "/" + .[1] + 
                     (if (length >=3) and (.[2] != "") then "/\(.[2])" else "" end))
                  else
                    "æœªæ£€æµ‹å‡ºæ¶æ„ä¿¡æ¯"
                  end
                )
              end' 2>/dev/null || echo "è§£æå¤±è´¥"
          }

          # é•œåƒæ­£è§„åŒ–å¤„ç†
          normalize_image() {
            local ref="${1}" default_tag="${2}" context="${3}"
            if [[ ! "$ref" == *":"* ]]; then
              ref="${ref}:${default_tag}"
            fi
            case "$context" in
              "source") 
                [[ "$ref" != */* ]] && ref="library/${ref}"
                echo "docker.io/${ref}"
                ;;
              "target") 
                [[ "$ref" != */* ]] && ref="${DEST_REPO}/${ref}"
                echo "docker.io/${ref}"
                ;;
            esac
          }

          # æ¶æ„æ¯”è¾ƒé€»è¾‘
          compare_architectures() {
            local src="${1}" dst="${2}"
            local src_arch=$(get_architecture "$src")
            local dst_arch=$(get_architecture "$dst" 2>/dev/null || echo "")
            
            # ç‰¹æ®Šå¼‚å¸¸å¤„ç†
            if [[ "$src_arch" == "æœªæ£€æµ‹å‡ºæ¶æ„ä¿¡æ¯" || "$dst_arch" == "æœªæ£€æµ‹å‡ºæ¶æ„ä¿¡æ¯" ]]; then
              log WARN "æ¶æ„ä¿¡æ¯ç¼ºå¤±ï¼Œå¼ºåˆ¶æ‰§è¡ŒåŒæ­¥"
              return 1
            fi
            [[ "$src_arch" == "$dst_arch" ]]
          }

          # æ ¸å¿ƒåŒæ­¥æµç¨‹
          process_mapping() {
            local src_ref="${1}" dst_ref="${2}"
            log INFO "ğŸ”ƒ å¼€å§‹å¤„ç†ï¼š${src_ref} â†’ ${dst_ref}"
            
            # é•œåƒæ­£è§„åŒ–
            src_image=$(normalize_image "$src_ref" "latest" "source")
            dst_image=$(normalize_image "$dst_ref" "$(cut -d: -f2 <<< "$src_image")" "target")
            
            # ç›®æ ‡é•œåƒå­˜åœ¨æ€§æ£€æŸ¥
            if skopeo inspect --creds "${DOCKERHUB_USER}:${DOCKERHUB_TOKEN}" "docker://${dst_image}" >/dev/null 2>&1; then
              if compare_architectures "$src_image" "$dst_image"; then
                log INFO "â­ï¸ é•œåƒæ¶æ„ä¸€è‡´ï¼Œè·³è¿‡åŒæ­¥"
                SYNC_STATS[SKIPPED]=$((SYNC_STATS[SKIPPED]+1))
                SYNC_DETAILS+=("â© å·²è·³è¿‡: ${src_ref} â†’ ${dst_ref}")
                return
              fi
            else
              log INFO "âš ï¸ ç›®æ ‡é•œåƒä¸å­˜åœ¨ï¼Œéœ€è¦åŒæ­¥"
            fi

            # åŒæ­¥æ“ä½œï¼ˆæœ€å¤šå°è¯•3æ¬¡ï¼‰
            for attempt in {1..3}; do
              log INFO "ğŸ”„ åŒæ­¥å°è¯• #${attempt}"
              if docker buildx imagetools create -t "${dst_image}" "${src_image}"; then
                SYNC_STATS[SUCCESS]=$((SYNC_STATS[SUCCESS]+1))
                SYNC_DETAILS+=("âœ… åŒæ­¥æˆåŠŸ: ${src_ref} â†’ ${dst_ref}")
                log INFO "âœ… å®ŒæˆåŒæ­¥ï¼ˆç¬¬${attempt}æ¬¡å°è¯•ï¼‰"
                return
              else
                SYNC_STATS[FAILED]=$((SYNC_STATS[FAILED]+1))
                log WARN "â›”ï¸ ç¬¬${attempt}æ¬¡åŒæ­¥å¤±è´¥ï¼Œ5ç§’åé‡è¯•..."
                sleep 5
              fi
            done
            SYNC_DETAILS+=("âŒ åŒæ­¥å¤±è´¥: ${src_ref} â†’ ${dst_ref}")
            log ERROR "âŒ è¶…å‡ºæœ€å¤§é‡è¯•æ¬¡æ•°"
          }

          # ä¸»å¤„ç†å¾ªç¯
          echo "=== å¼€å§‹å¤„ç†é•œåƒåŒæ­¥ä»»åŠ¡ ==="
          IFS=',' read -ra mappings <<< "${SYNC_MAPPINGS}"
          SYNC_STATS[TOTAL]=${#mappings[@]}
          for pair in "${mappings[@]}"; do
            IFS='=' read -r src dst <<< "$pair"
            process_mapping "$src" "$dst"
          done

          # ç”ŸæˆæŠ¥å‘Š
          report_content="ğŸ“ˆ é•œåƒåŒæ­¥æŠ¥å‘Š\n"
          report_content+="------------------------------------\n"
          report_content+="æ€»ä»»åŠ¡æ•°ï¼š${SYNC_STATS[TOTAL]}\n"
          report_content+="æˆåŠŸæ¬¡æ•°ï¼š${SYNC_STATS[SUCCESS]}\n"
          report_content+="è·³è¿‡æ¬¡æ•°ï¼š${SYNC_STATS[SKIPPED]}\n"
          report_content+="å¤±è´¥æ¬¡æ•°ï¼š${SYNC_STATS[FAILED]}\n\n"
          report_content+="è¯¦ç»†æ‰§è¡Œç»“æœï¼š\n"
          report_content+=$(printf "%s\n" "${SYNC_DETAILS[@]}")

          echo "NOTIFICATION_CONTENT<<EOF
          $report_content
          EOF" >> $GITHUB_ENV

      - name: å‘é€é€šçŸ¥
        uses: candies404/Multi-Channel-Notifier@latest
        if: always()
        with:
          title: "ğŸ—ï¸ Docker é•œåƒåŒæ­¥æŠ¥å‘Š"
          content: ${{ env.NOTIFICATION_CONTENT }}
          wpush_key: ${{ secrets.WPUSH_KEY }}
