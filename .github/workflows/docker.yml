name: Docker Image Sync

on:
  workflow_dispatch:

jobs:
  sync-images:
    runs-on: ubuntu-latest

    steps:
    - name: Install tools
      run: |
        sudo apt-get update
        sudo apt-get install -y skopeo

    - name: Sync images to Docker Hub
      env:
        DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
      run: |
        # å®šä¹‰é•œåƒæ˜ å°„è§„åˆ™
        declare -A image_map=(
          ["nginx"]="nginx-m"
          ["redis:7.0"]="redis:7"
          ["chipsman/uptime-kuma"]="uptime-kuma-back"
          ["chipsman/one-hub"]="one-hub"
        )

        # æºé•œåƒåˆ—è¡¨
        IMAGES=("nginx" "redis:7.0" "chipsman/uptime-kuma" "chipsman/one-hub")

        # Docker Hub ç™»å½•
        echo "$DOCKERHUB_TOKEN" | docker login -u $DOCKERHUB_USERNAME --password-stdin docker.io

        # é•œåƒåŒæ­¥å¤„ç†
        for image in "${IMAGES[@]}"; do
          # æ£€æŸ¥æ˜ å°„è§„åˆ™æ˜¯å¦å­˜åœ¨
          if [[ -z "${image_map[$image]}" ]]; then
            echo "âš ï¸ æœªæ‰¾åˆ°æ˜ å°„è§„åˆ™: $imageï¼Œè·³è¿‡..."
            continue
          fi

          # è§£ææºé•œåƒ
          if [[ "$image" == *":"* ]]; then
            src_repo="${image%:*}"
            src_tag="${image#*:}"
          else
            src_repo="$image"
            src_tag="latest"
          fi

          # è§£æç›®æ ‡æ˜ å°„
          target="${image_map[$image]}"
          if [[ "$target" == *":"* ]]; then
            tgt_repo="${target%:*}"
            tgt_tag="${target#*:}"
          else
            tgt_repo="$target"
            tgt_tag="$src_tag"
          fi

          # æ„å»ºå®Œæ•´é•œåƒåœ°å€
          src_full="docker://$image"
          tgt_full="docker.io/$DOCKERHUB_USERNAME/$tgt_repo:$tgt_tag"

          # æ‰§è¡ŒåŒæ­¥æ“ä½œ
          echo "ğŸ”„ æ­£åœ¨åŒæ­¥: $src_full â†’ $tgt_full"
          docker buildx imagetools create -t "$tgt_full" "$src_full"
          
          # æ·»åŠ çŠ¶æ€æ ‡è®°
          if [ $? -eq 0 ]; then
            echo "âœ… åŒæ­¥æˆåŠŸ"
          else
            echo "âŒ åŒæ­¥å¤±è´¥"
          fi
          echo "----------------------------------------"
        done

        echo "ğŸ‰ æ‰€æœ‰é•œåƒåŒæ­¥å®Œæˆï¼"
