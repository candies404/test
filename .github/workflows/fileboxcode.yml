name: æ›¿æ¢FileCodeBox å¯†ç 

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘

jobs:
  change-filecodebox-password:
    name: ä¿®æ”¹FileCodeBox é»˜è®¤å¯†ç 
    runs-on: ubuntu-latest

    steps:
      # æ­¥éª¤ 1: å…‹éš†ä»“åº“ + è·å–æäº¤æ—¥æœŸå’ŒçŸ­ SHA
      - name: å…‹éš†ä»“åº“å¹¶ç”Ÿæˆæäº¤æ—¶é—´æ ‡è¯†
        id: clone-and-tag
        run: |
          git clone https://github.com/vastsa/FileCodeBox.git external-repo
          cd external-repo

          # è·å–ä»“åº“æœ€æ–°æäº¤çš„çŸ­ SHA (e.g. 3da8a75)
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "SHORT_SHA= $SHORT_SHA" 
          
          # è·å–æœ€æ–°æäº¤çš„æ—¥æœŸ (æ ¼å¼: YYYY-MM-DD)
          COMMIT_DATE=$(git log -1 --format="%cd" --date=short)
          echo "COMMIT_DATE= $COMMIT_DATE"

          # åˆå¹¶ä¸ºæ—¥æœŸ + çŸ­ SHA (e.g. 2025-01-13-3da8a75)
          DATE_SHORT_SHA="${COMMIT_DATE}-${SHORT_SHA}"
          echo "ğŸ•’ ä»“åº“æäº¤æ ‡è¯†: $DATE_SHORT_SHA"

          # è¾“å‡ºå˜é‡ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "date_short_sha=$DATE_SHORT_SHA" >> $GITHUB_OUTPUT

      # æ­¥éª¤ 2: æ›¿æ¢æ•æ„Ÿé…ç½®
      - name: æ›¿æ¢ admin_token
        env:
          NEW_TOKEN: ${{ vars.FileCodeBox_PassWord }}  # å¿…é¡»ä½¿ç”¨ secrets
        run: |
          cd external-repo/core
          # æ›¿æ¢ Token å¹¶éªŒè¯æ–‡ä»¶
          sed -i "s#\"admin_token\": \"FileCodeBox2023\"#\"admin_token\": \"$NEW_TOKEN\"#" settings.py
          echo "âœ… å·²å®Œæˆ admin_token æ›¿æ¢"
          cat settings.py | grep "admin_token"  # æ˜¾ç¤ºæ›¿æ¢ç»“æœ

      # æ­¥éª¤ 3-5: Docker é•œåƒæ„å»ºé€»è¾‘
      - name: åˆå§‹åŒ– Docker æ„å»ºç¯å¢ƒ
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½•åˆ° Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./external-repo
          tags: |    # åŠ¨æ€æ ‡ç­¾ç¤ºä¾‹: DOCKERHUB_USERNAME/filecodebox:2025-01-13-3da8a75
            ${{ secrets.DOCKERHUB_USERNAME }}/filecodebox:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/filecodebox:${{ steps.clone-and-tag.outputs.date_short_sha }}
          push: true
          cache-from: type=gha
          cache-to: type=gha,mode=max
