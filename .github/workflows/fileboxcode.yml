name: æ›¿æ¢ FileCodeBox å¯†ç  æ„å»ºé•œåƒ

on:
  workflow_dispatch:

jobs:
  check-image-existence:
    name: æ ¡éªŒ FileCodeBox é•œåƒå­˜åœ¨æ€§
    runs-on: ubuntu-latest
    outputs:
      image_exists: ${{ steps.docker-check.outputs.image_exists }}
      date_short_sha: ${{ steps.get-tag.outputs.date_short_sha }}
    steps:
      - name: å…‹éš†ä»“åº“è·å–æ ‡è¯†
        id: get-tag
        run: |
          git clone --depth=1 https://github.com/vastsa/FileCodeBox.git external-repo
          cd external-repo

          # è·å–ä»“åº“æœ€æ–°æäº¤çš„çŸ­ SHA (e.g. 3da8a75)
          SHORT_SHA=$(git rev-parse --short HEAD)
          echo "SHORT_SHA= $SHORT_SHA" 
          
          # è·å–æœ€æ–°æäº¤çš„æ—¥æœŸ (æ ¼å¼: YYYY-MM-DD)
          COMMIT_DATE=$(git log -1 --format="%cd" --date=short)
          echo "date_short_sha=$COMMIT_DATE-$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "ğŸ†” å½“å‰æ ‡è¯†ï¼š$COMMIT_DATE-$SHORT_SHA"

      - name: Docker Hubæ ‡ç­¾æ£€æŸ¥ï¼ˆCURLåŸç”Ÿå®ç°ï¼‰
        id: docker-check
        env:
            DOCKER_USER: ${{ secrets.DOCKERHUB_USERNAME }}
            DOCKER_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
            TAG="${{ steps.get-tag.outputs.date_short_sha}}"
            echo "ğŸ“¡ å¼€å§‹æ£€æŸ¥æ ‡ç­¾: $TAG"

            # è¯·æ±‚Docker Hub APIéªŒè¯æ ‡ç­¾å­˜åœ¨æ€§
            RESPONSE_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: Bearer $DOCKER_TOKEN" \
            "https://hub.docker.com/v2/namespaces/$DOCKER_USER/repositories/filecodebox/tags/$TAG/")

            # æ£€æŸ¥è¿”å›çŠ¶æ€ç 
            if [ "$RESPONSE_CODE" = "200" ]; then
            echo "âœ… æ ‡ç­¾å·²å­˜åœ¨äºDocker Hub"
            echo "image_exists=true" >> $GITHUB_OUTPUT
            elif [ "$RESPONSE_CODE" = "404" ]; then
            echo "ğŸ†• æœªæ‰¾åˆ°æ ‡ç­¾ï¼Œéœ€æ„å»ºæ–°é•œåƒ"
            echo "image_exists=false" >> $GITHUB_OUTPUT
            else
            echo "âŒ æ£€æŸ¥æ—¶å‘ç”Ÿé”™è¯¯ (HTTP $RESPONSE_CODE)"
            exit 1
            fi

  build-and-push:
    name: å¤šæ¶æ„æ„å»ºæ¨é€ FileCodeBox é•œåƒ
    needs: check-image-existence
    # if: ${{ needs.check-image-existence.outputs.image_exists == 'false' }}
    runs-on: ubuntu-latest
    steps:
      - name: å…‹éš†ä»“åº“
        uses: actions/checkout@v4
        with:
          repository: vastsa/FileCodeBox
          path: external-repo

      - name: å†™å…¥ç¯å¢ƒå˜é‡é…ç½®
        env:
          SETTINGS_PY: ${{ vars.FILECODEBOX_SETTINGS }}
        run: |
          mkdir -p external-repo/core
          echo "$SETTINGS_PY" > external-repo/core/settings.py
          echo "âœ… å·²ä»ç¯å¢ƒå˜é‡å†™å…¥ settings.py"
          cat settings.py

      - name: åˆå§‹åŒ–è·¨å¹³å°æ„å»ºç¯å¢ƒ
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: |
            image=moby/buildkit:master
          platforms: linux/amd64,linux/arm64

      - name: Docker Hub ç™»å½•
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: å¹¶è¡Œæ„å»ºæ¨é€å¤šæ¶æ„é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./external-repo
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/filecodebox:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/filecodebox:${{ needs.check-image-existence.outputs.date_short_sha }}
          push: true
          build-args: |
            BUILDKIT_INLINE_CACHE=1
          cache-from: type=gha
          cache-to: type=gha,mode=max
