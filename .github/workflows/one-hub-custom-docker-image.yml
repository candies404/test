name: Multi-Image Architecture Check

on:
  workflow_dispatch:

jobs:
  check-arch:
    runs-on: ubuntu-latest
    steps:
      - name: Check architectures
        run: |
          #!/bin/bash
          set -eo pipefail

          IMAGES=("nginx" "redis:7.0" "chipsman/uptime-kuma:latest")
          
          for FULL_IMAGE in "${IMAGES[@]}"; do
          (
            echo "â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„â–„"
            echo "  å¤„ç†é•œåƒ: $FULL_IMAGE"
            echo "â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€â–€"

            # Split image into repo and tag
            if [[ "$FULL_IMAGE" == *":"* ]]; then
              REPOSITORY="${FULL_IMAGE%:*}"
              TAG="${FULL_IMAGE#*:}"
            else
              REPOSITORY="$FULL_IMAGE"
              TAG="latest"
            fi

            # Step 1: Get Docker registry token
            TOKEN=$(curl -s "https://auth.docker.io/token?service=registry.docker.io&scope=repository:${REPOSITORY}:pull" | jq -r '.token')
            [[ -z "$TOKEN" ]] && { echo "âŒ æ— æ³•è·å–è®¿é—®ä»¤ç‰Œ"; exit 1; }
            echo "::add-mask::$TOKEN"

            # Step 2: Get image manifest
            MANIFEST_HEADER="Accept: application/vnd.docker.distribution.manifest.list.v2+json, application/vnd.docker.distribution.manifest.v2+json"
            MANIFEST_JSON=$(curl -sf -H "Authorization: Bearer $TOKEN" -H "$MANIFEST_HEADER" \
              "https://registry-1.docker.io/v2/${REPOSITORY}/manifests/${TAG}")

            # Step 3: Detect manifest type
            MANIFEST_TYPE=$(jq -r '.mediaType' <<< "$MANIFEST_JSON")
            
            # Case 1: Multi-architecture manifest list
            if [[ "$MANIFEST_TYPE" == "application/vnd.docker.distribution.manifest.list.v2+json" ]]; then
              ARCHITECTURES=$(jq -r '
                [.manifests[].platform | 
                "\(.os // "unknown")/\(.architecture // "unknown")\(if .variant then "/\(.variant)" else "" end)"
                ] | unique | join(", ")' <<< "$MANIFEST_JSON")
              
              echo "é•œåƒåç§°: $FULL_IMAGE"
              echo "æ¶æ„ç±»å‹: å¤šæ¶æ„ ğŸ”„"
              echo "æ”¯æŒæ¶æ„: $ARCHITECTURES"

            # Case 2: Single-architecture image
            else
              # Get config digest for single arch
              CONFIG_DIGEST=$(jq -r '.config.digest' <<< "$MANIFEST_JSON")
              [[ "$CONFIG_DIGEST" == "null" ]] && { echo "âŒ æ‰¾ä¸åˆ°é…ç½®æ‘˜è¦"; exit 1; }

              # Get detailed config info
              CONFIG_JSON=$(curl -s -H "Authorization: Bearer $TOKEN" \
                "https://registry-1.docker.io/v2/${REPOSITORY}/blobs/${CONFIG_DIGEST}")

              # Parse architecture info
              OS=$(jq -r '.os // "linux"' <<< "$CONFIG_JSON")
              ARCH=$(jq -r '.architecture // "unknown"' <<< "$CONFIG_JSON")
              VARIANT=$(jq -r '.variant // ""' <<< "$CONFIG_JSON")
              
              FULL_ARCH="${OS}/${ARCH}"
              [[ -n "$VARIANT" ]] && FULL_ARCH+="/${VARIANT}"
              
              echo "é•œåƒåç§°: $FULL_IMAGE"
              echo "æ¶æ„ç±»å‹: å•æ¶æ„ ğŸ¯"
              echo "ç³»ç»Ÿæ¶æ„: $FULL_ARCH"
            fi

            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          ) || echo "âš ï¸ é•œåƒå¤„ç†å¤±è´¥: $FULL_IMAGE"
          done
