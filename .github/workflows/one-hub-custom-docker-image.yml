name: 检测镜像架构类型

on:
  workflow_dispatch:

jobs:
  check-architectures:
    runs-on: ubuntu-latest  # 使用 Ubuntu 最新版本作为运行环境

    steps:
    - name: 安装 skopeo
      run: |
        sudo apt-get update
        sudo apt-get install -y skopeo  # 安装 skopeo 工具

    - name: 检测镜像架构
      run: |
        # 定义需要检测的镜像列表
        IMAGES=("nginx" "redis:7.0" "chipsman/uptime-kuma")

        for IMAGE in "${IMAGES[@]}"; do
          echo "正在检测镜像: $IMAGE"
          OUTPUT=$(skopeo inspect --raw docker://$IMAGE)  # 获取镜像元数据

          # 判断是否为多架构镜像
          if echo "$OUTPUT" | grep -q '"manifests":'; then
            echo "$IMAGE 是多架构镜像"
            # 提取并打印所有支持的架构
            ARCHITECTURES=$(echo "$OUTPUT" | jq -r '.manifests[].platform.architecture' | sort | uniq | tr '\n' ', ')
            echo "支持的架构类型: ${ARCHITECTURES%, }"
          else
            echo "$IMAGE 是单架构镜像"
            # 提取单架构镜像的架构类型
            ARCHITECTURE=$(echo "$OUTPUT" | jq -r '.architecture')
            echo "架构类型: $ARCHITECTURE"
          fi
          echo "----------------------------------------"
        done
