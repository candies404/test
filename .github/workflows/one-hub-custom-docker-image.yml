name: one-hub 前端修改

on:
  #  schedule:
  #    - cron: '0 0 * * *'  # 每天 UTC 0:00 运行（北京时间 8:00）
  workflow_dispatch:        # 支持手动触发

jobs:
  one-hub-custom:
    name: '自定义前端 One Hub'
    runs-on: ubuntu-latest
    continue-on-error: true
    env:
      TZ: Asia/Shanghai
    permissions:
      issues: write
    steps:
      - name: 检查更新
        id: check
        run: |
          # 获取最新commit的信息
          COMMIT_INFO=$(curl -s "https://api.github.com/repos/MartialBE/one-hub/commits/main")
          CURRENT_SHA=$(echo $COMMIT_INFO | jq -r '.sha' | cut -c1-7)
          COMMIT_TIME=$(echo $COMMIT_INFO | jq -r '.commit.committer.date')
          
          # 计算时间差，确保使用UTC时间
          NOW=$(date -u +%s)
          COMMIT_TIME_SEC=$(date -u -d "$COMMIT_TIME" +%s)
          DIFF=$((NOW - COMMIT_TIME_SEC))
          
          # 获取issue中的sha，使用 -s 静默模式
          ISSUES=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/issues?labels=one-hub-sha")
          
          if [ "$(echo $ISSUES | jq '. | length')" -eq "0" ]; then
            echo "没有找到记录SHA的issue，创建新issue"
            
            if [ $DIFF -le 86400 ]; then
              echo "24小时内有更新"
              # 创建新issue，将输出重定向到临时文件
              RESPONSE=$(curl -s -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -d "{\"title\":\"One Hub SHA Record\",\"body\":\"$CURRENT_SHA\",\"labels\":[\"one-hub-sha\"]}" \
                "https://api.github.com/repos/${{ github.repository }}/issues")
              # 只输出issue number用于记录
              echo "Created issue number: $(echo $RESPONSE | jq .number)"
              echo "has_update=true" >> $GITHUB_OUTPUT
            else
              echo "24小时内没有更新"
              # 创建issue但不显示详细响应
              curl -s -X POST -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -d "{\"title\":\"One Hub SHA Record\",\"body\":\"$CURRENT_SHA\",\"labels\":[\"one-hub-sha\"]}" \
                "https://api.github.com/repos/${{ github.repository }}/issues" > /dev/null
              echo "has_update=false" >> $GITHUB_OUTPUT
            fi
            
          else
            # 获取issue中记录的sha
            ISSUE_NUMBER=$(echo $ISSUES | jq -r '.[0].number')
            RECORDED_SHA=$(echo $ISSUES | jq -r '.[0].body')
            
            echo "当前 SHA: $CURRENT_SHA"
            echo "记录的 SHA: $RECORDED_SHA"
            
            if [ "$CURRENT_SHA" != "$RECORDED_SHA" ]; then
              echo "检测到更新"
              
              # 更新issue中的sha
              curl -s -X PATCH -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -d "{\"body\":\"$CURRENT_SHA\"}" \
                "https://api.github.com/repos/${{ github.repository }}/issues/$ISSUE_NUMBER" > /dev/null
                
              echo "has_update=true" >> $GITHUB_OUTPUT
            else
              echo "没有检测到更新"
              echo "has_update=false" >> $GITHUB_OUTPUT
            fi
          fi
          
          # 输出时间信息供调试
          COMMIT_DATE=$(date -u -d "@$COMMIT_TIME_SEC" '+%Y-%m-%dT%H:%M:%SZ')
          CURRENT_DATE=$(date -u '+%Y-%m-%dT%H:%M:%SZ')
          HOURS=$((DIFF / 3600))
          echo "最新提交时间: $COMMIT_DATE"
          echo "当前时间: $CURRENT_DATE"
          echo "相差: ${HOURS} 小时"
