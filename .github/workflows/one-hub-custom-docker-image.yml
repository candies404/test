name: Check Image Architectures

on:
  workflow_dispatch:

jobs:
  check-images:
    runs-on: ubuntu-latest
    steps:
      - uses: docker/setup-buildx-action@v3

      - name: Check architectures
        run: |
          IMAGES=("nginx" "redis:7.0" "chipsman/uptime-kuma" "chipsman/one-hub")
          for image in "${IMAGES[@]}"; do
            echo "处理镜像: $image"
            
            # 获取manifest信息
            manifest=$(docker manifest inspect "$image" 2>/dev/null || true)
            
            # 多架构逻辑
            if [[ $(jq -e '.manifests' <<< "$manifest") ]]; then
              archs=$(jq -r '[.manifests[].platform | 
                "\(.os)/\(.architecture)\(.variant? | if . then "/"+. else "" end)"
                ] | unique | join(", ")' <<< "$manifest")
              type="多架构"
            else
              # 单架构逻辑解析config
              os=$(jq -r '.config.os // .schemaVendorManifest.mediaType | split("/")[1] // "unknown"' <<< "$manifest")
              arch=$(jq -r '.config.architecture // .architecture // "unknown"' <<< "$manifest")
              variant=$(jq -r '.config.variant // ""' <<< "$manifest")
              archs=${os}/${arch}${variant:+/$variant}
              type="单架构"
            fi

            printf "镜像名称: %s\n架构类型: %s\n支持架构: %s\n%s\n" \
              "$image" "$type" "${archs}" "----------------------------------------"
          done
