name: one-hub å‰ç«¯ä¿®æ”¹

on:
  workflow_dispatch:

jobs:
  check-updates:
    name: åŸå­åŒ–æ›´æ–°æ£€æŸ¥
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.final_check.outputs.should_build }}
      table_updated: ${{ steps.check_table.outputs.table_file_updated }}
    continue-on-error: true
    permissions:
      issues: write
      contents: read
    env:
      TZ: Asia/Shanghai
      RETRY_COUNT: 3  # API é‡è¯•æ¬¡æ•°
      RETRY_DELAY: 2  # é‡è¯•åŸºç¡€ç­‰å¾…æ—¶é—´ï¼ˆç§’ï¼‰

    steps:
      # ========== åŸå­åŒ–æ•°æ®è·å– ==========
      - name: è·å–ä»“åº“å¿«ç…§
        id: repo_snapshot
        run: |
          # è·å–ä¸»ä»“åº“æœ€æ–°æäº¤ï¼ˆåŒ…å«å®Œæ•´æ—¶é—´æˆ³ï¼‰
          main_commit=$(curl -fsS "https://api.github.com/repos/MartialBE/one-hub/commits/main")
          main_sha=$(jq -r '.sha[0:7]' <<< "$main_commit")
          main_timestamp=$(jq -r '.commit.committer.date' <<< "$main_commit")
          
          # è·å– TableRow çš„å†å²ç‰ˆæœ¬ï¼ˆç¡®ä¿ä¸ä¸»ä»“åº“æ—¶é—´ç‚¹ä¸€è‡´ï¼‰
          table_commit=$(curl -fsS "https://api.github.com/repos/MartialBE/one-hub/commits?path=web/src/views/Channel/component/TableRow.jsx&until=$main_timestamp")
          table_sha=$(jq -r 'if length>0 then .[0].sha[0:7] else "null" end' <<< "$table_commit")
          
          # å­˜å‚¨ç¯å¢ƒå˜é‡ï¼ˆåç»­æ­¥éª¤ä½¿ç”¨ï¼‰
          echo "SNAPSHOT_TIME=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_ENV
          echo "MAIN_SHA=$main_sha" >> $GITHUB_ENV
          echo "MAIN_TIMESTAMP=$main_timestamp" >> $GITHUB_ENV
          echo "TABLE_SHA=$table_sha" >> $GITHUB_ENV
          
          echo "ğŸ”„ ä»“åº“å¿«ç…§ï¼š"
          echo "  ä¸»ä»“åº“: $main_sha (æ—¶é—´: $main_timestamp)"
          echo "  TableRow: $table_sha"

      # ========== Issue ç®¡ç† ==========
      - name: ç®¡ç†è¿½è¸ª Issue
        id: issue_manager
        env:
          ISSUE_TITLE: "one-hub-tracker"
        run: |
          # å¸¦é‡è¯•çš„ Issue æŸ¥è¯¢å‡½æ•°
          fetch_issue() {
            for ((i=1; i<=$RETRY_COUNT; i++)); do
              response=$(curl -fsS "https://api.github.com/repos/${{ github.repository }}/issues?state=open&filter=created")
              issues=$(jq -r --arg title "$ISSUE_TITLE" '[.[] | select(.title == $title)]' <<< "$response")
              
              if [ $(jq 'length' <<< "$issues") -gt 0 ]; then
                echo "$issues"
                return 0
              fi
              
              sleep $(($RETRY_DELAY * $i))
            done
            echo "[]"
          }

          # åºåˆ—åŒ– Issue å†…å®¹
          serialize_body() {
            jq -n \
              --arg main "${{ env.MAIN_SHA }}" \
              --arg table "${{ env.TABLE_SHA }}" \
              --arg ts "${{ env.MAIN_TIMESTAMP }}" \
              --arg snapshot "${{ env.SNAPSHOT_TIME }}" \
              '{ 
                metadata: {
                  version: "v2",
                  snapshot: $snapshot
                },
                data: {
                  main: $main,
                  table: $table,
                  timestamp: $ts
                }
              }' | base64 -w0
          }

          # ååºåˆ—åŒ–å‡½æ•°
          deserialize_body() {
            base64 -d <<< "$1" | jq -r '.data'
          }

          # è·å–æˆ–åˆ›å»º Issue
          issue_data=$(fetch_issue)
          if [ $(jq 'length' <<< "$issue_data") -eq 0 ]; then
            echo "ğŸ†• åˆ›å»ºæ–°è¿½è¸ª Issue"
            body=$(serialize_body)
            response=$(curl -fsS -X POST \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Content-Type: application/json" \
              -d "$(jq -n --arg title "$ISSUE_TITLE" --arg body "$body" '{title: $title, body: $body}')" \
              "https://api.github.com/repos/${{ github.repository }}/issues")
            
            echo "âœ… å·²åˆ›å»º Issue: $(jq -r '.html_url' <<< "$response")"
            echo "main_updated=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ” å‘ç°ç°æœ‰è¿½è¸ª Issue"
            issue_number=$(jq -r '.[0].number' <<< "$issue_data")
            current_body=$(jq -r '.[0].body' <<< "$issue_data")
            current_data=$(deserialize_body "$current_body")
            
            # æ¯”è¾ƒé€»è¾‘ï¼ˆåŒæ—¶æ ¡éªŒæ—¶é—´æˆ³ï¼‰
            new_body=$(serialize_body)
            if [ "$current_body" != "$new_body" ] || \
               [ "$(jq -r '.data.main' <<< "$current_data")" != "${{ env.MAIN_SHA }}" ] || \
               [ "$(jq -r '.data.timestamp' <<< "$current_data")" != "${{ env.MAIN_TIMESTAMP }}" ]; then
              echo "ğŸ”„ æ£€æµ‹åˆ°æ›´æ–°ï¼š"
              echo "  æ—§å€¼: $(jq <<< "$current_data")"
              echo "  æ–°å€¼: main=${{ env.MAIN_SHA }}, table=${{ env.TABLE_SHA }}, ts=${{ env.MAIN_TIMESTAMP }}"
              
              # æ›´æ–° Issue
              curl -fsS -X PATCH \
                -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                -H "Content-Type: application/json" \
                -d "$(jq -n --arg body "$new_body" '{body: $body}')" \
                "https://api.github.com/repos/${{ github.repository }}/issues/$issue_number"
              
              echo "main_updated=true" >> $GITHUB_OUTPUT
            else
              echo "âœ… æ— æ›´æ–°éœ€è¦åŒæ­¥"
              echo "main_updated=false" >> $GITHUB_OUTPUT
            fi
          fi

      # ========== TableRow æ£€æŸ¥ ==========
      - name: æ£€æŸ¥ç»„ä»¶æ›´æ–°
        id: check_table
        if: steps.issue_manager.outputs.main_updated == 'true'
        run: |
          # å§‹ç»ˆä½¿ç”¨åŸå­åŒ–å¿«ç…§ä¸­çš„åˆå§‹å€¼
          initial_sha="${{ env.TABLE_SHA }}"
          
          # è·å–å½“å‰æœ€æ–° SHAï¼ˆå¸¦ç¼“å­˜ç ´åå‚æ•°ï¼‰
          current_sha=$(curl -fsS "https://api.github.com/repos/MartialBE/one-hub/commits?path=web/src/views/Channel/component/TableRow.jsx&_=$(date +%s)" | 
            jq -r 'if length>0 then .[0].sha[0:7] else "null" end')
          
          echo "ğŸ”„ TableRow ç‰ˆæœ¬æ£€æŸ¥ï¼š"
          echo "  åˆå§‹å€¼: $initial_sha (æ¥è‡ªå¿«ç…§ ${{ env.SNAPSHOT_TIME }})"
          echo "  å½“å‰å€¼: $current_sha"
          
          if [ "$current_sha" != "$initial_sha" ] && [ "$initial_sha" != "null" ]; then
            echo "ğŸš¨ æ£€æµ‹åˆ° TableRow æ›´æ–°"
            echo "table_file_updated=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… æ— ç»„ä»¶æ›´æ–°"
            echo "table_file_updated=false" >> $GITHUB_OUTPUT
          fi

      # ========== æœ€ç»ˆæ£€æŸ¥ ==========
      - name: æ„å»ºå†³ç­–
        id: final_check
        run: |
          if [[ "${{ steps.issue_manager.outputs.main_updated }}" == "true" ]]; then
            echo "ğŸ“¦ éœ€è¦æ‰§è¡Œæ„å»º"
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "â¸ï¸ è·³è¿‡æ„å»º"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      - name: å‘é€TableRowé€šçŸ¥
        if: steps.check_table.outputs.table_file_updated == 'true'
        uses: candies404/Multi-Channel-Notifier@latest
        with:
          title: "TableRowç»„ä»¶æ›´æ–°"
          content: "æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬ï¼Œç‚¹å‡»æŸ¥çœ‹ï¼š[TableRow.jsx](https://github.com/MartialBE/one-hub/blob/main/web/src/views/Channel/component/TableRow.jsx)"
          hitokoto: 'false'
          wpush_key : ${{ secrets.WPUSH_KEY }}

  build-deploy:
    name: æ„å»ºéƒ¨ç½²
    needs: check-updates
    if: needs.check-updates.outputs.should_build == 'true'
    runs-on: ubuntu-latest
    env:
      TZ: Asia/Shanghai
    steps:
      - name: æ£€å‡º MartialBE/one-hub
        uses: actions/checkout@v4
        with:
          repository: MartialBE/one-hub
          path: ""

      - name: æ£€å‡ºæºä»“åº“
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          path: source-repo

      - name: ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯
        run: |
          echo "=== ä¿å­˜ç‰ˆæœ¬ä¿¡æ¯ ==="
          HASH=$(git rev-parse --short=7 HEAD)
          echo "å½“å‰æäº¤å“ˆå¸Œ: $HASH"
          echo "dev-$HASH" > VERSION
          echo "ç‰ˆæœ¬æ–‡ä»¶å†…å®¹: $(cat VERSION)"

      - name: è®¾ç½® Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22.4.1

      - name: ç¼“å­˜ Node æ¨¡å—
        uses: actions/cache@v4
        with:
          path: |
            web/node_modules
            ~/.cache/yarn
          key: ${{ runner.os }}-node-${{ hashFiles('web/yarn.lock') }}

      - name: æ„å»ºå‰ç«¯
        env:
          CI: ""
        run: |
          echo "=== å¼€å§‹æ„å»ºå‰ç«¯ ==="
          export VERSION=$(cat VERSION)
          echo "å½“å‰ç‰ˆæœ¬: $VERSION"
          cp source-repo/one-hub/TableRow.jsx web/src/views/Channel/component/TableRow.jsx
          echo "TableRow.jsx å·²æ›¿æ¢"
          cd web
          yarn install
          VITE_APP_VERSION=$VERSION yarn run build
          echo "å‰ç«¯æ„å»ºå®Œæˆ"

      - name: è®¾ç½® Go
        uses: actions/setup-go@v5
        with:
          go-version: ">=1.18.0"

      - name: ç¼–è¯‘åç«¯ (amd64)
        run: |
          echo "=== ç¼–è¯‘åç«¯ (amd64) ==="
          go mod download
          go build -ldflags "-s -w -X 'one-api/common/config.Version=$(cat VERSION)' -extldflags '-static'" -o one-api-amd64
          echo "amd64 ç¼–è¯‘å®Œæˆ"

      - name: ç¼–è¯‘åç«¯ (arm64)
        run: |
          echo "=== ç¼–è¯‘åç«¯ (arm64) ==="
          sudo rm /etc/apt/sources.list.d/microsoft-prod.list
          sudo apt-get update
          sudo apt-get install gcc-aarch64-linux-gnu
          CC=aarch64-linux-gnu-gcc CGO_ENABLED=1 GOOS=linux GOARCH=arm64 go build -ldflags "-s -w -X 'one-api/common/config.Version=$(cat VERSION)' -extldflags '-static'" -o one-api-arm64
          echo "arm64 ç¼–è¯‘å®Œæˆ"

      - name: è®¾ç½® QEMU
        uses: docker/setup-qemu-action@v3

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker å…ƒæ•°æ®
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            docker.io/${{ secrets.DOCKERHUB_USERNAME }}/one-hub
          tags: |
            type=raw,value=latest

      - name: æ„å»ºå¹¶æ¨é€é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          file: Dockerfile-action
