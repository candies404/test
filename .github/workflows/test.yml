name: é•œåƒåŒæ­¥å·¥ä½œæµ

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:  # å®šæ—¶ä»»åŠ¡
    - cron: '0 2 * * *'  # æ¯æ—¥UTC 2ç‚¹æ‰§è¡Œ

jobs:
  docker-sync:
    runs-on: ubuntu-latest  # è¿è¡Œç¯å¢ƒ
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è§„åˆ™é¢„å¤„ç†
      id: setup
      run: |
        CLEANED_RULES=$(echo "${{ vars.SYNC_MAPPINGS }}" | 
          tr ',' '\n' |
          sed -E 's/[[:space:]]+//g; /^$/d' |
          sort -u
        )
        echo "SYNC_RULES<<EOF" >> $GITHUB_ENV
        echo "$CLEANED_RULES" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        echo "=== æœ‰æ•ˆè§„åˆ™ ($(echo "$CLEANED_RULES" | wc -l) æ¡) ==="
        echo "$CLEANED_RULES"

    - name: ç™»å½•DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: é…ç½®é«˜æ€§èƒ½æ„å»ºç¯å¢ƒ
      uses: docker/setup-buildx-action@v3
      id: buildx
      with:
        driver: docker-container
        driver-opts: |
          image=moby/buildkit:master
          network=host
        buildkitd-config-inline: |
          [registry."docker.io"]
            mirrors = ["dockerpull.cn"]
          [worker.oci]
            max-parallelism = 4

    - name: æ‰§è¡Œæ™ºèƒ½é•œåƒåŒæ­¥
      env:
        DOCKERHUB_USER: "${{ secrets.DOCKERHUB_USERNAME }}"
      run: |
        export BUILDKIT_PROGRESS=plain
        failed_rules=()
        
        while IFS= read -r rule; do
          [[ -z "$rule" ]] && continue
          echo "=== å¤„ç†è§„åˆ™: $rule ==="
          
          # ä½¿ç”¨å‚æ•°æ›¿æ¢å¢å¼ºå®¹é”™æ€§
          src_image="${rule%%=*}"
          target_spec="${rule#*=}"
          target_spec="${target_spec/#docker.io\//}"  # è‡ªåŠ¨å»é™¤å†—ä½™registry

          # æ™ºèƒ½è¡¥å…¨é€»è¾‘
          if [[ "$target_spec" != *":"* ]]; then
            target_spec+=":$(awk -F':' '{print $2}' <<<"$src_image" | grep -v ^$ || echo latest)"
          fi
          [[ "$target_spec" != *"/"* ]] && target_spec="$DOCKERHUB_USER/$target_spec"

          # === æ–°å¢æ¶æ„æ£€æŸ¥é€»è¾‘ ===
          echo "=== æ¶æ„æ£€æŸ¥ ==="
          
          # è·å–æºé•œåƒæ”¯æŒçš„å¹³å°æ¶æ„
          echo "è·å–æºé•œåƒæ¶æ„ï¼š$src_image"
          src_platforms=$(docker buildx imagetools inspect "$src_image" 2>/dev/null | grep 'Platform:' | sed -E 's/Platform: //g' | sort -u)
          if [ -z "$src_platforms" ]; then
            echo "âŒ è·å–æºé•œåƒæ¶æ„å¤±è´¥"
            failed_rules+=("$rule")
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            continue
          fi

          # è·å–ç›®æ ‡é•œåƒæ”¯æŒçš„å¹³å°æ¶æ„
          echo "æ£€æŸ¥ç›®æ ‡é•œåƒæ˜¯å¦å­˜åœ¨ï¼š$target_spec"
          target_platforms=$(docker buildx imagetools inspect "$target_spec" 2>/dev/null | grep 'Platform:' | sed -E 's/Platform: //g' | sort -u)
          
          # æ£€æŸ¥ç›®æ ‡æ˜¯å¦åŒ…å«æ‰€æœ‰æºæ¶æ„
          all_platforms_present=true
          while read -r platform; do
            if ! echo "$target_platforms" | grep -qxF "$platform"; then
              all_platforms_present=false
              break
            fi
          done <<< "$src_platforms"

          # å¦‚æœç›®æ ‡åŒ…å«æ‰€æœ‰æ¶æ„åˆ™è·³è¿‡åŒæ­¥
          if [ "$all_platforms_present" = true ] && [ -n "$target_platforms" ]; then
            echo "âœ… ç›®æ ‡å·²åŒ…å«æ‰€æœ‰æ¶æ„ï¼š$(echo $src_platforms)"
            docker buildx imagetools inspect "$target_spec" | \
            grep -E 'Platform:|Size:' | \
            grep -v 'Platform:.*unknown/unknown' || true
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            continue
          fi
          # === æ–°å¢é€»è¾‘ç»“æŸ ===

          # å¢åŠ åŒæ­¥è¶…æ—¶æ§åˆ¶
          echo "ğŸ”„ åŒæ­¥ $src_image â†’ $target_spec"
          timeout 300 docker buildx imagetools create -t "$target_spec" "$src_image"
          
          # æ”¶é›†åŒæ­¥ç»“æœ
          if (( $? != 0 )); then
            failed_rules+=("$rule")
            echo "âŒ åŒæ­¥å¤±è´¥: $rule"
            docker buildx imagetools inspect "$src_image" || true
          else
            echo "âœ… åŒæ­¥æˆåŠŸ"
            # æ˜¾ç¤ºè¿‡æ»¤åçš„å¹³å°ä¿¡æ¯
            docker buildx imagetools inspect "$target_spec" | \
            grep -E 'Platform:|Size:' | \
            grep -v 'Platform:.*unknown/unknown'
          fi
          
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        done <<< "$SYNC_RULES"

        # è¾“å‡ºæœ€ç»ˆæŠ¥å‘Š
        echo "=== åŒæ­¥ç»“æœæŠ¥å‘Š ==="
        echo "æˆåŠŸ: $(( $(wc -l <<<"$SYNC_RULES") - ${#failed_rules[@]} )) æ¡"
        if (( ${#failed_rules[@]} > 0 )); then
          echo "å¤±è´¥ (${#failed_rules[@]}):"
          printf '  - %s\n' "${failed_rules[@]}"
          exit 1
        fi
