name: 镜像同步工作流

on:
  workflow_dispatch:
  schedule: 
    - cron: '0 2 * * *'

jobs:
  docker-sync:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 规则预处理
        id: setup
        run: |
          CLEANED_RULES=$(echo "${{ vars.SYNC_MAPPINGS }}" | 
            tr ',' '\n' |
            sed -E 's/[[:space:]]+//g; /^$/d' |
            sort -u
          )
          echo "SYNC_RULES<<EOF" >> $GITHUB_ENV
          echo "$CLEANED_RULES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "=== 有效规则 ($(echo "$CLEANED_RULES" | wc -l) 条) ==="
          echo "$CLEANED_RULES"

      - name: 登录DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 配置高性能构建环境
        uses: docker/setup-buildx-action@v3
        id: buildx
        with:
          driver: docker-container
          driver-opts: |
            image=moby/buildkit:master
            network=host
          buildkitd-config-inline: |
            [registry."docker.io"]
              mirrors = ["dockerpull.cn"]
            [worker.oci]
              max-parallelism = 4

      - name: 执行智能镜像同步
        env:
          DOCKERHUB_USER: "${{ secrets.DOCKERHUB_USERNAME }}"
        run: |
          export BUILDKIT_PROGRESS=plain
          failed_rules=()
          SYNC_EXECUTED=0
          SYNC_SKIPPED=0

          # 增强架构检测函数
          safe_inspect_platforms() {
            local image=$1
            # 同时捕获标准输出和标准错误
            local output=$(docker buildx imagetools inspect "$image" 2>&1)
            
            # 检测镜像不存在的情况
            if [[ "$output" =~ "does not exist" || "$output" =~ "not found" ]]; then
              echo "NON_EXISTENT"
              return 1
            fi
            
            # 返回有效的架构列表
            echo "$output" | grep 'Platform:' | sed -E \
              -e 's/Platform: +//' \
              -e 's/, /\n/g' \
              -e '/^unknown/d' \
              -e '/^$/d'
          }

          # 修正统计函数
          count_platforms() {
            echo "$1" | grep -v "NON_EXISTENT" | awk 'NF {count++} END {print count+0}'
          }

          while IFS= read -r rule; do
            [[ -z "$rule" ]] && continue
            echo "=== 🛠️ 处理规则: $rule ==="

            #======= 参数解析 =======#
            src_image="${rule%%=*}"
            target_spec="${rule#*=}"
            target_spec="${target_spec/#docker.io\//}"

            # 处理源镜像标签
            if [[ "$src_image" == *":"* ]]; then
              src_tag="${src_image##*:}"
              src_name="${src_image%:*}"
            else
              src_tag="latest"
              src_name="$src_image"
            fi

            # 确保目标spec包含正确标签
            if [[ "$target_spec" == *":"* ]]; then
              target_tag="${target_spec##*:}"
              target_base="${target_spec%:*}"
            else
              target_base="$target_spec"
              target_tag="$src_tag"
            fi

            # 自动补全用户前缀并合成最终spec
            final_spec="$target_base"
            [[ ! "$final_spec" == *"/"* ]] && final_spec="$DOCKERHUB_USER/$final_spec"
            final_spec+=":$target_tag"

            #======= 架构分析 =======#
            # 获取源架构（增加错误处理）
            raw_src_output=$(safe_inspect_platforms "$src_image" || true)
            if [[ "$raw_src_output" == "NON_EXISTENT" ]]; then
              echo "❌ 源镜像不存在: $src_image"
              failed_rules+=("$rule")
              continue
            fi
            src_platforms=$(echo "$raw_src_output" | sed -e '/^$/d' | sort -u)
            echo "🔎 源镜像架构 ($(count_platforms "$src_platforms") 种)" 
            echo "$src_platforms" | sed 's/^/  ➜ /'

            #======= 处理目标镜像 =======#
            echo "✳️ 最终目标镜像: $final_spec"
            raw_target_output=$(safe_inspect_platforms "$final_spec" || true)
            
            if [[ "$raw_target_output" == "NON_EXISTENT" ]]; then
              echo "📦 目标镜像不存在"
              target_platforms=""
              target_platform_count=0
            else
              target_platforms=$(echo "$raw_target_output" | sed -e '/^$/d' | sort -u)
              target_platform_count=$(count_platforms "$target_platforms")
              echo "📦 目标镜像架构 ($target_platform_count 种)"
              echo "$target_platforms" | sed 's/^/  ➜ /'
            fi

            #======= 同步策略 =======#
            if (( target_platform_count == 0 )); then
              echo "🆕 初始化镜像..."
              if ! timeout 300 docker buildx imagetools create -t "$final_spec" "$src_image"; then
                echo "❌ 镜像初始化失败"
                failed_rules+=("$rule")
                continue
              fi
              SYNC_EXECUTED=$((SYNC_EXECUTED+1))
            else
              missing_platforms=$(comm -23 <(echo "$src_platforms") <(echo "$target_platforms"))
              missing_count=$(count_platforms "$missing_platforms")
              
              if (( missing_count > 0 )); then
                echo "🔄 差异架构 ($missing_count 种)"
                echo "$missing_platforms" | sed 's/^/  ➤ /'
                
                if ! timeout 300 docker buildx imagetools create -t "$final_spec" "$src_image" --append; then
                  echo "⚡ 增量失败，尝试强制覆盖"
                  if ! timeout 300 docker buildx imagetools create -t "$final_spec" "$src_image" --force; then
                    echo "❌ 同步彻底失败"
                    failed_rules+=("$rule")
                    continue
                  fi
                fi
                SYNC_EXECUTED=$((SYNC_EXECUTED+1))
              else
                echo "⏭️ 已保持最新，跳过同步"
                SYNC_SKIPPED=$((SYNC_SKIPPED+1))
              fi
            fi

            #======= 结果验证 =======#
            final_raw_output=$(safe_inspect_platforms "$final_spec" || true)
            final_platforms=$(echo "$final_raw_output" | sed -e '/^$/d' | sort -u)
            missing_check=$(comm -23 <(echo "$src_platforms") <(echo "$final_platforms"))
            
            if [[ -n "$missing_check" ]]; then
              echo "❌ 验证失败，缺少架构："
              echo "$missing_check" | sed 's/^/  ▸ /'
              failed_rules+=("$rule")
            else
              echo "✅ 验证通过" 
              docker buildx imagetools inspect "$final_spec" | grep -E 'Platform:|Size:' | sed 's/^/  ✨ /'
            fi
            echo "─────────────────────────────────────"
          done <<< "$SYNC_RULES"

          #======= 可视化报告 =======#
          total_rules=$(count_platforms "$SYNC_RULES")
          echo "📊=== 同步报告 ==="
          echo "🔢 处理总数 | $total_rules"
          echo "🟢 成功同步 | $SYNC_EXECUTED"
          echo "🟡 跳过同步 | $SYNC_SKIPPED"
          echo "🔴 同步失败 | ${#failed_rules[@]}"
          
          if ((${#failed_rules[@]} > 0)); then
            echo "🔥 失败详情："
            printf "  ‼️ %s\n" "${failed_rules[@]}"
            exit 1
          fi
