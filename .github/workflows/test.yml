name: é•œåƒåŒæ­¥å·¥ä½œæµ

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  docker-sync:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è§„åˆ™é¢„å¤„ç†
      id: setup
      run: |
        # æ¸…ç†è¾“å…¥è§„åˆ™ï¼ˆä¼˜åŒ–ç©ºæ ¼å¤„ç†ï¼‰
        CLEANED_RULES=$(echo "${{ vars.SYNC_MAPPINGS }}" |
          tr '\n' ',' |  # æ¢è¡Œè½¬é€—å·
          sed -E 's/[[:space:]]+//g; s/,+/ /g; s/^ | $//g' |  # åˆå¹¶å†—ä½™ç©ºæ ¼å’Œé€—å·
          tr ' ' '\n' |  # ç©ºæ ¼è½¬å›è½¦
          grep -v '^$'  # è¿‡æ»¤ç©ºè¡Œ
        )
        
        # å°†å¤„ç†åçš„è§„åˆ™å­˜å…¥ç¯å¢ƒå˜é‡
        echo "SYNC_RULES<<EOF" >> $GITHUB_ENV
        echo "$CLEANED_RULES" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        
        # è¾“å‡ºè°ƒè¯•ä¿¡æ¯
        echo "=== æœ‰æ•ˆåŒæ­¥è§„åˆ™ ==="
        echo "$CLEANED_RULES"

    - name: é…ç½®é•œåƒåŠ é€Ÿå™¨
      run: |
        echo '{"registry-mirrors": ["https://dockerpull.cn"]}' | sudo tee /etc/docker/daemon.json
        sudo systemctl restart docker

    - name: ç™»å½•DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: ç¼“å­˜ Docker å±‚
      uses: actions/cache@v4
      with:
        path: /tmp/.buildx-cache
        key: ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: |
          ${{ runner.os }}-buildx-

    - name: é…ç½®æ„å»ºç¯å¢ƒ
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          image=moby/buildkit:latest
          network=host
        buildkitd-config: |
          [registry."docker.io"]
            mirrors = ["dockerpull.cn"]
        cache-from: type=local,src=/tmp/.buildx-cache
        cache-to: type=local,dest=/tmp/.buildx-cache

    - name: æ‰§è¡Œé•œåƒå¤„ç†
      env:
        DOCKERHUB_USER: "${{ secrets.DOCKERHUB_USERNAME }}"
      run: |
        IFS=$'\n'
        # æå‰åˆå¹¶æ‹‰å–æ‰€æœ‰æºé•œåƒ
        for rule in $SYNC_RULES; do
          src_image=$(echo "$rule" | cut -d'=' -f1)
          docker pull "$src_image" --quiet || true
        done

        # æ‰§è¡ŒåŒæ­¥é€»è¾‘
        for rule in $SYNC_RULES; do
          [[ -z "$rule" ]] && continue
          echo "=== å¤„ç†è§„åˆ™: $rule ==="
          if ! IFS="=" read -r src_image target_part <<< "${rule// /}"; then
            echo "âš ï¸ æ ¼å¼é”™è¯¯: $rule"
            continue
          fi

          # è§£æç›®æ ‡é•œåƒï¼ˆåŸæœ‰é€»è¾‘ï¼‰
          if [[ "$target_part" == *":"* ]]; then
            target_tag="${target_part##*:}"
            repo_part="${target_part%:*}"
          else
            target_tag="latest"
            repo_part="$target_part"
          fi

          if [[ "$repo_part" == *"/"* ]]; then
            target_user="${repo_part%%/*}"
            target_image="${repo_part#*/}"
            [[ ! "$target_user" =~ ^[a-z0-9]+([._-][a-z0-9]+)*$ ]] && continue
          else
            target_user="$DOCKERHUB_USER"
            target_image="$repo_part"
          fi

          final_target="${target_user}/${target_image}:${target_tag}"
          [[ ! "$final_target" =~ ^([a-z0-9]+([._-][a-z0-9]+)*/)?[a-z0-9]+([._-][a-z0-9]+)*:[a-zA-Z0-9_.-]+$ ]] && continue

          echo "â–· æºé•œåƒ: $src_image â†’ ç›®æ ‡: $final_target"
          echo "ğŸ”„ å¼€å§‹åŒæ­¥æ“ä½œ..."
          
          # éªŒè¯æºé•œåƒå¯è®¿é—®æ€§
          if ! docker buildx imagetools inspect "$src_image" >/dev/null 2>&1; then
            echo "âŒ æºé•œåƒä¸å¯è®¿é—®: $src_image"
            echo "å°è¯•ä½¿ç”¨ library/$src_image..."
            if ! docker buildx imagetools inspect "library/$src_image" >/dev/null 2>&1; then
              echo "âŒ é•œåƒä»ç„¶ä¸å¯è®¿é—®: library/$src_image"
              continue
            else
              src_image="library/$src_image"
            fi
          fi
          
          # æ‰§è¡Œå¤šæ¶æ„é•œåƒåŒæ­¥
          echo "ğŸš€ æ­£åœ¨åŒæ­¥å¤šå¹³å°é•œåƒ..."
          if docker buildx imagetools create -t "$final_target" "$src_image" >/dev/null 2>&1; then
            echo "âœ… åŒæ­¥æˆåŠŸ"
            echo "é•œåƒè¯¦ç»†ä¿¡æ¯ï¼š"
            docker buildx imagetools inspect "$final_target"
          else
            echo "âŒ åŒæ­¥å¤±è´¥ï¼Œé”™è¯¯è¯¦æƒ…ï¼š"
            # æ˜¾ç¤ºå®Œæ•´é”™è¯¯è¾“å‡º
            docker buildx imagetools create -t "$final_target" "$src_image"
          fi
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        done
