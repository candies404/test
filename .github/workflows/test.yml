name: Docker Image Sync

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  docker-sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup sync rules
      id: setup
      run: |
        # æ¸…æ´—è§„åˆ™ï¼ˆå¢å¼ºç©ºæ ¼å¤„ç†ï¼‰
        CLEANED_RULES=$(echo "${{ vars.SYNC_MAPPINGS }}" |
          tr '\n' ',' | 
          sed -E 's/[[:space:]]+//g; s/,+/ /g; s/^ | $//g' |
          tr ' ' '\n' |
          grep -v '^$'
        )
        
        echo "SYNC_RULES<<EOF" >> $GITHUB_ENV
        echo "$CLEANED_RULES" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

        # è°ƒè¯•è¾“å‡ºæ¸…æ´—åçš„è§„åˆ™
        echo "=== å¤„ç†åè§„åˆ™ ==="
        echo "$CLEANED_RULES"

    - name: Login Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Process images
      env:
        DOCKERHUB_USER: "${{ secrets.DOCKERHUB_USERNAME }}"
      run: |
        IFS=$'\n'
        for rule in $SYNC_RULES; do
          [[ -z "$rule" ]] && continue
          echo "=== å¤„ç†è§„åˆ™: $rule ==="

          # åˆ†å‰²è§„åˆ™ï¼ˆæ”¯æŒSHA256æ ¼å¼ï¼‰
          if ! IFS="=" read -r src_image target_part <<< "${rule// /}"; then
            echo "âš ï¸ è§„åˆ™æ ¼å¼é”™è¯¯ï¼Œè·³è¿‡"
            continue
          fi

          # è§£æç›®æ ‡éƒ¨åˆ†æ ‡ç­¾
          if [[ "$target_part" == *":"* ]]; then
            target_tag="${target_part##*:}"
            repo_part="${target_part%:*}"
          else
            target_tag="latest"
            repo_part="$target_part"
          fi

          # å¤„ç†å‘½åç©ºé—´
          if [[ "$repo_part" == *"/"* ]]; then
            target_user="${repo_part%%/*}"
            target_image="${repo_part#*/}"
            # éªŒè¯ç”¨æˆ·åæ ¼å¼
            if [[ ! "$target_user" =~ ^[a-z0-9]+([._-][a-z0-9]+)*$ ]]; then
              echo "âŒ éæ³•çš„ç”¨æˆ·åæ ¼å¼: $target_user"
              continue
            fi
          else
            target_user="$DOCKERHUB_USER"
            target_image="$repo_part"
          fi

          final_target="${target_user}/${target_image}:${target_tag}"
          echo "ä½¿ç”¨çš„Dockerç”¨æˆ·: $DOCKERHUB_USER"
          echo "ç”Ÿæˆçš„ç›®æ ‡é•œåƒ: $final_target"

          # æœ€ç»ˆé•œåƒéªŒè¯ï¼ˆå…è®¸åŒ…å«SHAï¼‰
          if ! [[ "$final_target" =~ ^([a-z0-9]+([._-][a-z0-9]+)*/)?[a-z0-9]+([._-][a-z0-9]+)*:[a-zA-Z0-9_.-]+$ ]]; then
            echo "âŒ éæ³•çš„é•œåƒæ ¼å¼: $final_target"
            continue
          fi

          echo "ä½¿ç”¨çš„Dockerç”¨æˆ·: $DOCKERHUB_USER"
          echo "ç”Ÿæˆçš„ç›®æ ‡é•œåƒ: $final_target"
          echo "ğŸ”„ åŒæ­¥ä¸­: $src_image â†’ $final_target"

          # æ£€æŸ¥æºé•œåƒæ˜¯å¦å­˜åœ¨
          if ! docker buildx imagetools inspect "$src_image" >/dev/null 2>&1; then
            echo "âŒ æ— æ³•è®¿é—®æºé•œåƒ"
            continue
          fi

          # æ‰§è¡Œå¤šæ¶æ„åŒæ­¥
          echo "ğŸš€ å¼€å§‹é•œåƒåŒæ­¥..."
          if docker buildx imagetools create -t "$final_target" "$src_image" >/dev/null 2>&1; then
            echo "âœ… åŒæ­¥æˆåŠŸ"
            echo "é•œåƒè¯¦æƒ…ï¼š"
            docker buildx imagetools inspect "$final_target"
          else
            echo "âŒ åŒæ­¥å¤±è´¥"
            # è¾“å‡ºè¯¦ç»†é”™è¯¯ä¿¡æ¯
            docker buildx imagetools create -t "$final_target" "$src_image"
          fi

          echo "---------------------------------------"    
        done
