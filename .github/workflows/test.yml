name: Docker Image Sync

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  docker-sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup sync rules
      id: setup
      run: |
        # æ¸…æ´—è§„åˆ™å¼ºåŒ–ç‰ˆ
        CLEANED_RULES=$(echo "${{ vars.SYNC_MAPPINGS }}" |
          tr '\n' ',' |          # æ¢è¡Œè½¬é€—å·
          sed -E 's/,+/ /g; s/^ +| +$//g' |  # é€—å·å˜ç©ºæ ¼ï¼Œå»é™¤é¦–å°¾ç©ºæ ¼
          tr ' ' '\n' |          # è½¬å¤šè¡Œæ ¼å¼
          grep -v '^$'           # åˆ é™¤ç©ºè¡Œ
        )
        
        echo "SYNC_RULES<<EOF" >> $GITHUB_ENV
        echo "$CLEANED_RULES" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Login Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Process images
      env:
        DOCKERHUB_USER: ${{ secrets.DOCKERHUB_USERNAME }}  # å…³é”®ä¿®å¤ç‚¹ï¼ï¼ï¼ï¼
      run: |
        IFS=$'\n'
        for rule in $SYNC_RULES; do
          [[ -z "$rule" ]] && continue

          echo "=== å½“å‰è§„åˆ™ï¼š$rule ==="

          # å®‰å…¨åˆ†å‰²è§„åˆ™
          if ! IFS="=" read -r src_image target_part <<< "$rule"; then
            echo "âš ï¸ è§„åˆ™æ ¼å¼é”™è¯¯ï¼Œè·³è¿‡"
            continue
          fi

          # è§£ç ç›®æ ‡ç»“æ„
          target_tag="latest"
          if [[ "$target_part" == *":"* ]]; then
            target_tag="${target_part##*:}"
            repo_part="${target_part%:*}"
          else
            repo_part="$target_part"
          fi

          # å‘½åç©ºé—´å¤„ç†å¼ºåŒ–é€»è¾‘
          if [[ "$repo_part" == *"/"* ]]; then
            target_user="${repo_part%%/*}"
            target_image="${repo_part#*/}"
          else
            target_user="$DOCKERHUB_USER"  # ä½¿ç”¨ç¯å¢ƒå˜é‡ï¼ï¼ï¼
            target_image="$repo_part"
          fi

          final_target="${target_user}/${target_image}:${target_tag}"

          # é•œåƒæ ¼å¼ç»ˆæ£€
          if ! [[ "$final_target" =~ ^[a-z0-9]+([._-][a-z0-9]+)*/[a-z0-9]+([._-][a-z0-9]+)*(:[a-zA-Z0-9_.-]+)?$ ]]; then
            echo "âŒ ä¸åˆæ³•çš„é•œåƒæ ¼å¼ï¼š"$final_target""
            continue
          fi

          echo "ğŸ”„ åŒæ­¥ [ $src_image ] â†’ [ $final_target ]"

          # æ‰§è¡ŒåŒæ­¥æµç¨‹
          if ! docker pull -q "$src_image"; then
            echo "âŒ æºé•œåƒæ‹‰å–å¤±è´¥"
            continue
          fi

          if docker pull -q "$final_target" 2>/dev/null; then
            need_push=false
          else
            need_push=true
          fi

          # æ›´æ–°æ£€æŸ¥ï¼ˆä¼˜åŒ–IDæ¯”è¾ƒï¼‰
          if $need_push || [[ $(docker inspect -f '{{.Id}}' "$src_image" 2>/dev/null) != $(docker inspect -f '{{.Id}}' "$final_target" 2>/dev/null) ]]; then
            docker tag "$src_image" "$final_target" &&
            docker push "$final_target" &&
            echo "âœ… åŒæ­¥æˆåŠŸ" || echo "âŒ æ¨é€å¤±è´¥"
          else
            echo "âœ… å·²æ˜¯æœ€æ–°æ— éœ€åŒæ­¥"
          fi

          echo "---------------------------------------"
        done
