name: Docker Image Sync

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  docker-sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup sync rules
      id: setup
      run: |
        # æ¸…æ´åŒ–è¾“å…¥æ•°æ®ï¼ˆå…³é”®ä¿®æ­£æ­¥éª¤ï¼‰
        CLEAN_RULES=$(
          echo "${{ vars.SYNC_MAPPINGS }}" |
          tr -d '\n' |    # ç§»é™¤æ¢è¡Œç¬¦
          sed 's/, */,/g' |  # æ ‡å‡†åŒ–åˆ†éš”ç¬¦
          sed 's/^,//; s/,$//' # å»é™¤é¦–å°¾é€—å·
        )
        
        # åˆ†å‰²è§„åˆ™å¹¶è°ƒè¯•è¾“å‡º
        IFS=',' read -ra RULES <<< "$CLEAN_RULES"
        echo "â›³ åŸå§‹è§„åˆ™è§£æç»“æœï¼š"
        printf " - %s\n" "${RULES[@]}"
        
        # ç”Ÿæˆå¤„ç†ç”¨å˜é‡
        echo "SYNC_RULES<<EOF" >> $GITHUB_ENV
        printf "%s\n" "${RULES[@]}" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Login Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Process images
      run: |
        IFS=$'\n'
        for rule in $SYNC_RULES; do
          [[ -z "$rule" ]] && continue

          # å®‰å…¨åˆ†å‰²è§„åˆ™ï¼ˆæ–°å¢é”™è¯¯æ£€æµ‹ï¼‰
          if [[ "$rule" != *"="* ]]; then
            echo "âš ï¸ æ— æ•ˆè§„åˆ™æ ¼å¼ï¼š$ruleï¼Œè·³è¿‡å¤„ç†"
            continue
          fi
          
          src_image=$(cut -d= -f1 <<< "$rule" | xargs)
          target_part=$(cut -d= -f2- <<< "$rule" | xargs)

          echo "ğŸ” å¤„ç†è§„åˆ™ï¼š$src_image â†’ $target_part"

          # è¡¥å…¨ç›®æ ‡ä¿¡æ¯ï¼ˆå…³é”®ä¿®æ­£ï¼‰
          target_user="${{ secrets.DOCKERHUB_USERNAME }}"
          target_tag="latest"
          
          # å¤„ç†æ ‡ç­¾
          if [[ "$target_part" == *":"* ]]; then
            target_tag="${target_part##*:}"
            repo_part="${target_part%:*}"
          else
            repo_part="$target_part"
          fi
          
          # å¤„ç†å‘½åç©ºé—´
          if [[ "$repo_part" == *"/*" ]]; then
            echo "âŒ æ— æ•ˆçš„å‘½åç©ºé—´æ ¼å¼ï¼š$repo_part"
            continue
          elif [[ "$repo_part" == *"/"* ]]; then
            target_user="${repo_part%%/*}"
            target_image="${repo_part#*/}"
          else
            target_image="$repo_part"
          fi
          
          final_target="${target_user}/${target_image}:${target_tag}"
          
          # éªŒè¯ç›®æ ‡æ ¼å¼
          if [[ ! "$final_target" =~ ^[a-zA-Z0-9_.-]+/[a-zA-Z0-9_.-]+:[a-zA-Z0-9_.-]+$ ]]; then
            echo "âŒ æ— æ•ˆçš„ç›®æ ‡é•œåƒæ ¼å¼ï¼š$final_target"
            continue
          fi

          # åŒæ­¥æµç¨‹
          echo "ğŸ”„ åŒæ­¥ä»»åŠ¡ï¼š$src_image â‡’ $final_target"
          if ! docker pull -q "$src_image"; then
            echo "âŒ æ— æ³•æ‹‰å–æºé•œåƒ"
            continue
          fi
          
          src_id=$(docker inspect --format '{{.Id}}' "$src_image")
          if docker pull -q "$final_target" 2>/dev/null; then
            target_id=$(docker inspect --format '{{.Id}}' "$final_target")
          else
            target_id="missing"
          fi
          
          if [[ "$src_id" != "$target_id" ]]; then
            echo "ğŸš€ æ£€æµ‹åˆ°æ›´æ–°ï¼Œå¼€å§‹åŒæ­¥..."
            docker tag "$src_image" "$final_target"
            docker push "$final_target"
          else
            echo "âœ… é•œåƒå·²æ˜¯æœ€æ–°"
          fi

          echo "---------------------------------------"
        done
