name: é•œåƒåŒæ­¥å·¥ä½œæµ

on:
  workflow_dispatch:
  schedule: 
    - cron: '0 2 * * *'

jobs:
  docker-sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è§„åˆ™é¢„å¤„ç†
        id: setup
        run: |
          CLEANED_RULES=$(echo "${{ vars.SYNC_MAPPINGS }}" | 
            tr ',' '\n' |
            sed -E 's/[[:space:]]+//g; /^$/d' |
            sort -u
          )
          echo "SYNC_RULES<<EOF" >> $GITHUB_ENV
          echo "$CLEANED_RULES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "=== æœ‰æ•ˆè§„åˆ™ ($(echo "$CLEANED_RULES" | wc -l) æ¡) ==="
          echo "$CLEANED_RULES"

      - name: ç™»å½•DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: é…ç½®é«˜æ€§èƒ½æ„å»ºç¯å¢ƒ
        uses: docker/setup-buildx-action@v3
        id: buildx
        with:
          driver: docker-container
          driver-opts: |
            image=moby/buildkit:master
            network=host
          buildkitd-config-inline: |
            [registry."docker.io"]
              mirrors = ["dockerpull.cn"]
            [worker.oci]
              max-parallelism = 4

      - name: æ‰§è¡Œæ™ºèƒ½é•œåƒåŒæ­¥
        env:
          DOCKERHUB_USER: "${{ secrets.DOCKERHUB_USERNAME }}"
        run: |
          export BUILDKIT_PROGRESS=plain
          failed_rules=()
          SYNC_EXECUTED=0  # å®é™…æ‰§è¡ŒåŒæ­¥çš„æ•°é‡
          SYNC_SKIPPED=0   # è·³è¿‡åŒæ­¥çš„æ•°é‡
          
          while IFS= read -r rule; do
            [[ -z "$rule" ]] && continue
            echo "=== å¤„ç†è§„åˆ™: $rule ==="
            
            #======= åˆå§‹åŒ–å‚æ•° =======#
            src_image="${rule%%=*}"
            target_spec="${rule#*=}"
            target_spec="${target_spec/#docker.io\//}"
            if [[ "$target_spec" != *":"* ]]; then
              target_spec+=":$(awk -F':' '{print $2}' <<<"$src_image" | grep -v ^$ || echo latest)"
            fi
            [[ "$target_spec" != *"/"* ]] && target_spec="$DOCKERHUB_USER/$target_spec"
            SYNC_FLAG=false  # æ ‡è®°æ˜¯å¦æ‰§è¡Œäº†åŒæ­¥æ“ä½œ

            #======= æ¶æ„æ£€æµ‹ =======#
            echo "=== æ¶æ„æ£€æŸ¥ ==="
            # æºé•œåƒæ¶æ„
            raw_src_platforms=$(docker buildx imagetools inspect "$src_image" 2>/dev/null | grep 'Platform:')
            echo "[æºé•œåƒ] $src_image æ¶æ„ä¿¡æ¯ï¼š"
            echo "$raw_src_platforms"
            src_platforms=$(echo "$raw_src_platforms" | \
              sed -E 's/Platform: //g; s/, /\n/g' | \
              tr -d ' ' | \
              sed -e '/^unknown\/unknown$/d' -e '/^$/d' | \
              sort -u | awk 'NF')
            echo "æœ‰æ•ˆæ¶æ„ ($(echo "$src_platforms" | wc -l) ç§ï¼‰ï¼š"
            printf '  - %s\n' $src_platforms
            [[ -z "$src_platforms" ]] && { echo "âŒ è·å–æºé•œåƒæ¶æ„å¤±è´¥"; failed_rules+=("$rule"); continue; }

            # ç›®æ ‡é•œåƒæ¶æ„
            raw_target_platforms=$(docker buildx imagetools inspect "$target_spec" 2>/dev/null | grep 'Platform:')
            echo "[ç›®æ ‡é•œåƒ] $target_spec æ¶æ„ä¿¡æ¯ï¼š"
            [[ -n "$raw_target_platforms" ]] && echo "$raw_target_platforms" || echo "æœªæ‰¾åˆ°ç›®æ ‡é•œåƒ"
            target_platforms=$(echo "$raw_target_platforms" | \
              sed -E 's/Platform: //g; s/, /\n/g' | \
              tr -d ' ' | \
              sed -e '/^unknown\/unknown$/d' -e '/^$/d' | \
              sort -u | awk 'NF')
            [[ -n "$target_platforms" ]] && count_target=$(echo "$target_platforms" | wc -l) || count_target=0
            echo "æœ‰æ•ˆæ¶æ„ ($count_target ç§ï¼‰"

            #======= åŒæ­¥ç­–ç•¥ =======#
            if [[ -z "$target_platforms" ]]; then
              # åœºæ™¯1ï¼šå…¨æ–°åˆ›å»ºé•œåƒ
              echo "ğŸ†• åˆå§‹åŒ–åˆ›å»ºé•œåƒ..."
              timeout 300 docker buildx imagetools create -t "$target_spec" "$src_image"
              SYNC_FLAG=true
            else
              # åœºæ™¯2ï¼šå¢é‡åŒæ­¥ç¼ºå¤±æ¶æ„
              missing_platforms=()
              while read -r platform; do
                ! grep -qxF "$platform" <<< "$target_platforms" && missing_platforms+=("$platform")
              done <<< "$src_platforms"

              if (( ${#missing_platforms[@]} > 0 )); then
                echo "ğŸ”„ ç¼ºå¤±æ¶æ„ (${#missing_platforms[@]} ç§ï¼‰ï¼š"
                printf '  - %s\n' "${missing_platforms[@]}"
                echo "å°è¯•å¢é‡åŒæ­¥..."
                timeout 300 docker buildx imagetools create -t "$target_spec" "$src_image" --append || {
                  echo "â­ï¸ å¢é‡åŒæ­¥å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶è¦†ç›–..."
                  timeout 300 docker buildx imagetools create -t "$target_spec" "$src_image" --force
                }
                SYNC_FLAG=true
              else
                echo "âœ… æ¶æ„å·²å®Œæ•´ï¼Œæ— éœ€åŒæ­¥"
                SYNC_FLAG=false
              fi
            fi

            #======= ç»“æœéªŒè¯ =======#
            sync_result=$?
            # è·å–æœ€ç»ˆæ¶æ„
            final_platforms=$(docker buildx imagetools inspect "$target_spec" 2>/dev/null | \
              grep 'Platform:' | \
              sed -E 's/Platform: //g; s/, /\n/g' | \
              tr -d ' ' | \
              sed -e '/^unknown\/unknown$/d' -e '/^$/d' | \
              sort -u | awk 'NF')

            if [ -n "$final_platforms" ] && ! comm -23 <(echo "$src_platforms" | sort) <(echo "$final_platforms" | sort) | grep -q .; then
              if $SYNC_FLAG; then
                echo "âœ… åŒæ­¥æˆåŠŸ (æ‰§è¡Œå˜æ›´)"
                SYNC_EXECUTED=$((SYNC_EXECUTED+1))
              else
                echo "âœ… åŒæ­¥æˆåŠŸ (æ— éœ€å˜æ›´)"
                SYNC_SKIPPED=$((SYNC_SKIPPED+1)) 
              fi
              # è¾“å‡ºå¹³å°è¯¦æƒ…
              echo "æœ€ç»ˆæ¶æ„è¯¦æƒ…ï¼š"
              docker buildx imagetools inspect "$target_spec" | grep -E 'Platform:|Size:' | grep -v 'unknown/unknown'
            else
              echo "âŒ æœ€ç»ˆéªŒè¯å¤±è´¥"
              failed_rules+=("$rule")
              # è¯Šæ–­ä¿¡æ¯
              [[ $sync_result -eq 0 ]] && {
                missing=$(comm -23 <(echo "$src_platforms" | sort) <(echo "$final_platforms" | sort))
                echo "æœªåŒæ­¥æ¶æ„ï¼š"
                echo "$missing"
              }
            fi

            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          done <<< "$SYNC_RULES"

          #======= ç”ŸæˆæŠ¥å‘Š =======#
          total_rules=$(echo "$SYNC_RULES" | wc -l | tr -d ' ')
          echo "=== åŒæ­¥ç»“æœæŠ¥å‘Š ==="
          echo "å¤„ç†è§„åˆ™æ€»æ•°: $total_rules é¡¹"
          echo "æˆåŠŸæ‰§è¡ŒåŒæ­¥: $SYNC_EXECUTED é¡¹"
          echo "è·³è¿‡æ— éœ€åŒæ­¥: $SYNC_SKIPPED é¡¹"
          echo "å¤±è´¥å¤„ç†è§„åˆ™: ${#failed_rules[@]} é¡¹"
          if (( ${#failed_rules[@]} > 0 )); then
            printf "å¤±è´¥åˆ—è¡¨:\n  - %s\n" "${failed_rules[@]}"
            exit 1
          fi
