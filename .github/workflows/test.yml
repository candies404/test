name: Docker Image Sync

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  docker-sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup sync rules
      id: setup
      run: |
        # æ¸…æ´—è§„åˆ™ï¼Œå»é™¤ç©ºæ ¼å’Œç©ºè¡Œ
        CLEANED_RULES=$(echo "${{ vars.SYNC_MAPPINGS }}" |
          tr '\n' ',' |                  # å°†æ¢è¡Œæ›¿æ¢ä¸ºé€—å·
          sed -E 's/,+/ /g; s/^ +| +$//g' |  # å¤šä¸ªé€—å·è½¬ä¸ºç©ºæ ¼ï¼Œå¹¶å»é™¤é¦–å°¾ç©ºæ ¼
          tr ' ' '\n' |                  # ç©ºæ ¼è½¬ä¸ºæ¢è¡Œ
          grep -v '^$'                   # åˆ é™¤ç©ºè¡Œ
        )
        # å¯¼å‡ºå¤„ç†åçš„è§„åˆ™åˆ°ç¯å¢ƒå˜é‡
        echo "SYNC_RULES<<EOF" >> $GITHUB_ENV
        echo "$CLEANED_RULES" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Login Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Process images
      env:
        DOCKERHUB_USER: "${{ secrets.DOCKERHUB_USERNAME }}"  # ä»æœºå¯†å˜é‡è·å–ç”¨æˆ·å
      run: |
        IFS=$'\n'
        for rule in $SYNC_RULES; do
          [[ -z "$rule" ]] && continue

          echo "=== å¤„ç†è§„åˆ™: $rule ==="

          # åˆ†å‰²æºé•œåƒå’Œç›®æ ‡éƒ¨åˆ†
          if ! IFS="=" read -r src_image target_part <<< "$rule"; then
            echo "âš ï¸ è§„åˆ™æ ¼å¼é”™è¯¯ï¼Œè·³è¿‡"
            continue
          fi

          # è§£æç›®æ ‡æ ‡ç­¾
          target_tag="latest"
          if [[ "$target_part" == *":"* ]]; then
            target_tag="${target_part##*:}"
            repo_part="${target_part%:*}"
          else
            repo_part="$target_part"
          fi

          # å¤„ç†å‘½åç©ºé—´
          if [[ "$repo_part" != *"/"* ]]; then
            # ä½¿ç”¨æœºå¯†å˜é‡ä¸­çš„ç”¨æˆ·åä½œä¸ºé»˜è®¤å‘½åç©ºé—´
            target_user="$DOCKERHUB_USER"
            target_image="$repo_part"
          else
            # åˆ†å‰²ç”¨æˆ·å’Œé•œåƒå
            target_user="${repo_part%%/*}"
            target_image="${repo_part#*/}"
            # éªŒè¯ç”¨æˆ·åæ˜¯å¦åˆæ³•
            if ! [[ "$target_user" =~ ^[a-z0-9]+([._-][a-z0-9]+)*$ ]]; then
              echo "âŒ éæ³•ç”¨æˆ·å: $target_user"
              continue
            fi
          fi

          final_target="${target_user}/${target_image}:${target_tag}"

          # éªŒè¯ç›®æ ‡é•œåƒæ ¼å¼
          if ! [[ "$final_target" =~ ^[a-z0-9]+([._-][a-z0-9]+)*/[a-z0-9]+([._-][a-z0-9]+)*(:[a-zA-Z0-9_.-]+)?$ ]]; then
            echo "âŒ éæ³•çš„é•œåƒæ ¼å¼: $final_target"
            continue
          fi

          echo "ğŸ”„ åŒæ­¥ä¸­: $src_image â†’ $final_target"

          # æ‹‰å–æºé•œåƒ
          if ! docker pull -q "$src_image"; then
            echo "âŒ æ— æ³•æ‹‰å–æºé•œåƒ"
            continue
          fi

          # æ‹‰å–ç›®æ ‡é•œåƒä»¥æ£€æŸ¥æ˜¯å¦å­˜åœ¨
          if docker pull -q "$final_target" 2>/dev/null; then
            target_exists=true
          else
            target_exists=false
          fi

          # è·å–é•œåƒIDè¿›è¡Œæ¯”è¾ƒ
          src_id=$(docker inspect -f '{{.Id}}' "$src_image")
          if $target_exists; then
            target_id=$(docker inspect -f '{{.Id}}' "$final_target")
          else
            target_id=""
          fi

          # åˆ¤æ–­æ˜¯å¦éœ€è¦åŒæ­¥
          if [[ "$src_id" != "$target_id" ]]; then
            echo "ğŸš€ æ£€æµ‹åˆ°å˜æ›´ï¼Œå¼€å§‹åŒæ­¥..."
            docker tag "$src_image" "$final_target"
            if docker push -q "$final_target" 2>/dev/null; then
              echo "âœ… åŒæ­¥æˆåŠŸ"
            else
              echo "âŒ æ¨é€å¤±è´¥"
            fi
          else
            echo "âœ… é•œåƒå·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ“ä½œ"
          fi

          echo "---------------------------------------"
        done
