name: é•œåƒåŒæ­¥å·¥ä½œæµ

on:
  workflow_dispatch:
  schedule: 
    - cron: '0 2 * * *'

jobs:
  docker-sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è§„åˆ™é¢„å¤„ç†
        id: setup
        run: |
          CLEANED_RULES=$(echo "${{ vars.SYNC_MAPPINGS }}" | 
            tr ',' '\n' |
            sed -E 's/[[:space:]]+//g; /^$/d' |
            sort -u
          )
          echo "SYNC_RULES<<EOF" >> $GITHUB_ENV
          echo "$CLEANED_RULES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "=== æœ‰æ•ˆè§„åˆ™ ($(echo "$CLEANED_RULES" | wc -l) æ¡) ==="
          echo "$CLEANED_RULES"

      - name: å®‰è£…ä¾èµ–å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo jq

      - name: ç™»å½•DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: é…ç½®é«˜æ€§èƒ½æ„å»ºç¯å¢ƒ
        uses: docker/setup-buildx-action@v3
        id: buildx
        with:
          driver: docker-container
          driver-opts: |
            image=moby/buildkit:master
            network=host
          buildkitd-config-inline: |
            [registry."docker.io"]
              mirrors = ["dockerpull.cn"]
            [worker.oci]
              max-parallelism = 4

      - name: æ‰§è¡Œæ™ºèƒ½é•œåƒåŒæ­¥
        env:
          DOCKERHUB_USER: "${{ secrets.DOCKERHUB_USERNAME }}"
        run: |
          export BUILDKIT_PROGRESS=plain
          failed_rules=()
          SYNC_EXECUTED=0
          SYNC_SKIPPED=0

          # å¢å¼ºç‰ˆæ¶æ„è§£æå‡½æ•°
          get_platforms() {
            local image_ref=$1
            local raw_data=$(skopeo inspect --raw "docker://$image_ref" 2>&1 || true)
            local inspect_data=$(skopeo inspect "docker://$image_ref" 2>/dev/null || echo '{}')
            
            echo "è§£ææ¶æ„ä¿¡æ¯ [åŸå§‹æ•°æ®é•¿åº¦: ${#raw_data}]" >&2

            # å¤šæ¶æ„æ£€æµ‹é€»è¾‘
            if echo "$raw_data" | jq -e '.manifests and (.mediaType // "" | contains("manifest.list"))' >/dev/null; then
              echo "$raw_data" | jq -r '
                .manifests[] | 
                .platform as $p |
                select(
                  ($p.os != null) and 
                  ($p.architecture != null) and 
                  ($p.os != "unknown") and 
                  ($p.architecture != "unknown")
                ) |
                "\($p.os)/\($p.architecture)" +
                (if $p.variant and $p.variant != "" then "/\($p.variant)" else "" end)
              ' | sort -u | tee /dev/stderr
              return
            fi

            # å•æ¶æ„å¤„ç†é€»è¾‘
            os=$(echo "$inspect_data" | jq -r '.Os // "linux"')
            arch=$(echo "$inspect_data" | jq -r '.Architecture // "unknown"')
            variant=$(echo "$inspect_data" | jq -r '.Variant? // ""')
            
            # åŸå§‹æ•°æ®å›é€€è§£æ
            if [[ "$arch" == "unknown" ]] && [[ -n "$raw_data" ]]; then
              os=$(echo "$raw_data" | jq -r '.os // "linux"')
              arch=$(echo "$raw_data" | jq -r '.architecture // empty')
              variant=$(echo "$raw_data" | jq -r '.variant? // empty')
            fi

            # ARMæ¶æ„å˜ä½“ä¿®æ­£ (å…¼å®¹ä¸åŒæ ‡ç­¾æ ¼å¼)
            if [[ "$arch" == "arm" && "$variant" =~ ^v?[0-9]+$ ]]; then
              variant="${variant//v/}"
            fi

            # æ¶æ„æœ‰æ•ˆæ€§éªŒè¯
            if [[ "$arch" == "unknown" ]] || [[ -z "$arch" ]]; then
              echo "[è­¦å‘Š] æ— æ³•è¯†åˆ«æ¶æ„ï¼š$image_ref" >&2
              return
            fi

            # æ ¼å¼åŒ–è¾“å‡ºæ¶æ„ä¿¡æ¯
            platform_str="${os}/${arch}"
            [[ -n "$variant" ]] && platform_str+="/${variant}"
            echo "$platform_str" | grep -vE 'unknown|^$' | sort -u
          }

          check_image_exists() {
            timeout 10 skopeo inspect "docker://$1" >/dev/null 2>&1
          }

          while IFS= read -r rule; do
            [[ -z "$rule" ]] && continue
            echo "=== ğŸ› ï¸ å¤„ç†è§„åˆ™: $rule ==="

            # å‚æ•°è§£æé€»è¾‘ä¿æŒä¸å˜...

            #======= å¢å¼ºç‰ˆæ¶æ„åˆ†æ =======#
            echo "ğŸ” æ ¡éªŒæºé•œåƒæ¶æ„..."
            src_platforms=$(get_platforms "$src_image")
            if [[ -z "$src_platforms" ]]; then
              echo "âŒ æºé•œåƒæ¶æ„è§£æå¤±è´¥" 
              failed_rules+=("$rule")
              continue
            fi

            echo "ğŸ” æºæ¶æ„æ”¯æŒ ($(wc -w <<< "$src_platforms") ç§):"
            echo "$src_platforms" | sed 's/^/  â–¸ /'

            #======= ç›®æ ‡é•œåƒå­˜åœ¨æ€§æ£€æŸ¥ =======#
            echo "âœ³ï¸ åˆ†æç›®æ ‡é•œåƒ $final_spec ..."
            target_platforms=""
            if check_image_exists "$final_spec"; then
              echo "æ£€æµ‹åˆ°ç›®æ ‡é•œåƒå­˜åœ¨ï¼Œå¼€å§‹è§£ææ¶æ„..."
              target_platforms=$(get_platforms "$final_spec")
              
              if [[ -z "$target_platforms" ]]; then
                echo "âš ï¸ ç›®æ ‡é•œåƒå­˜åœ¨ä½†æ¶æ„è§£æå¤±è´¥ï¼Œå¯èƒ½ä¸æ˜¯å¤šæ¶æ„é•œåƒ" 
                # å°è¯•äºŒæ¬¡éªŒè¯ï¼šå¼ºåˆ¶æ¨å•ä¸ªæ¶æ„
                timeout 30 skopeo copy --format v2s2 "docker://$src_image" "docker://$final_spec" && {
                  echo "ğŸ”„ å¼ºåˆ¶æ¨é€å•æ¶æ„é•œåƒæˆåŠŸ"
                  SYNC_EXECUTED=$((SYNC_EXECUTED+1))
                  continue
                } || {
                  echo "âŒ å¼ºåˆ¶æ¨é€å¤±è´¥" 
                  failed_rules+=("$rule")
                  continue
                }
              fi
            else
              echo "ğŸ†• ç›®æ ‡é•œåƒä¸å­˜åœ¨ï¼Œéœ€è¦åˆå§‹åŒ–"
            fi

            # åŸæœ‰åŒæ­¥ç­–ç•¥é€»è¾‘ä¿æŒä¸å˜...

            #======= æ™ºèƒ½ç»“æœéªŒè¯ =======#
            if [[ -n "$target_platforms" ]]; then
              final_platforms=$(get_platforms "$final_spec")
              missing_check=$(comm -23 <(echo "$src_platforms" | sort) <(echo "$final_platforms" | sort))
              
              if [[ -n "$missing_check" ]]; then
                echo "âŒ åŒæ­¥åä»æœ‰ç¼ºå¤±æ¶æ„:"
                echo "$missing_check" | sed 's/^/  â–¸ /'
                failed_rules+=("$rule")
              else
                echo "âœ… æ¶æ„ä¸€è‡´æ€§éªŒè¯é€šè¿‡" 
              fi
            else
              echo "âš ï¸ è·³è¿‡æœ€ç»ˆéªŒè¯ï¼ˆæ— æœ‰æ•ˆæ¶æ„ä¿¡æ¯ï¼‰"
            fi
          done <<< "$SYNC_RULES"
          #======= ç”ŸæˆæŠ¥å‘Š =======#
          total_rules=$(echo "$SYNC_RULES" | wc -l | tr -d ' ')
          echo "ğŸ“Š=== æ‰§è¡ŒæŠ¥å‘Š ==="
          echo "ğŸ”¢ è§„åˆ™æ€»æ•° | $total_rules"
          echo "ğŸŸ© æˆåŠŸåŒæ­¥ | $SYNC_EXECUTED"
          echo "ğŸŸ¨ è·³è¿‡åŒæ­¥ | $SYNC_SKIPPED"
          echo "ğŸŸ¥ å¤±è´¥è§„åˆ™ | ${#failed_rules[@]}"
          if ((${#failed_rules[@]} > 0)); then
            echo "ğŸ”¥ å¤±è´¥è§„åˆ™åˆ—è¡¨ï¼š"
            printf "  â€¼ï¸ %s\n" "${failed_rules[@]}"
            exit 1
          fi
