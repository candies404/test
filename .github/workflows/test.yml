name: é•œåƒåŒæ­¥å·¥ä½œæµ

on:
  workflow_dispatch:
  schedule: 
    - cron: '0 2 * * *'

jobs:
  docker-sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è§„åˆ™é¢„å¤„ç†
        id: setup
        run: |
          CLEANED_RULES=$(echo "${{ vars.SYNC_MAPPINGS }}" | 
            tr ',' '\n' |
            sed -E 's/[[:space:]]+//g; /^$/d' |
            sort -u
          )
          echo "SYNC_RULES<<EOF" >> $GITHUB_ENV
          echo "$CLEANED_RULES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "=== æœ‰æ•ˆè§„åˆ™ ($(echo "$CLEANED_RULES" | wc -l) æ¡) ==="
          echo "$CLEANED_RULES"

      - name: å®‰è£…ä¾èµ–å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo jq

      - name: ç™»å½•DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: é…ç½®é«˜æ€§èƒ½æ„å»ºç¯å¢ƒ
        uses: docker/setup-buildx-action@v3
        id: buildx
        with:
          driver: docker-container
          driver-opts: |
            image=moby/buildkit:master
            network=host
          buildkitd-config-inline: |
            [registry."docker.io"]
              mirrors = ["dockerpull.cn"]
            [worker.oci]
              max-parallelism = 4

      - name: æ‰§è¡Œæ™ºèƒ½é•œåƒåŒæ­¥
        env:
          DOCKERHUB_USER: "${{ secrets.DOCKERHUB_USERNAME }}"
        run: |
          export BUILDKIT_PROGRESS=plain
          failed_rules=()
          SYNC_EXECUTED=0
          SYNC_SKIPPED=0

          # å¢å¼ºç‰ˆæ¶æ„è§£æå‡½æ•°
          get_platforms() {
            local raw_data="$1"
            [[ -z "$raw_data" ]] && return

            # å¤„ç†å¤šæ¶æ„é•œåƒ
            if echo "$raw_data" | jq -e '.manifests' >/dev/null; then
              echo "$raw_data" | jq -r '
                .manifests[] | 
                .platform as $p |
                select(
                  ($p.os != null) and 
                  ($p.architecture != null) and 
                  ($p.os != "unknown") and 
                  ($p.architecture != "unknown")
                ) |
                "\($p.os)/\($p.architecture)" +
                (if $p.variant and $p.variant != "" then "/\($p.variant)" else "" end)
              ' | sort -u
            else
              # å¤„ç†å•æ¶æ„é•œåƒçš„å¤šæ ¼å¼å…¼å®¹
              if echo "$raw_data" | jq -e '.architecture' >/dev/null; then
                os=$(echo "$raw_data" | jq -r '.os // "linux"')
                arch=$(echo "$raw_data" | jq -r '.architecture')
                variant=$(echo "$raw_data" | jq -r '.variant // ""')
                
                # ARMæ¶æ„å˜ä½“è‡ªåŠ¨ä¿®æ­£
                [[ "$arch" == "arm" && "$variant" =~ ^v[0-9]+$ ]] && variant="${variant#v}"
                [[ "$arch" == "amd64" ]] && variant=""
                
                echo "${os}/${arch}${variant:+/$variant}"
              else
                # å…¼å®¹Docker v2 manifestæ ¼å¼
                echo "$raw_data" | jq -r '
                  if .mediaType? == "application/vnd.docker.distribution.manifest.v2+json" then
                    "linux/\(.architecture // "unknown")"
                  else
                    empty
                  end
                ' | grep -v "unknown"
              fi
            fi | grep -vE 'unknown|^$' | sort -u
          }

          check_image_exists() {
            skopeo inspect "docker://$1" >/dev/null 2>&1
          }

          while IFS= read -r rule; do
            [[ -z "$rule" ]] && continue
            echo "=== ğŸ› ï¸ å¤„ç†è§„åˆ™: $rule ==="

            #======= å‚æ•°è§£æ =======#
            src_image="${rule%%=*}"
            target_spec="${rule#*=}"
            target_spec="${target_spec/#docker.io\//}"

            # å¤„ç†æºé•œåƒæ ‡ç­¾
            if [[ "$src_image" == *":"* ]]; then
              src_tag="${src_image##*:}"
              src_name="${src_image%:*}"
            else
              src_tag="latest"
              src_name="$src_image"
            fi

            # ç›®æ ‡specå¤„ç†
            if [[ "$target_spec" == *":"* ]]; then
              target_tag="${target_spec##*:}"
              target_base="${target_spec%:*}"
            else
              target_base="$target_spec"
              target_tag="$src_tag"
            fi

            # è‡ªåŠ¨è¡¥å…¨ç”¨æˆ·å‰ç¼€
            final_spec="$target_base"
            [[ ! "$final_spec" == *"/"* ]] && final_spec="$DOCKERHUB_USER/$final_spec"
            final_spec+=":$target_tag"

            #======= æ¶æ„åˆ†æ =======#
            echo "ğŸ” æ ¡éªŒæºé•œåƒ $src_image ..."
            raw_src_data=$(skopeo inspect --raw "docker://$src_image" 2>&1 || true)
            src_platforms=$(get_platforms "$raw_src_data")
            if [[ -z "$src_platforms" ]]; then
              echo "âŒ æ— æ³•è·å–æºé•œåƒæ¶æ„ä¿¡æ¯:"
              grep -i 'error' <<< "$raw_src_data" | head -n3
              failed_rules+=("$rule")
              continue
            fi

            echo "ğŸ” æºé•œåƒæ”¯æŒæ¶æ„ ($(echo "$src_platforms" | wc -w) ç§)"
            echo "$src_platforms" | sed 's/^/  â¤ /'

            #======= ç›®æ ‡é•œåƒåˆ†æ =======#
            echo "âœ³ï¸ æ ¡éªŒç›®æ ‡é•œåƒ $final_spec ..."
            if check_image_exists "$final_spec"; then
              raw_target_data=$(skopeo inspect --raw "docker://$final_spec" 2>&1 || true)
              target_platforms=$(get_platforms "$raw_target_data")
              [[ -z "$target_platforms" ]] && echo "âš ï¸ ç›®æ ‡é•œåƒå­˜åœ¨ä½†æ— æ³•è§£ææ¶æ„"
            else
              echo "ğŸ” ç›®æ ‡é•œåƒä¸å­˜åœ¨ï¼Œå°†è¿›è¡Œåˆå§‹åŒ–"
              target_platforms=""
            fi

            echo "ğŸ“¦ å½“å‰ç›®æ ‡é•œåƒæ¶æ„ ($(echo "$target_platforms" | wc -w || echo 0) ç§)"
            [[ -n "$target_platforms" ]] && echo "$target_platforms" | sed 's/^/  â¤ /'

            #======= åŒæ­¥ç­–ç•¥ =======#
            if [[ -z "$target_platforms" ]]; then
              echo "ğŸ†• åˆå§‹åŒ–ç›®æ ‡é•œåƒ..."
              timeout 300 docker buildx imagetools create -t "$final_spec" "$src_image" || {
                echo "âŒ åˆå§‹åŒ–å¤±è´¥"; 
                failed_rules+=("$rule");
                continue
              }
              SYNC_EXECUTED=$((SYNC_EXECUTED+1))
            else
              missing_platforms=$(comm -23 <(echo "$src_platforms" | sort) <(echo "$target_platforms" | sort))
              if [[ -n "$missing_platforms" ]]; then
                echo "ğŸ”„ ç¼ºå¤±æ¶æ„ ($(wc -l <<< "$missing_platforms") ç§)" 
                echo "$missing_platforms" | sed 's/^/  â¤ /'
                timeout 300 docker buildx imagetools create -t "$final_spec" "$src_image" --append || {
                  echo "âš¡ å¢é‡åŒæ­¥å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶è¦†ç›–..."
                  timeout 300 docker buildx imagetools create -t "$final_spec" "$src_image" --force
                }
                SYNC_EXECUTED=$((SYNC_EXECUTED+1))
              else
                echo "â­ï¸ å·²åŒ…å«å…¨éƒ¨æ¶æ„ï¼Œæ— éœ€åŒæ­¥"
                SYNC_SKIPPED=$((SYNC_SKIPPED+1))
              fi
            fi

            #======= ç»“æœéªŒè¯ =======#
            raw_final_data=$(skopeo inspect --raw "docker://$final_spec" 2>&1 || true)
            final_platforms=$(get_platforms "$raw_final_data")
            missing_check=$(comm -23 <(echo "$src_platforms" | sort) <(echo "$final_platforms" | sort))

            echo "âœ… æœ€ç»ˆæ ¡éªŒç»“æœï¼š"
            if [[ -n "$missing_check" ]]; then
              echo "âŒ ç¼ºå¤±æ¶æ„ ($(wc -l <<< "$missing_check") ç§)"
              echo "$missing_check" | sed 's/^/  â–¸ /'
              failed_rules+=("$rule")
            else
              echo "âœ”ï¸ æ‰€æœ‰æ¶æ„å·²åŒæ­¥å®Œæˆ"
              skopeo inspect "docker://$final_spec" | jq '
                {
                  OS: .Os,
                  Architecture: .Architecture,
                  Variant: (if .Variant == "" then null else .Variant end),
                  Created: .Created
                }' | awk ' 
                  /:/ { 
                    key=$1; gsub(/"/, "", key); 
                    value=$0; sub(/^[^:]+: /, "", value); 
                    printf "  ğŸ·ï¸  %-12s %s\n", key, value 
                  }'
            fi

            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          done <<< "$SYNC_RULES"

          #======= ç”ŸæˆæŠ¥å‘Š =======#
          total_rules=$(echo "$SYNC_RULES" | wc -l | tr -d ' ')
          echo "ğŸ“Š=== æ‰§è¡ŒæŠ¥å‘Š ==="
          echo "ğŸ”¢ è§„åˆ™æ€»æ•° | $total_rules"
          echo "ğŸŸ© æˆåŠŸåŒæ­¥ | $SYNC_EXECUTED"
          echo "ğŸŸ¨ è·³è¿‡åŒæ­¥ | $SYNC_SKIPPED"
          echo "ğŸŸ¥ å¤±è´¥è§„åˆ™ | ${#failed_rules[@]}"
          if ((${#failed_rules[@]} > 0)); then
            echo "ğŸ”¥ å¤±è´¥è§„åˆ™åˆ—è¡¨ï¼š"
            printf "  â€¼ï¸ %s\n" "${failed_rules[@]}"
            exit 1
          fi
