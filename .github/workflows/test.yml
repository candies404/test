name: é•œåƒåŒæ­¥å·¥ä½œæµ

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:  # å®šæ—¶ä»»åŠ¡
    - cron: '0 2 * * *'  # æ¯æ—¥UTC 2ç‚¹æ‰§è¡Œ

jobs:
  docker-sync:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è§„åˆ™é¢„å¤„ç†
      id: setup
      run: |
        CLEANED_RULES=$(echo "${{ vars.SYNC_MAPPINGS }}" | 
          tr ',' '\n' |
          sed -E 's/[[:space:]]+//g; /^$/d' |
          sort -u
        )
        echo "SYNC_RULES<<EOF" >> $GITHUB_ENV
        echo "$CLEANED_RULES" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        echo "=== æœ‰æ•ˆè§„åˆ™ ($(echo "$CLEANED_RULES" | wc -l) æ¡) ==="
        echo "$CLEANED_RULES"

    - name: ç™»å½•DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: é…ç½®é«˜æ€§èƒ½æ„å»ºç¯å¢ƒ
      uses: docker/setup-buildx-action@v3
      id: buildx
      with:
        driver: docker-container
        driver-opts: |
          image=moby/buildkit:master
          network=host
        buildkitd-config-inline: |
          [registry."docker.io"]
            mirrors = ["dockerpull.cn"]
          [worker.oci]
            max-parallelism = 4

    - name: æ‰§è¡Œæ™ºèƒ½é•œåƒåŒæ­¥
      env:
        DOCKERHUB_USER: "${{ secrets.DOCKERHUB_USERNAME }}"
      run: |
        export BUILDKIT_PROGRESS=plain
        failed_rules=()
        SUCCESS_COUNT=0
        
        while IFS= read -r rule; do
          [[ -z "$rule" ]] && continue
          echo "=== å¤„ç†è§„åˆ™: $rule ==="
          
          src_image="${rule%%=*}"
          target_spec="${rule#*=}"
          target_spec="${target_spec/#docker.io\//}"
          if [[ "$target_spec" != *":"* ]]; then
            target_spec+=":$(awk -F':' '{print $2}' <<<"$src_image" | grep -v ^$ || echo latest)"
          fi
          [[ "$target_spec" != *"/"* ]] && target_spec="$DOCKERHUB_USER/$target_spec"

          # === å¢å¼ºæ¶æ„ä¿¡æ¯æ‰“å° ===
          echo "=== æ¶æ„æ£€æŸ¥ ==="
          echo "è·å–æºé•œåƒæ¶æ„ï¼š$src_image"
          
          # æå–æºé•œåƒå¹³å°ä¿¡æ¯
          raw_src_platforms=$(docker buildx imagetools inspect "$src_image" 2>/dev/null | grep 'Platform:')
          echo "æºé•œåƒåŸå§‹å¹³å°ä¿¡æ¯ï¼š"
          echo "$raw_src_platforms"
          
          # å¤„ç†å¹³å°æ•°æ®
          src_platforms=$(echo "$raw_src_platforms" | \
            sed -E 's/Platform: //g; s/, /\n/g' | \
            tr -d ' ' | \
            sed -e '/^unknown\/unknown$/d' -e '/^$/d' | \
            sort -u | \
            awk 'NF')
          
          echo "å¤„ç†åçš„æºé•œåƒæ¶æ„ ($(echo "$src_platforms" | wc -l) ç§ï¼‰ï¼š"
          printf '  - %s\n' $src_platforms
          
          if [ -z "$src_platforms" ]; then
            echo "âŒ è·å–æºé•œåƒæ¶æ„å¤±è´¥"
            failed_rules+=("$rule")
            continue
          fi

          # === ç›®æ ‡é•œåƒå­˜åœ¨æ€§æ£€æŸ¥ ===
          echo "æ£€æŸ¥ç›®æ ‡é•œåƒå­˜åœ¨æ€§ï¼š$target_spec"
          if ! docker buildx imagetools inspect "$target_spec" &>/dev/null; then
            echo "ğŸ†• ç›®æ ‡é•œåƒä¸å­˜åœ¨ï¼Œæ‰§è¡Œå®Œæ•´åˆ›å»º"
            timeout 300 docker buildx imagetools create -t "$target_spec" "$src_image"
            
            # åŒé‡éªŒè¯åˆ›å»ºç»“æœ
            if ! docker buildx imagetools inspect "$target_spec" &>/dev/null; then
              echo "âŒ åˆå§‹åŒ–åˆ›å»ºå¤±è´¥ï¼é”™è¯¯è¯¦æƒ…ï¼š"
              docker buildx imagetools inspect "$target_spec" || true
              failed_rules+=("$rule (init-fail)")
              continue
            fi
          else
            # === å¢é‡åŒæ­¥é€»è¾‘ ===
            echo "ğŸ”„ ç›®æ ‡é•œåƒå·²å­˜åœ¨ï¼Œå¼€å§‹å¢é‡åŒæ­¥"
            
            # ç²¾ç¡®è·å–ç¼ºå¤±æ¶æ„
            missing_platforms=()
            while read -r platform; do
              if ! docker buildx imagetools inspect "$target_spec" | grep -qw "$platform"; then
                missing_platforms+=("$platform")
              fi
            done <<< "$src_platforms"

            if [ ${#missing_platforms[@]} -eq 0 ]; then
              echo "âœ… æ¶æ„å·²å®Œæ•´ï¼Œæ— éœ€åŒæ­¥"
            else
              echo "ğŸ”§ éœ€è¦æ·»åŠ æ¶æ„ï¼š${missing_platforms[*]}"
              
              # é€æ¶æ„è¿½åŠ é˜²æ­¢æ‰¹é‡é”™è¯¯
              for platform in "${missing_platforms[@]}"; do
                echo "  â• æ·»åŠ æ¶æ„ï¼š$platform"
                timeout 120 docker buildx imagetools create --append \
                  --tag "$target_spec" \
                  "$src_image" \
                  --platform "$platform"
                
                if (( $? != 0 )); then
                  echo "âš ï¸ æ¶æ„ $platform åŒæ­¥å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶è¦†ç›–"
                  timeout 120 docker buildx imagetools create --force \
                    --tag "$target_spec" \
                    "$src_image" \
                    --platform "$platform"
                fi
              done
            fi
          fi

          # === æœ€ç»ˆä¸€è‡´æ€§éªŒè¯ ===
          final_check=$(comm -23 <(echo "$src_platforms" | sort) <(docker buildx imagetools inspect "$target_spec" 2>/dev/null | 
            grep 'Platform:' | 
            sed -E 's/Platform: //g; s/, /\n/g' | tr -d ' ' | sort))
            
          if [ -z "$final_check" ]; then
            echo "âœ… æœ€ç»ˆéªŒè¯é€šè¿‡"
            SUCCESS_COUNT=$((SUCCESS_COUNT+1))
          else
            echo "âŒ æœ€ç»ˆéªŒè¯å¤±è´¥ï¼šç¼ºå°‘æ¶æ„"
            printf '  - %s\n' $final_check
            failed_rules+=("$rule")
          fi

          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
        done <<< "$SYNC_RULES"


        echo "=== åŒæ­¥ç»“æœæŠ¥å‘Š ==="
        echo "æˆåŠŸæ„å»ºé•œåƒ: $SUCCESS_COUNT æ¡"
        echo "å¤±è´¥å¤„ç†è§„åˆ™: ${#failed_rules[@]} æ¡"
        if (( ${#failed_rules[@]} > 0 )); then
          printf 'å¤±è´¥è§„åˆ™åˆ—è¡¨ï¼š\n  - %s\n' "${failed_rules[@]}"
          exit 1
        fi
