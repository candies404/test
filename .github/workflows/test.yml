name: Docker Image Sync

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'

jobs:
  docker-sync:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup sync rules
      id: setup
      run: |
        # ä»ç¯å¢ƒå˜é‡è¯»å–æ˜ å°„è§„åˆ™
        RAW_MAPPINGS="${{ vars.SYNC_MAPPINGS }}"
        
        # è½¬æ¢ä¸ºæ•°ç»„å¹¶å»é‡
        IFS=',' read -ra RULES <<< "${RAW_MAPPINGS//, /,}"
        UNIQUE_RULES=$(printf "%s\n" "${RULES[@]}" | sort -u)
        
        # ç”Ÿæˆå¤„ç†ç”¨å˜é‡
        echo "SYNC_RULES<<EOF" >> $GITHUB_ENV
        echo "$UNIQUE_RULES" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    - name: Login Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Process images
      run: |
        IFS=$'\n'
        for rule in $SYNC_RULES; do
          [[ -z "$rule" ]] && continue

          # åˆ†ç¦»æºå’Œç›®æ ‡éƒ¨åˆ†
          src_image=$(cut -d= -f1 <<< "$rule")
          target_part=$(cut -d= -f2 <<< "$rule")

          echo "ğŸ—ƒï¸ å¤„ç†è§„åˆ™ï¼š$src_image â†’ $target_part"

          # æ‹†åˆ†ç›®æ ‡ç»„ä»¶
          if [[ "$target_part" == *":"* ]]; then
            target_tag=${target_part##*:}
            target_repo=${target_part%:*}
          else
            target_tag="latest"
            target_repo=$target_part
          fi

          if [[ "$target_repo" == *"/"* ]]; then
            target_user=${target_repo%%/*}
            target_image_name=${target_repo#*/}
          else
            target_user="${{ secrets.DOCKERHUB_USERNAME }}"
            target_image_name=$target_repo
          fi

          target_image="${target_user}/${target_image_name}:${target_tag}"

          # æ‰§è¡ŒåŒæ­¥æµç¨‹
          echo "ğŸ” æºé•œåƒï¼š$src_image"
          echo "ğŸ¯ ç›®æ ‡é•œåƒï¼š$target_image"
          
          docker pull -q "$src_image"
          src_id=$(docker inspect --format '{{.Id}}' "$src_image")

          if docker pull -q "$target_image" 2>/dev/null; then
            target_id=$(docker inspect --format '{{.Id}}' "$target_image")
          else
            target_id="not_exist"
          fi

          if [[ "$src_id" != "$target_id" ]]; then
            echo "ğŸš€ å‘ç°æ›´æ–°ï¼Œæ­£åœ¨åŒæ­¥..."
            docker tag "$src_image" "$target_image"
            docker push "$target_image"
          else
            echo "âœ… å·²ç»æ˜¯æœ€æ–°ç‰ˆæœ¬"
          fi

          echo "---------------------------------------"
        done
