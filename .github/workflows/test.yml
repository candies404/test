name: é•œåƒåŒæ­¥å·¥ä½œæµ

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:  # å®šæ—¶ä»»åŠ¡
    - cron: '0 2 * * *'  # æ¯æ—¥UTC 2ç‚¹æ‰§è¡Œ

jobs:
  docker-sync:
    runs-on: ubuntu-latest
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è§„åˆ™é¢„å¤„ç†
      id: setup
      run: |
        # æ¸…ç†è¾“å…¥è§„åˆ™ï¼ˆä¼˜åŒ–ç©ºæ ¼å¤„ç†ï¼‰
        CLEANED_RULES=$(echo "${{ vars.SYNC_MAPPINGS }}" |
          tr '\n' ',' |  # æ¢è¡Œè½¬é€—å·
          sed -E 's/[[:space:]]+//g; s/,+/ /g; s/^ | $//g' |  # åˆå¹¶å†—ä½™ç©ºæ ¼å’Œé€—å·
          tr ' ' '\n' |  # ç©ºæ ¼è½¬å›è½¦
          grep -v '^$'  # è¿‡æ»¤ç©ºè¡Œ
        )
        
        # å°†å¤„ç†åçš„è§„åˆ™å­˜å…¥ç¯å¢ƒå˜é‡
        echo "SYNC_RULES<<EOF" >> $GITHUB_ENV
        echo "$CLEANED_RULES" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        
        # è¾“å‡ºè°ƒè¯•ä¿¡æ¯
        echo "=== æœ‰æ•ˆåŒæ­¥è§„åˆ™ ==="
        echo "$CLEANED_RULES"

    - name: ç™»å½•DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    # æ–°å¢ç¼“å­˜ä¼˜åŒ–éƒ¨åˆ† â€”â€” START
    - name: ç¼“å­˜Buildxé•œåƒ
      uses: actions/cache@v4
      id: buildx-cache
      with:
        path: |
          buildx-cache.tar
          buildkit-cache.tar
        key: |
          buildx-${{ github.workflow }}-${{ hashFiles(format('.github/workflows/{0}', github.workflow)) }}
          buildx-${{ github.workflow }}
      env:
        cache-version: v2  # ç¼“å­˜ç‰ˆæœ¬æ§åˆ¶

    - name: å¤„ç†Buildxä¾èµ–
      run: |
        # æ£€æµ‹å¹¶åŠ è½½ç¼“å­˜
        if [[ -f buildx-cache.tar && -f buildkit-cache.tar ]]; then
          echo "ğŸ”„ ä»ç¼“å­˜åŠ è½½é•œåƒ..."
          docker load -i buildx-cache.tar
          docker load -i buildkit-cache.tar
          echo "å·²åŠ è½½: $(docker images | grep -E 'docker/buildx|moby/buildkit')"
        else
          echo "âš¡ï¸ æ‹‰å–æœ€æ–°Buildxé•œåƒ..."
          docker pull docker.io/docker/buildx:latest
          docker pull docker.io/moby/buildkit:latest

          echo "ğŸ“¦ ä¿å­˜é•œåƒä¾›åç»­ä½¿ç”¨..."
          docker save docker/buildx:latest -o buildx-cache.tar
          docker save moby/buildkit:latest -o buildkit-cache.tar

          # æ ¡éªŒé•œåƒå®Œæ•´æ€§
          if ! docker inspect docker/buildx:latest &> /dev/null; then
            echo "âŒ é•œåƒæ ¡éªŒå¤±è´¥" >&2
            exit 1
          fi
        fi
    # ç¼“å­˜ä¼˜åŒ–éƒ¨åˆ† â€”â€” END

    - name: é…ç½®æ„å»ºç¯å¢ƒ
      uses: docker/setup-buildx-action@v3
      with:
        driver-opts: |
          image=moby/buildkit:latest
          network=host

    - name: æ‰§è¡Œé•œåƒå¤„ç†
      env:
        DOCKERHUB_USER: "${{ secrets.DOCKERHUB_USERNAME }}"
      run: |
        IFS=$'\n'  # è®¾ç½®å­—æ®µåˆ†å‰²ç¬¦
        for rule in $SYNC_RULES; do
          [[ -z "$rule" ]] && continue
          echo "=== æ­£åœ¨å¤„ç†è§„åˆ™: $rule ==="
          
          # åˆ†è§£åŸå§‹è§„åˆ™ï¼ˆå…¼å®¹SHA256æ ¼å¼ï¼‰
          if ! IFS="=" read -r src_image target_part <<< "${rule// /}"; then
            echo "âš ï¸ æ ¼å¼é”™è¯¯ï¼š$ruleï¼Œå·²è·³è¿‡"
            continue
          fi
          
          # è§£æé•œåƒæ ‡ç­¾å’Œç›®æ ‡ä»“åº“
          if [[ "$target_part" == *":"* ]]; then
            target_tag="${target_part##*:}"  # æˆªå–æ ‡ç­¾éƒ¨åˆ†
            repo_part="${target_part%:*}"    # ä¿ç•™ä»“åº“éƒ¨åˆ†
          else
            target_tag="latest"  # é»˜è®¤æœ€æ–°æ ‡ç­¾
            repo_part="$target_part"
          fi
          
          # å¤„ç†ç”¨æˆ·å‘½åç©ºé—´
          if [[ "$repo_part" == *"/"* ]]; then
            target_user="${repo_part%%/*}"   # æå–ç›®æ ‡ç”¨æˆ·
            target_image="${repo_part#*/}"   # æå–é•œåƒåç§°
            # æ ¡éªŒç”¨æˆ·åæ ¼å¼
            if [[ ! "$target_user" =~ ^[a-z0-9]+([._-][a-z0-9]+)*$ ]]; then
              echo "âŒ éæ³•ç”¨æˆ·å: $target_user"
              continue
            fi
          else
            target_user="$DOCKERHUB_USER"  # ä½¿ç”¨é»˜è®¤ç”¨æˆ·
            target_image="$repo_part"
          fi
          
          final_target="${target_user}/${target_image}:${target_tag}"
          # é•œåƒåœ°å€åˆæ³•æ€§éªŒè¯ï¼ˆæ”¯æŒåŒ…å«SHAï¼‰
          if ! [[ "$final_target" =~ ^([a-z0-9]+([._-][a-z0-9]+)*/)?[a-z0-9]+([._-][a-z0-9]+)*:[a-zA-Z0-9_.-]+$ ]]; then
            echo "âŒ éæ³•é•œåƒåœ°å€: $final_target"
            continue
          fi
          
          echo "â–· æºé•œåƒ: $src_image"
          echo "â—· ç›®æ ‡é•œåƒ: $final_target"
          echo "ğŸ”„ å¼€å§‹åŒæ­¥æ“ä½œ..."
          
          # éªŒè¯æºé•œåƒå¯è®¿é—®æ€§
          if ! docker buildx imagetools inspect "$src_image" >/dev/null 2>&1; then
            echo "âŒ æºé•œåƒä¸å¯è®¿é—®: $src_image"
            continue
          fi
          
          # æ‰§è¡Œå¤šæ¶æ„é•œåƒåŒæ­¥
          echo "ğŸš€ æ­£åœ¨åŒæ­¥å¤šå¹³å°é•œåƒ..."
          if docker buildx imagetools create -t "$final_target" "$src_image" >/dev/null 2>&1; then
            echo "âœ… åŒæ­¥æˆåŠŸ"
            echo "é•œåƒè¯¦ç»†ä¿¡æ¯ï¼š"
            docker buildx imagetools inspect "$final_target"
          else
            echo "âŒ åŒæ­¥å¤±è´¥ï¼Œé”™è¯¯è¯¦æƒ…ï¼š"
            # æ˜¾ç¤ºå®Œæ•´é”™è¯¯è¾“å‡º
            docker buildx imagetools create -t "$final_target" "$src_image"
          fi
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"    
        done
    - name: æ˜¾ç¤ºç¼“å­˜çŠ¶æ€
      if: always()
      run: |
        echo "::group::ç¼“å­˜è¯¦æƒ…"
        docker images
        ls -lh *.tar
        echo "::endgroup::"    
        echo "ç¼“å­˜å‘½ä¸­çŠ¶æ€: ${{ steps.buildx-cache.outputs.cache-hit }}"
