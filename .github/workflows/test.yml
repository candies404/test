name: é•œåƒåŒæ­¥å·¥ä½œæµ

on:
  workflow_dispatch:
  schedule: 
    - cron: '0 2 * * *'

jobs:
  docker-sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è§„åˆ™é¢„å¤„ç†
        id: setup
        run: |
          CLEANED_RULES=$(echo "${{ vars.SYNC_MAPPINGS }}" | 
            tr ',' '\n' |
            sed -E 's/[[:space:]]+//g; /^$/d' |
            sort -u
          )
          echo "SYNC_RULES<<EOF" >> $GITHUB_ENV
          echo "$CLEANED_RULES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "=== æœ‰æ•ˆè§„åˆ™ ($(echo "$CLEANED_RULES" | wc -l) æ¡) ==="
          echo "$CLEANED_RULES"

      - name: å®‰è£…ä¾èµ–å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y skopeo jq

      - name: ç™»å½•DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: é…ç½®é«˜æ€§èƒ½æ„å»ºç¯å¢ƒ
        uses: docker/setup-buildx-action@v3
        id: buildx
        with:
          driver: docker-container
          driver-opts: |
            image=moby/buildkit:master
            network=host
          buildkitd-config-inline: |
            [registry."docker.io"]
              mirrors = ["dockerpull.cn"]
            [worker.oci]
              max-parallelism = 4

      - name: æ‰§è¡Œæ™ºèƒ½é•œåƒåŒæ­¥
        env:
          DOCKERHUB_USER: "${{ secrets.DOCKERHUB_USERNAME }}"
        run: |
          export BUILDKIT_PROGRESS=plain
          failed_rules=()
          SYNC_EXECUTED=0
          SYNC_SKIPPED=0

          # å¢å¼ºå‹æ¶æ„è§£æå‡½æ•°
          get_platforms() {
            local raw_data="$1"
            [[ -z "$raw_data" ]] && return

            # æ£€æµ‹å¤šæ¶æ„æ¸…å•
            if echo "$raw_data" | jq -e '.manifests' >/dev/null; then
              # å¤šæ¶æ„å¤„ç†
              echo "$raw_data" | jq -r '
                .manifests[] | 
                select(
                  .platform.os? and 
                  .platform.architecture? and 
                  .platform.os != "unknown" and 
                  .platform.architecture != "unknown"
                ) | 
                "\(.platform.os)/\(.platform.architecture)" +
                (if .platform.variant? and .platform.variant != "" then "/\(.platform.variant)" else "" end)
              ' | sed 's|//|/|g' | sort -u
            else
              # å•æ¶æ„å¤„ç†
              inspect_info=$(echo "$raw_data" | jq '
                {
                  os: (if .os then .os else "linux" end),
                  architecture: (if .architecture then .architecture else .Architecture end),
                  variant: (if .variant then .variant else .Variant end)
                }'
              )
              
              os=$(echo "$inspect_info" | jq -r '.os')
              arch=$(echo "$inspect_info" | jq -r '.architecture')
              variant=$(echo "$inspect_info" | jq -r '.variant')
              
              # æ¶æ„åˆ«åè½¬æ¢
              case "$arch" in
                "x86_64") arch="amd64" ;;
                "aarch64") arch="arm64" ;;
                "armhf") arch="arm/v7" ;;
              esac
              
              # å˜ä½“ä¿®æ­£
              [[ "$variant" == "v8" && "$arch" == "arm64" ]] && variant=""
              [[ "$arch" == "amd64" ]] && variant=""
              
              # æ‹¼æ¥ç»“æœ
              {
                [[ "$os" != "unknown" && "$arch" != "unknown" ]] && 
                echo "${os}/${arch}${variant:+/$variant}"
              } | tr -d '#'
            fi | grep -vE 'unknown|null|^$' | sort -u
          }

          check_image_existence() {
            skopeo inspect "docker://${1}" >/dev/null 2>&1
            return $?
          }

          print_manifest_details() {
            echo "â„¹ï¸ é•œåƒè°ƒè¯•ä¿¡æ¯ [$1]:"
            skopeo inspect docker://$1 | jq '{
              mediaType: .MediaType,
              os: .Os,
              arch: .Architecture,
              variant: .Variant,
              schemaVersion: .SchemaVersion
            }' | awk ' 
              NR==1 {print "  {"} 
              /:/ { 
                key=$1; gsub(/"/, "", key); 
                value=$0; sub(/^[^:]+: /, "", value); 
                printf "    \033[36m%-10s\033[0m : %s\n", key, value 
              } 
              END {print "  }"}'
          }

          while IFS= read -r rule; do
            [[ -z "$rule" ]] && continue
            echo "=== ğŸ› ï¸ å¤„ç†è§„åˆ™: $rule ==="

            #======= å‚æ•°è§£æ =======#
            src_image="${rule%%=*}"
            target_spec="${rule#*=}"
            src_tag="${src_image#*:}"
            [[ "$src_image" == "$src_tag" ]] && src_tag="latest"
            target_tag="${target_spec#*:}"
            [[ "$target_spec" == "$target_tag" ]] && target_tag="$src_tag"
            
            # æ„å»ºæœ€ç»ˆç›®æ ‡é•œåƒ
            target_registry="docker.io"
            [[ ! "$target_spec" == *"/"* ]] && target_spec="${DOCKERHUB_USER}/${target_spec}"
            final_spec="${target_spec%:*}${target_spec##*:}:${target_tag}"

            #======= æºé•œåƒåˆ†æ =======#
            raw_src_data=$(skopeo inspect --raw "docker://${src_image}" 2>&1 || true)
            src_platforms=$(get_platforms "$raw_src_data")
            if [[ -z "$src_platforms" ]]; then
              echo "âŒ æ— æ³•è·å–æºé•œåƒæ¶æ„"
              echo "$raw_src_data" | grep -i 'error\|fatal' | head -n3
              failed_rules+=("$rule")
              continue
            fi

            #======= ç›®æ ‡é•œåƒæ£€æŸ¥ =======#
            check_image_existence "$final_spec"
            case $? in
              0)
                raw_target_data=$(skopeo inspect --raw "docker://${final_spec}")
                target_platforms=$(get_platforms "$raw_target_data")
                # ç›´æ¥è¾“å‡ºè§£æç»“æœ
                print_manifest_details "$final_spec"
                ;;
              1)
                target_platforms=""
                echo "ğŸ†• ç›®æ ‡é•œåƒä¸å­˜åœ¨éœ€åˆå§‹åŒ–"
                ;;
              *)
                echo "âš ï¸ Skopeoæ£€æŸ¥é”™è¯¯($?)ï¼Œé•œåƒçŠ¶æ€æœªçŸ¥"
                target_platforms=""
                ;;
            esac

            #======= å¯è§†åŒ–å¯¹æ¯” =======#
            echo "ğŸ·ï¸ æºé•œåƒæ¶æ„ ($(echo "$src_platforms" | wc -w))"
            echo "$src_platforms" | column -c 80 | sed 's/  / /g; s/^/  /' 
            
            if [[ -n "$target_platforms" ]]; then
              echo "ğŸ“Œ ç›®æ ‡é•œåƒå·²å­˜åœ¨æ¶æ„ ($(echo "$target_platforms" | wc -w))"
              echo "$target_platforms" | column -c 80 | sed 's/  / /g; s/^/  /'
            fi

            #======= æ™ºèƒ½åŒæ­¥ç­–ç•¥ =======#
            sync_needed="false"
            need_force="false"
            
            if [[ -z "$target_platforms" ]]; then
              # åˆå§‹åŒ–é•œåƒ
              echo "ğŸš€ æ­£åœ¨åˆå§‹åŒ–ç›®æ ‡é•œåƒ..."
              docker buildx imagetools create -t "$final_spec" "$src_image"
              SYNC_EXECUTED=$((SYNC_EXECUTED+1))
              sync_needed="true"
            else
              # å·®å¼‚å¯¹æ¯”
              missing_platforms=$(comm -23 <(echo "$src_platforms" | sort) <(echo "$target_platforms" | sort))
              extra_platforms=$(comm -13 <(echo "$src_platforms" | sort) <(echo "$target_platforms" | sort))
              
              if [[ -n "$missing_platforms" ]]; then
                echo "ğŸŸ¡ éœ€è¦è¡¥å……æ¶æ„ ($(echo "$missing_platforms" | wc -w))"
                echo "$missing_platforms" | sed 's/^/  â¤ /'
                
                # å°è¯•å¢é‡è¿½åŠ 
                if docker buildx imagetools create -t "$final_spec" "$src_image" --append; then
                  echo "âœ… å¢é‡è¿½åŠ æˆåŠŸ"
                  SYNC_EXECUTED=$((SYNC_EXECUTED+1))
                else
                  echo "ğŸ”„ å¢é‡å¤±è´¥ï¼Œå°è¯•å¼ºåˆ¶è¦†ç›–..."
                  docker buildx imagetools create -t "$final_spec" "$src_image" --force
                  SYNC_EXECUTED=$((SYNC_EXECUTED+1))
                  need_force="true"
                fi
                sync_needed="true"
              fi
              
              if [[ -n "$extra_platforms" ]]; then
                echo "âš ï¸ ç›®æ ‡é•œåƒå­˜åœ¨é¢å¤–æ¶æ„ï¼š"
                echo "$extra_platforms" | sed 's/^/  â¤ /'
              fi
            fi

            #======= æœ€ç»ˆéªŒè¯ =======#
            if [[ "$sync_needed" == "true" || "$need_force" == "true" ]]; then
              final_platforms=$(get_platforms "$(skopeo inspect --raw "docker://${final_spec}")")
              error_archs=$(comm -23 <(echo "$src_platforms" | sort) <(echo "$final_platforms" | sort))
              
              if [[ -n "$error_archs" ]]; then
                echo "ğŸ”´ æ ¡éªŒå¤±è´¥"
                failed_rules+=("$rule") 
              else
                echo "ğŸ‰ åŒæ­¥éªŒè¯é€šè¿‡"
                echo "å½“å‰æ¶æ„ï¼š$final_platforms"
              fi
            else
              echo "â© æ— éœ€åŒæ­¥"
              SYNC_SKIPPED=$((SYNC_SKIPPED+1))
            fi

            echo "â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬â–¬"
          done <<< "$SYNC_RULES"

          #======= æœ€ç»ˆæŠ¥å‘Š =======#
          total_rules=$(echo "$SYNC_RULES" | wc -l)
          success_rules=$(( SYNC_EXECUTED + SYNC_SKIPPED - ${#failed_rules[@]} ))
          
          echo "ğŸ“œ åŒæ­¥æŠ¥å‘Šæ€»ç»“ï¼š"
          echo "ğŸ”¢ è§„åˆ™æ€»æ•°           : $total_rules"
          echo "ğŸŸ¢ æˆåŠŸ/è·³è¿‡åŒæ­¥è§„åˆ™ : $success_rules ($SYNC_EXECUTED æ¬¡æ“ä½œ)"
          echo "ğŸ”´ å¤±è´¥è§„åˆ™         : ${#failed_rules[@]}"
          
          if ((${#failed_rules[@]} > 0)); then
            echo "âŒ å¤±è´¥è§„åˆ™åˆ—è¡¨ï¼š"
            printf "   â†’ %s\n" "${failed_rules[@]}"
            exit 1
          fi
