name: é•œåƒåŒæ­¥å·¥ä½œæµ

on:
  workflow_dispatch:
  schedule: 
    - cron: '0 2 * * *'

jobs:
  docker-sync:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: è§„åˆ™é¢„å¤„ç†
        id: setup
        run: |
          CLEANED_RULES=$(echo "${{ vars.SYNC_MAPPINGS }}" | 
            tr ',' '\n' |
            sed -E 's/[[:space:]]+//g; /^$/d' |
            sort -u
          )
          echo "SYNC_RULES<<EOF" >> $GITHUB_ENV
          echo "$CLEANED_RULES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "=== æœ‰æ•ˆé•œåƒ ($(echo "$CLEANED_RULES" | wc -l) æ¡) ==="
          echo "$CLEANED_RULES"

      - name: ç™»å½•DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: é…ç½®é«˜æ€§èƒ½æ„å»ºç¯å¢ƒ
        uses: docker/setup-buildx-action@v3
        id: buildx
        with:
          driver: docker-container
          driver-opts: |
            image=moby/buildkit:master
            network=host
          buildkitd-config-inline: |
            [registry."docker.io"]
              mirrors = ["dockerpull.cn"]
            [worker.oci]
              max-parallelism = 4

      - name: æ‰§è¡Œæ™ºèƒ½é•œåƒåŒæ­¥
        env:
          DOCKERHUB_USER: "${{ secrets.DOCKERHUB_USERNAME }}"
        run: |
          export BUILDKIT_PROGRESS=plain
          failed_rules=()
          SYNC_EXECUTED=0
          SYNC_SKIPPED=0

          # å¢å¼ºç‰ˆæ¶æ„æ£€æµ‹å‡½æ•°
          analyze_platforms() {
            local image=$1
            local output ret=0
            output=$(docker buildx imagetools inspect "$image" 2>&1) || ret=$?

            # å¤„ç†é•œåƒä¸å­˜åœ¨çš„æƒ…å†µ
            if [[ $ret -ne 0 ]]; then
              if [[ "$output" =~ "manifest unknown" || "$output" =~ "not found" ]]; then
                echo "NON_EXISTENT"
                return 1
              else
                echo "ERROR: $output" >&2
                return 2
              fi
            fi

            # ä¼˜åŒ–æ¶æ„æå–é€»è¾‘
            echo "$output" | awk '
              /^Platform:/ {
                split($0, parts, /: /)
                gsub(/, /, "\n", parts[2])
                gsub(/ /, "", parts[2])
                print parts[2]
              }' | sed '
                s/,/\n/g;
                /^unknown\/unknown$/d;
                s/^[[:space:]]*//;
                s/[[:space:]]*$//;
                /^$/d' | sort -u
          }

          # ç²¾ç¡®è®¡æ•°å‡½æ•°
          count_platforms() {
            echo "$1" | grep -v "NON_EXISTENT" | awk 'NF {count++} END {print count+0}'
          }

          while IFS= read -r rule; do
            [[ -z "$rule" ]] && continue
            echo "=== ğŸ› ï¸ å¤„ç†è§„åˆ™: $rule ==="

            #======= å‚æ•°è§£æ =======#
            src_image="${rule%%=*}"
            target_spec="${rule#*=}"
            target_spec="${target_spec/#docker.io\//}"

            # å¤„ç†æºé•œåƒæ ‡ç­¾
            if [[ "$src_image" == *":"* ]]; then
              src_tag="${src_image##*:}"
              src_name="${src_image%:*}"
            else
              src_tag="latest"
              src_name="$src_image"
            fi

            # å¤„ç†ç›®æ ‡æ ‡ç­¾
            if [[ "$target_spec" == *":"* ]]; then
              target_tag="${target_spec##*:}"
              target_base="${target_spec%:*}"
            else
              target_base="$target_spec"
              target_tag="$src_tag"
            fi

            # åˆæˆç›®æ ‡è§„æ ¼
            final_spec="$target_base"
            [[ "$final_spec" != */* ]] && final_spec="$DOCKERHUB_USER/$final_spec"
            final_spec+=":$target_tag"

            #======= æºé•œåƒåˆ†æ =======#
            echo "ğŸ” åˆ†ææºé•œåƒæ¶æ„..."
            src_platforms=$(analyze_platforms "$src_image" || true)
            if [[ "$src_platforms" == "NON_EXISTENT" ]]; then
              echo "âŒ æºé•œåƒä¸å­˜åœ¨: $src_image"
              failed_rules+=("$rule")
              continue
            fi
            src_count=$(count_platforms "$src_platforms")
            echo "ğŸ” æºé•œåƒæ¶æ„ ($src_count ç§)"
            echo "$src_platforms" | sed 's/^/  âœ /'
            (( src_count == 0 )) && { echo "âŒ æ— æ•ˆæºé•œåƒ"; failed_rules+=("$rule"); continue; }

            #======= ç›®æ ‡é•œåƒåˆ†æ =======#
            echo "âœ³ï¸ æœ€ç»ˆç›®æ ‡é•œåƒ: $final_spec"
            target_platforms=$(analyze_platforms "$final_spec" || true)
            
            if [[ "$target_platforms" == "NON_EXISTENT" ]]; then
              echo "ğŸ“¦ ç›®æ ‡é•œåƒä¸å­˜åœ¨"
              target_count=0
              target_platforms=""  # æ¸…ç©ºä¼ å‚
            else
              target_count=$(count_platforms "$target_platforms")
              echo "ğŸ“¦ ç›®æ ‡é•œåƒæ¶æ„ ($target_count ç§)"
              echo "$target_platforms" | sed 's/^/  âœ /'
            fi

            #======= åŒæ­¥ç­–ç•¥ =======#
            if (( target_count == 0 )); then
              echo "ğŸ†• åˆå§‹åŒ–é•œåƒ..."
              if ! timeout 300 docker buildx imagetools create -t "$final_spec" "$src_image"; then
                echo "âŒ åˆå§‹åŒ–å¤±è´¥"
                failed_rules+=("$rule")
                continue
              fi
              SYNC_EXECUTED=$((SYNC_EXECUTED+1))
            else
              missing_platforms=$(comm -23 <(echo "$src_platforms" | sort) <(echo "$target_platforms" | sort))
              missing_count=$(count_platforms "$missing_platforms")
              if (( missing_count > 0 )); then
                echo "ğŸ”„ å·®å¼‚æ¶æ„ ($missing_count ç§)"
                echo "$missing_platforms" | sed 's/^/  â¤ /'
                if ! timeout 300 docker buildx imagetools create -t "$final_spec" "$src_image" --append; then
                  echo "âš¡ å¢é‡åŒæ­¥å¤±è´¥ï¼Œå°è¯•è¦†ç›–æ¨¡å¼"
                  if ! timeout 300 docker buildx imagetools create -t "$final_spec" "$src_image" --force; then
                    echo "âŒ åŒæ­¥å½»åº•å¤±è´¥"
                    failed_rules+=("$rule")
                    continue
                  fi
                fi
                SYNC_EXECUTED=$((SYNC_EXECUTED+1))
              else
                echo "â­ï¸ å·²ä¿æŒæœ€æ–°"
                SYNC_SKIPPED=$((SYNC_SKIPPED+1))
              fi
            fi

            #======= éªŒè¯é˜¶æ®µ =======#
            echo "âœ… æœ€ç»ˆéªŒè¯..."
            final_platforms=$(analyze_platforms "$final_spec" || true)
            final_count=$(count_platforms "$final_platforms")
            missing_final=$(comm -23 <(echo "$src_platforms" | sort) <(echo "$final_platforms" | sort))
            
            if (( final_count < src_count )) || [[ -n "$missing_final" ]]; then
              echo "âŒ éªŒè¯å¤±è´¥ï¼ˆç¼ºå°‘$((src_count - final_count))ç§æ¶æ„ï¼‰"
              echo "$missing_final" | sed 's/^/  â–¸ /'
              failed_rules+=("$rule")
            else
              echo "âœ… éªŒè¯é€šè¿‡" 
              docker buildx imagetools inspect "$final_spec" | grep -E 'Platform:|Size:' | sed 's/^/  âœ¨ /'
            fi
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
          done <<< "$SYNC_RULES"

          #======= æŠ¥å‘Šç”Ÿæˆ =======#
          total_rules=$(count_platforms "$SYNC_RULES")
          success_rules=$((SYNC_EXECUTED + SYNC_SKIPPED))
          echo "ğŸ“Š=== åŒæ­¥æŠ¥å‘Š ==="
          echo "ğŸ”¢ å¤„ç†æ€»æ•° | $total_rules"
          echo "ğŸŸ¢ æˆåŠŸåŒæ­¥ | $SYNC_EXECUTED"
          echo "ğŸŸ¡ è·³è¿‡åŒæ­¥ | $SYNC_SKIPPED"
          echo "ğŸ”´ åŒæ­¥å¤±è´¥ | $((total_rules - success_rules))"
          
          if (( ${#failed_rules[@]} > 0 )); then
            echo "ğŸ”¥ å¤±è´¥è¯¦æƒ…ï¼š"
            printf "  â€¼ï¸ %s\n" "${failed_rules[@]}"
            exit 1
          fi
