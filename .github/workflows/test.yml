name: é•œåƒåŒæ­¥å·¥ä½œæµ

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:  # å®šæ—¶ä»»åŠ¡
    - cron: '0 2 * * *'  # æ¯æ—¥UTC 2ç‚¹æ‰§è¡Œ

jobs:
  docker-sync:
    runs-on: ubuntu-latest  # è¿è¡Œç¯å¢ƒ
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4

    - name: è§„åˆ™é¢„å¤„ç†
      id: setup
      run: |
        # æ¸…ç†è¾“å…¥è§„åˆ™ï¼ˆä¼˜åŒ–ç©ºæ ¼å¤„ç†ï¼‰
        CLEANED_RULES=$(echo "${{ vars.SYNC_MAPPINGS }}" |
          tr '\n' ',' |  # æ¢è¡Œè½¬é€—å·
          sed -E 's/[[:space:]]+//g; s/,+/ /g; s/^ | $//g' |  # åˆå¹¶å†—ä½™ç©ºæ ¼å’Œé€—å·
          tr ' ' '\n' |  # ç©ºæ ¼è½¬å›è½¦
          grep -v '^$'  # è¿‡æ»¤ç©ºè¡Œ
        )
        
        # å°†å¤„ç†åçš„è§„åˆ™å­˜å…¥ç¯å¢ƒå˜é‡
        echo "SYNC_RULES<<EOF" >> $GITHUB_ENV
        echo "$CLEANED_RULES" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV
        
        # è¾“å‡ºè°ƒè¯•ä¿¡æ¯
        echo "=== æœ‰æ•ˆåŒæ­¥è§„åˆ™ ==="
        echo "$CLEANED_RULES"

    - name: ç™»å½•DockerHub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: é…ç½®æ„å»ºç¯å¢ƒ
      uses: docker/setup-buildx-action@v3

    - name: æ‰§è¡Œé•œåƒå¤„ç†
      env:
        DOCKERHUB_USER: "${{ secrets.DOCKERHUB_USERNAME }}"
      run: |
        IFS=$'\n'  # è®¾ç½®å­—æ®µåˆ†å‰²ç¬¦
        for rule in $SYNC_RULES; do
          [[ -z "$rule" ]] && continue
          echo "=== æ­£åœ¨å¤„ç†è§„åˆ™: $rule ==="
          
          # åˆ†è§£åŸå§‹è§„åˆ™ï¼ˆå…¼å®¹SHA256æ ¼å¼ï¼‰
          if ! IFS="=" read -r src_image target_part <<< "${rule// /}"; then
            echo "âš ï¸ æ ¼å¼é”™è¯¯ï¼š$ruleï¼Œå·²è·³è¿‡"
            continue
          fi
          
          # è§£æé•œåƒæ ‡ç­¾å’Œç›®æ ‡ä»“åº“
          if [[ "$target_part" == *":"* ]]; then
            target_tag="${target_part##*:}"  # æˆªå–æ ‡ç­¾éƒ¨åˆ†
            repo_part="${target_part%:*}"    # ä¿ç•™ä»“åº“éƒ¨åˆ†
          else
            target_tag="latest"  # é»˜è®¤æœ€æ–°æ ‡ç­¾
            repo_part="$target_part"
          fi
          
          # å¤„ç†ç”¨æˆ·å‘½åç©ºé—´
          if [[ "$repo_part" == *"/"* ]]; then
            target_user="${repo_part%%/*}"   # æå–ç›®æ ‡ç”¨æˆ·
            target_image="${repo_part#*/}"   # æå–é•œåƒåç§°
            # æ ¡éªŒç”¨æˆ·åæ ¼å¼
            if [[ ! "$target_user" =~ ^[a-z0-9]+([._-][a-z0-9]+)*$ ]]; then
              echo "âŒ éæ³•ç”¨æˆ·å: $target_user"
              continue
            fi
          else
            target_user="$DOCKERHUB_USER"  # ä½¿ç”¨é»˜è®¤ç”¨æˆ·
            target_image="$repo_part"
          fi
          
          final_target="${target_user}/${target_image}:${target_tag}"
          # é•œåƒåœ°å€åˆæ³•æ€§éªŒè¯ï¼ˆæ”¯æŒåŒ…å«SHAï¼‰
          if ! [[ "$final_target" =~ ^([a-z0-9]+([._-][a-z0-9]+)*/)?[a-z0-9]+([._-][a-z0-9]+)*:[a-zA-Z0-9_.-]+$ ]]; then
            echo "âŒ éæ³•é•œåƒåœ°å€: $final_target"
            continue
          fi
          
          echo "â–· æºé•œåƒ: $src_image"
          echo "â—· ç›®æ ‡é•œåƒ: $final_target"
          echo "ğŸ”„ å¼€å§‹åŒæ­¥æ“ä½œ..."
          
          # éªŒè¯æºé•œåƒå¯è®¿é—®æ€§
          if ! docker buildx imagetools inspect "$src_image" >/dev/null 2>&1; then
            echo "âŒ æºé•œåƒä¸å¯è®¿é—®: $src_image"
            echo "å°è¯•ä½¿ç”¨ library/$src_image..."
            if ! docker buildx imagetools inspect "library/$src_image" >/dev/null 2>&1; then
              echo "âŒ é•œåƒä»ç„¶ä¸å¯è®¿é—®: library/$src_image"
              continue
            else
              src_image="library/$src_image"
            fi
          fi
          
          # æ‰§è¡Œå¤šæ¶æ„é•œåƒåŒæ­¥
          echo "ğŸš€ æ­£åœ¨åŒæ­¥å¤šå¹³å°é•œåƒ..."
          if docker buildx imagetools create -t "$final_target" "$src_image" >/dev/null 2>&1; then
            echo "âœ… åŒæ­¥æˆåŠŸ"
            echo "é•œåƒè¯¦ç»†ä¿¡æ¯ï¼š"
            docker buildx imagetools inspect "$final_target"
          else
            echo "âŒ åŒæ­¥å¤±è´¥ï¼Œé”™è¯¯è¯¦æƒ…ï¼š"
            # æ˜¾ç¤ºå®Œæ•´é”™è¯¯è¾“å‡º
            docker buildx imagetools create -t "$final_target" "$src_image"
          fi
          echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"    
        done
